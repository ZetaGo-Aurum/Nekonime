
<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NekoNime v10.0.8 - Final Fixes & Stability! ♡</title>
    <meta name="description"
        content="NekoNime dengan fitur sosial lengkap! Like, Komen, Share, Edit, dan Hapus Postingan. Kompresi gambar, Neko Token, Profil Pengguna. Ayo gabung! 💖">

    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Inline Styles -->
    <style>
        /* --- Root Variables (Color Palette, Layout, Z-Index) --- */
        :root {
            --bg-dark-1: #0a0510;
            --bg-dark-2: #110b1a;
            --bg-dark-3: #1a112a;
            --glass-bg: rgba(20, 12, 31, 0.85);
            --glass-border: rgba(255, 255, 255, 0.08);
            --card-bg: rgba(26, 17, 42, 0.65);
            --text-primary: #f0f1f5;
            --text-secondary: #a8b2cc;
            --text-uwu: #f9a8d4;
            --text-placeholder: #626a7f;
            --accent-magenta: #ec4899;
            --accent-pink: #f472b6;
            --accent-red: #ef4444;
            --accent-purple: #a855f7;
            --accent-blue: #60a5fa;
            --accent-yellow: #facc15;
            --accent-green: #4ade80;

            /* Gradients */
            --accent-gradient: linear-gradient(115deg, var(--accent-purple), var(--accent-magenta) 55%, var(--accent-red) 100%);
            --accent-gradient-hover: linear-gradient(115deg, var(--accent-purple), var(--accent-pink) 55%, var(--accent-red) 100%);
            --green-gradient: linear-gradient(115deg, #22c55e, #4ade80);
            --gacha-card-gradient: linear-gradient(140deg, var(--accent-purple) 10%, var(--accent-magenta) 60%, var(--accent-pink) 95%);

            /* Layout & Z-Index */
            --mobile-header-height: 3.75rem;
            /* 60px */
            --toast-z-index: 150;
            --modal-z-index: 130;
            --mobile-nav-z-index: 120;
            --lightbox-z-index: 110;
            --mobile-header-z-index: 100;
            --gacha-anim-z-index: 15;
            --gacha-result-z-index: 10;
            --gacha-placeholder-z-index: 5;
            --gacha-error-z-index: 20;
        }

        /* --- Base Styles --- */
        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(150deg, var(--bg-dark-1), var(--bg-dark-2) 45%, var(--bg-dark-3) 90%);
            background-attachment: fixed;
            color: var(--text-primary);
            overscroll-behavior: none;
            margin: 0;
            padding: 0;
        }

        .glassmorphism {
            background: var(--glass-bg);
            backdrop-filter: blur(18px) saturate(190%);
            -webkit-backdrop-filter: blur(18px) saturate(190%);
            border-bottom: 1px solid var(--glass-border);
            box-shadow: 0 7px 45px rgba(0, 0, 0, 0.4);
        }

        .uwu-text {
            color: var(--text-uwu);
            font-style: italic;
        }

        /* --- Image Card Styles --- */
        .image-card {
            display: inline-block;
            width: 100%;
            margin-bottom: 1rem;
            break-inside: avoid;
            cursor: pointer;
            border-radius: 0.85rem;
            background-color: var(--card-bg);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }

        .image-card img {
            border-radius: 0.8rem;
            display: block;
            width: 100%;
            height: auto;
            background-color: var(--bg-dark-3);
            object-fit: cover;
            min-height: 100px;
        }

        .image-card:hover {
            transform: scale(1.02) rotate(-0.5deg);
            box-shadow: 0 8px 35px rgba(236, 72, 153, 0.3);
            z-index: 10;
        }

        .card-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.85) 0%, rgba(0, 0, 0, 0) 100%);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
            display: flex;
            align-items: flex-end;
            padding: 0.6rem;
            box-sizing: border-box;
        }

        .image-card:hover .card-overlay {
            opacity: 1;
            pointer-events: auto;
        }

        .card-button {
            background-color: rgba(20, 12, 31, 0.6);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            border-radius: 999px;
            padding: 0.4rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 15;
            pointer-events: auto;
            cursor: pointer;
        }

        .card-button i {
            width: 1.1rem;
            height: 1.1rem;
        }

        .card-button:hover {
            background-color: rgba(20, 12, 31, 0.8);
            transform: scale(1.05);
        }

        .add-to-collection-card-btn {
            margin-right: auto;
        }

        .add-to-collection-card-btn:hover {
            color: var(--accent-blue);
        }

        .favorite-btn:hover {
            color: var(--accent-red);
        }

        .add-to-collection-card-btn.in-collection {
            background: var(--green-gradient);
            color: white;
            box-shadow: 0 2px 8px rgba(74, 222, 128, 0.4);
            border-color: transparent;
        }

        .add-to-collection-card-btn.in-collection:hover {
            background: var(--green-gradient);
            transform: scale(1.05);
        }

        .favorite-btn.active {
            background: var(--accent-red);
            color: white;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
            border-color: transparent;
        }

        .favorite-btn.active:hover {
            background: var(--accent-red);
            transform: scale(1.05);
        }

        .favorite-btn.active i {
            fill: currentColor;
        }

        /* --- Remove Item Button --- */
        .remove-item-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: rgba(0, 0, 0, 0.5);
            color: rgba(255, 255, 255, 0.7);
            border: none;
            border-radius: 50%;
            padding: 0.25rem;
            line-height: 0;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 15;
            opacity: 0;
            pointer-events: none;
        }

        .image-card:hover .remove-item-btn {
            opacity: 1;
            pointer-events: auto;
        }

        .remove-item-btn:hover {
            background: var(--accent-red);
            color: white;
            transform: scale(1.1);
        }

        .remove-item-btn i {
            width: 0.8rem;
            height: 0.8rem;
            display: block;
        }

        /* --- Navigation Styles --- */
        .nav-link {
            position: relative;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
            border-radius: 0.75rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }

        .nav-link:not(.active):hover {
            background-color: rgba(255, 255, 255, 0.08);
            color: white;
            transform: translateY(-2px);
        }

        .nav-link.active {
            background: var(--accent-gradient);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4);
            transform: translateY(-1px) scale(1.03);
        }

        .nav-link.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        #desktop-nav .nav-link {
            padding: 0.6rem;
        }

        #desktop-nav .nav-link.active {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(236, 72, 153, 0.3);
        }

        #desktop-nav .nav-link:not(.active):hover {
            transform: scale(1.1) translateY(-1px);
        }

        #mobile-nav-main-links .nav-link {
            justify-content: center;
            padding: 0.75rem 1.25rem;
            width: 100%;
        }

        #mobile-nav-main-links .nav-link.active {
            transform: scale(1.02);
        }

        /* Auth Container & Token Display Styles */
        .auth-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-left: auto;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: rgba(255, 255, 255, 0.05);
            padding: 0.25rem 0.6rem 0.25rem 0.25rem;
            border-radius: 99px;
            border: 1px solid var(--glass-border);
            cursor: pointer;
            transition: background-color .2s;
        }

        .user-profile:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .user-profile img {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            border: 2px solid var(--accent-pink);
        }

        .user-profile span {
            font-size: 0.8rem;
            font-weight: 500;
            display: none;
        }

        @media (min-width: 1280px) {
            .user-profile span {
                display: block;
            }
        }

        #logout-btn {
            padding: 0.6rem;
        }

        #logout-btn:hover {
            background-color: var(--accent-red);
            color: white;
        }

        .login-btn {
            padding: 0.5rem 1rem !important;
            gap: 0.5rem;
            font-weight: 500;
            background: var(--accent-gradient);
        }

        .login-btn:hover {
            background: var(--accent-gradient-hover);
            transform: translateY(-1px);
        }

        #neko-token-display {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            background-color: rgba(250, 204, 21, 0.1);
            border: 1px solid rgba(250, 204, 21, 0.3);
            padding: 0.25rem 0.6rem;
            border-radius: 99px;
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--accent-yellow);
            cursor: help;
        }

        #neko-token-display.animate-gain {
            animation: tokenGain 0.5s ease-out;
        }

        @keyframes tokenGain {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2) rotate(-5deg);
                color: var(--accent-green);
            }

            100% {
                transform: scale(1);
            }
        }

        #auth-container-mobile {
            width: 100%;
            border-top: 1px solid var(--glass-border);
            padding-top: 1.25rem;
        }

        #auth-container-mobile .login-btn {
            width: 100%;
            justify-content: center;
            padding: 0.75rem 1rem !important;
        }

        #mobile-user-profile {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }

        #mobile-user-profile img {
            width: 4rem;
            height: 4rem;
            border-radius: 50%;
            border: 3px solid var(--accent-pink);
        }

        #mobile-user-profile span {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        #mobile-logout-btn {
            background-color: rgba(239, 68, 68, 0.2);
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
            padding: 0.6rem 1rem;
            width: 100%;
            justify-content: center;
            margin-top: 0.5rem;
        }

        /* --- General Tab Styles --- */
        .tabs-container {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 0.75rem;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 0.5rem 1.5rem;
            border-radius: 999px;
            font-weight: 500;
            transition: all 0.2s ease;
            color: var(--text-secondary);
            border: 1px solid transparent;
            cursor: pointer;
        }

        .tab-btn:hover {
            color: var(--text-primary);
            background-color: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .tab-btn.active {
            color: white;
            background: var(--accent-gradient);
            box-shadow: 0 2px 8px rgba(236, 72, 153, 0.25);
            border-color: transparent;
        }

        /* --- Layout & Grid --- */
        .masonry-grid {
            column-count: 2;
            column-gap: 1rem;
        }

        @media (min-width: 640px) {
            .masonry-grid {
                column-count: 3;
            }
        }

        @media (min-width: 768px) {
            .masonry-grid {
                column-count: 4;
            }
        }

        @media (min-width: 1024px) {
            #main-header {
                justify-content: flex-start;
                padding: 0.5rem 1.5rem;
            }

            #desktop-nav {
                display: flex;
                gap: 0.5rem;
            }

            #header-title {
                margin-right: 1.5rem;
            }

            #mobile-menu-toggle {
                display: none;
                margin-left: auto;
            }
        }

        @media (max-width: 1023px) {
            #desktop-nav {
                display: none;
            }

            #main-header {
                justify-content: space-between;
            }
        }

        @media (min-width: 1024px) {
            .masonry-grid {
                column-count: 4;
            }
        }

        @media (min-width: 1280px) {
            .masonry-grid {
                column-count: 5;
            }
        }

        /* --- Loaders & Spinners --- */
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.15);
            border-radius: 50%;
            border-top-color: var(--accent-magenta);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Initial App Loader */
        #initial-loader {
            position: fixed;
            inset: 0;
            background-color: var(--bg-dark-1);
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        }

        #initial-loader.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* --- App Structure (FIXED HEADER + SCROLL FIX) --- */
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            visibility: hidden;
            /* Initially hidden until JS confirms auth state */
        }

        #main-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: var(--mobile-header-z-index);
            padding: 0.5rem 1rem;
            height: var(--mobile-header-height);
            display: flex;
            align-items: center;
        }

        #content-wrapper {
            flex-grow: 1;
            overflow: hidden;
            display: block;
        }

        #main-content-area {
            overflow-y: auto;
            height: 100%;
            padding: 1rem;
            padding-top: calc(var(--mobile-header-height) + 1rem);
            position: relative;
        }

        @media (min-width: 1024px) {
            #main-content-area {
                padding: 1.5rem;
                padding-top: calc(var(--mobile-header-height) + 1.5rem);
            }
        }

        /* --- Mobile Navigation Overlay --- */
        #mobile-nav-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(10, 5, 15, 0.88);
            backdrop-filter: blur(16px) saturate(150%);
            z-index: var(--mobile-nav-z-index);
            display: flex;
            align-items: center;
            overflow-y: auto;
            padding: 3rem 1rem;
            box-sizing: border-box;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease, visibility 0s linear 0.4s;
            perspective: 1000px;
        }

        #mobile-nav-overlay.visible {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.4s ease, visibility 0s linear 0s;
        }

        #mobile-nav-links {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 1.25rem;
            padding: 2.5rem;
            width: 100%;
            max-width: 360px;
            border-radius: 1.75rem;
            transform: translateY(20px) scale(0.9);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease;
            opacity: 0;
            border-top: 3px solid;
            border-image-slice: 1;
            border-image-source: linear-gradient(to left, var(--accent-purple), var(--accent-magenta));
            margin: auto;
        }

        #mobile-nav-main-links {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        #mobile-nav-overlay.visible #mobile-nav-links {
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        /* --- Category Buttons --- */
        .category-btn {
            padding: 0.5rem 1rem;
            border-radius: 999px;
            font-size: 0.875rem;
            font-weight: 500;
            background-color: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .category-btn:hover {
            background-color: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
            transform: translateY(-2px);
        }

        .category-btn.active {
            background: var(--accent-gradient);
            color: white;
            border-color: transparent;
            box-shadow: 0 3px 10px rgba(236, 72, 153, 0.3);
        }

        /* --- Load More Button (ALWAYS VISIBLE, STATE CHANGES) --- */
        #load-more-container {
            text-align: center;
            margin-top: 2rem;
            padding-bottom: 1.5rem;
            min-height: 70px;
        }

        #load-more-btn {
            padding: 0.75rem 2rem;
            background: var(--accent-gradient);
            color: white;
            font-weight: 600;
            border-radius: 999px;
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.25);
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            border: none;
            cursor: pointer;
        }

        #load-more-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(236, 72, 153, 0.35);
            background: var(--accent-gradient-hover);
        }

        #load-more-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: var(--glass-bg);
            box-shadow: none;
            transform: none;
        }

        #load-more-spinner {
            display: none;
            width: 1.25rem;
            height: 1.25rem;
            border-width: 2px;
            margin: 0;
        }

        #load-more-btn.loading #load-more-spinner {
            display: inline-block;
        }

        #load-more-btn.loading #load-more-btn-text {
            display: none;
        }

        #load-more-btn.loading #load-more-spinner-text {
            display: inline;
        }

        #load-more-btn:not(.loading) #load-more-spinner {
            display: none;
        }

        #load-more-btn:not(.loading) #load-more-spinner-text {
            display: none;
        }

        #load-more-btn:not(.loading) #load-more-btn-text {
            display: inline;
        }

        /* --- Lightbox Modal --- */
        #lightbox-modal {
            position: fixed;
            inset: 0;
            background-color: rgba(10, 5, 15, 0.92);
            backdrop-filter: blur(10px);
            z-index: var(--lightbox-z-index);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0s linear 0.3s;
            cursor: pointer;
        }

        #lightbox-modal.visible {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s ease, visibility 0s linear 0s;
        }

        #lightbox-content {
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: default;
        }

        #lightbox-image {
            max-width: 100%;
            max-height: calc(90vh - 130px);
            object-fit: contain;
            border-radius: 0.75rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            background-color: rgba(0, 0, 0, 0.2);
        }

        #lightbox-details {
            background-color: rgba(0, 0, 0, 0.65);
            padding: 0.6rem 1.2rem;
            border-radius: 0.75rem;
            text-align: center;
            color: var(--text-secondary);
            max-width: 85%;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
        }

        #lightbox-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            margin-top: 0.5rem;
        }

        #lightbox-favorite-btn,
        #lightbox-add-collection-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 99px;
            font-size: 0.8rem;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            cursor: pointer;
        }

        #lightbox-favorite-btn:hover,
        #lightbox-add-collection-btn:hover {
            background: rgba(255, 255, 255, 0.18);
            transform: scale(1.03);
        }

        #lightbox-favorite-btn.active {
            background: var(--accent-red);
            color: white;
            border-color: transparent;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
        }

        #lightbox-favorite-btn.active i {
            fill: currentColor;
        }

        #lightbox-add-collection-btn.in-collection {
            background: var(--green-gradient);
            color: white;
            border-color: transparent;
            box-shadow: 0 2px 8px rgba(74, 222, 128, 0.4);
        }

        #lightbox-add-collection-btn.in-collection i {
            color: white;
        }

        #lightbox-artist {
            font-weight: 500;
            color: var(--text-primary);
        }

        #lightbox-source {
            color: var(--accent-blue);
            text-decoration: none;
            margin-left: 0.5rem;
        }

        #lightbox-source:hover {
            text-decoration: underline;
        }

        #close-lightbox-btn {
            position: absolute;
            top: -15px;
            right: -15px;
            background: var(--accent-red);
            color: white;
            border: none;
            border-radius: 50%;
            padding: 0.5rem;
            line-height: 0;
            cursor: pointer;
            transition: transform 0.2s ease;
            z-index: calc(var(--lightbox-z-index) + 1);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
        }

        #close-lightbox-btn:hover {
            transform: scale(1.1) rotate(90deg);
        }

        /* --- Gacha Section Specifics --- */
        #gacha-result-container {
            position: relative;
            width: 100%;
            min-height: 50vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #gacha-image-wrapper {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: opacity 0.5s ease-in-out;
            z-index: var(--gacha-result-z-index);
            position: absolute;
            inset: 0;
            padding: 1rem;
            box-sizing: border-box;
        }

        #gacha-result-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 0.75rem;
            display: block;
            background-color: rgba(0, 0, 0, 0.1);
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
        }

        #gacha-image-wrapper.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #gacha-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-placeholder);
            z-index: var(--gacha-placeholder-z-index);
            text-align: center;
            transition: opacity 0.3s ease;
        }

        #gacha-placeholder.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #gacha-error {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            right: 1rem;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            color: var(--accent-red);
            z-index: var(--gacha-error-z-index);
            font-weight: 500;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0s linear 0.3s;
        }

        #gacha-error.visible {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s ease, visibility 0s linear 0s;
        }

        #gacha-actions {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        #gacha-reset-button {
            padding: 0.6rem 1.2rem;
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 999px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        #gacha-reset-button:hover {
            background-color: rgba(255, 255, 255, 0.18);
            color: var(--text-primary);
            transform: scale(1.03);
        }

        #gacha-reset-button i {
            width: 1rem;
            height: 1rem;
        }

        #gacha-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: var(--glass-bg) !important;
            box-shadow: none;
            transform: none;
        }

        #gacha-button .gacha-cost {
            font-size: 0.7rem;
            font-weight: 400;
            opacity: 0.8;
        }

        /* --- Enhanced Gacha Card Animation --- */
        #gacha-animation-container {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            perspective: 1000px;
            z-index: var(--gacha-anim-z-index);
            overflow: hidden;
            pointer-events: none;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0s linear 0.3s;
        }

        #gacha-animation-container.visible {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s ease, visibility 0s linear 0s;
        }

        .gacha-spinner-card {
            width: 70px;
            height: 105px;
            background: var(--gacha-card-gradient);
            border-radius: 10px;
            margin: 0 8px;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.35);
            border: 1px solid rgba(255, 255, 255, 0.1);
            opacity: 0;
            transform: translateY(150px) rotateY(180deg) scale(0.5);
            animation: gachaSpin 1.8s cubic-bezier(0.68, -0.6, 0.32, 1.6) forwards;
            position: relative;
            overflow: hidden;
        }

        .gacha-spinner-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -80%;
            width: 60%;
            height: 100%;
            background: linear-gradient(to right, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.35) 50%, rgba(255, 255, 255, 0) 100%);
            transform: skewX(-25deg);
            animation: shine 1.8s cubic-bezier(0.68, -0.6, 0.32, 1.6) forwards;
            animation-delay: inherit;
        }

        @keyframes gachaSpin {
            0% {
                transform: translateY(150px) rotateY(180deg) scale(0.5);
                opacity: 0;
            }

            40% {
                transform: translateY(-20px) rotateY(0deg) scale(1.1);
                opacity: 1;
            }

            60% {
                transform: translateY(5px) rotateY(0deg) scale(0.95);
                opacity: 1;
            }

            80% {
                transform: translateY(0) rotateY(0deg) scale(1);
                opacity: 1;
            }

            100% {
                transform: translateY(-180px) rotateY(-180deg) scale(0.4);
                opacity: 0;
            }
        }

        @keyframes shine {
            0% {
                left: -80%;
            }

            40% {
                left: 120%;
            }

            100% {
                left: 120%;
            }
        }

        /* --- Profile Page Styles --- */
        .profile-card {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--glass-border);
            border-radius: 1rem;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .profile-card img {
            width: 6rem;
            height: 6rem;
            border-radius: 50%;
            border: 4px solid var(--accent-pink);
        }

        .profile-username {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .profile-email {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .profile-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            width: 100%;
            margin-top: 1rem;
        }

        .stat-item {
            background: var(--bg-dark-3);
            padding: 1rem;
            border-radius: 0.75rem;
            text-align: center;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--accent-purple);
            line-height: 1.2;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        /* --- Social Page Styles --- */
        .social-post-card {
            background: var(--card-bg);
            border-radius: 1rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--glass-border);
            overflow: hidden;
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            position: relative; /* For options button positioning */
        }

        .post-author-img {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            border: 2px solid var(--accent-pink);
        }

        .post-author-name {
            font-weight: 600;
        }
        
        .post-author-info {
             display: flex;
             flex-direction: column;
             margin-right: auto;
        }

        .post-timestamp {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .post-options-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 50%;
            transition: background-color 0.2s;
            line-height: 0;
            margin-left: auto;
        }
        
        .post-options-btn:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .post-caption {
            padding: 0 1rem 1rem;
            line-height: 1.6;
            word-break: break-word;
        }

        .post-image {
            max-height: 70vh;
            width: 100%;
            object-fit: contain;
            background: var(--bg-dark-1);
            cursor: pointer;
        }

        .post-actions {
            display: flex;
            justify-content: space-around;
            padding: 0.5rem;
            border-top: 1px solid var(--glass-border);
        }

        .post-action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 0.5rem;
            border-radius: 99px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .post-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .post-action-btn.liked {
            color: var(--accent-red);
            font-weight: 600;
        }

        .post-action-btn.liked i {
            fill: currentColor;
        }

        /* Improved Upload Form Styles */
        .upload-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--glass-border);
            border-radius: 1rem;
            padding: 1.5rem;
        }

        .upload-form textarea,
        .upload-form select {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .upload-form textarea::placeholder {
            color: var(--text-placeholder);
        }

        .upload-form textarea:focus,
        .upload-form select:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--accent-magenta);
        }

        .upload-form textarea {
            min-height: 80px;
        }

        .file-upload-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed var(--glass-border);
            border-radius: 0.75rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-upload-label:hover {
            border-color: var(--accent-purple);
            background: rgba(168, 85, 247, 0.1);
        }

        #image-preview-container {
            margin-top: 1rem;
        }

        #image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 0.5rem;
            object-fit: cover;
        }

        /* Improved Chat Layout Styles */
        #chat-container {
            display: flex;
            flex-direction: column;
            height: 70vh;
            /* Defined height */
            max-height: 600px;
            /* Max height for large screens */
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--glass-border);
            border-radius: 1rem;
            overflow: hidden;
            /* This is crucial */
        }

        #chat-messages {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse;
            /* To keep scroll at bottom */
        }

        #chat-form {
            display: flex;
            align-items: center; /* Align items for better look */
            border-top: 1px solid var(--glass-border);
            padding: 0.75rem; /* Adjusted padding */
            gap: 0.75rem; /* Adjusted gap */
            flex-shrink: 0;
        }

        #chat-input {
             flex-grow: 1;
             padding: 0.75rem 1rem;
             border-radius: 99px; /* Pill shape input */
             background: rgba(0, 0, 0, 0.3);
             border: 1px solid rgba(255, 255, 255, 0.1);
             color: var(--text-primary);
        }

         #chat-input::placeholder {
            color: var(--text-placeholder);
        }

        #chat-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--accent-magenta);
        }
        
        #chat-send-btn {
            flex-shrink: 0; /* Prevent button from shrinking */
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2.5rem;
            height: 2.5rem;
            padding: 0 !important; /* Override other padding */
            border-radius: 50% !important; /* Make it a circle */
        }

        .chat-message-item {
            max-width: 80%;
            margin-bottom: 0.75rem;
            display: flex;
            flex-direction: column;
        }

        .chat-message-item.sent {
            align-self: flex-end;
            align-items: flex-end;
        }

        .chat-message-item.received {
            align-self: flex-start;
            align-items: flex-start;
        }

        .chat-author {
            font-size: 0.75rem;
            color: var(--accent-pink);
            font-weight: 500;
            margin-bottom: 0.25rem;
            padding: 0 0.5rem;
        }

        .chat-bubble {
            padding: 0.6rem 1rem;
            border-radius: 1rem;
            line-height: 1.5;
            word-break: break-word;
        }

        .chat-message-item.sent .chat-bubble {
            background: var(--accent-purple);
            color: white;
            border-bottom-right-radius: 0.25rem;
        }

        .chat-message-item.received .chat-bubble {
            background: var(--bg-dark-3);
            border-bottom-left-radius: 0.25rem;
        }
        
        /* Styles for Collection Page List */
        .collection-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background-color: rgba(255, 255, 255, 0.04);
            border: 1px solid var(--glass-border);
            border-radius: 0.75rem;
            transition: background-color 0.2s, border-color 0.2s;
        }
        
        .collection-list-item:hover {
            background-color: rgba(168, 85, 247, 0.1);
            border-color: var(--accent-purple);
        }

        .collection-name-wrapper {
             cursor: pointer;
             flex-grow: 1;
             font-weight: 500;
        }

        .collection-count {
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-left: 1rem;
            flex-shrink: 0;
        }

        .collection-delete-btn {
            color: var(--text-secondary);
            padding: 0.25rem;
            border-radius: 50%;
            margin-left: 1rem;
            transition: all 0.2s;
            flex-shrink: 0;
            line-height: 0;
        }

        .collection-delete-btn:hover {
            color: var(--accent-red);
            background-color: rgba(239, 68, 68, 0.2);
        }

        .collection-delete-btn i {
            width: 1.1rem;
            height: 1.1rem;
        }
        
        /* Styles for Add-to-Collection Modal List */
        #add-to-collection-modal-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 250px;
            overflow-y: auto;
            padding-right: 0.5rem; /* for scrollbar */
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        .add-to-collection-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--glass-border);
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
            text-align: left;
            background: none;
            color: var(--text-primary);
            font-weight: 500;
        }

        .add-to-collection-item:hover {
            background-color: rgba(168, 85, 247, 0.1);
            border-color: var(--accent-purple);
        }

        .add-to-collection-item.exists {
            background-color: rgba(74, 222, 128, 0.1);
            border-color: var(--accent-green);
            color: var(--accent-green);
            cursor: not-allowed;
        }

        .add-to-collection-item .check-icon { 
            color: var(--accent-green); 
            flex-shrink: 0;
            margin-left: 0.5rem;
        }


        /* --- Settings Page Styles --- */
        .settings-data-group {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--glass-border);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .settings-data-group h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .settings-data-group label,
        .settings-data-group p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .settings-data-group .text-xs {
            font-size: 0.75rem;
            margin-top: 0.5rem;
        }

        .settings-data-action {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--glass-border);
        }

        .settings-data-action:last-of-type {
            border-bottom: none;
        }

        .settings-data-action span {
            font-weight: 500;
            color: var(--text-primary);
        }

        .clear-button {
            background-color: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 0.3rem 0.8rem;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .clear-button:hover {
            background-color: var(--accent-red);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 2px 10px rgba(239, 68, 68, 0.4);
        }

        #clear-all-data-btn {
            background: linear-gradient(115deg, #b91c1c, #ef4444);
            color: white;
            font-weight: 600;
            padding: 0.6rem 1.5rem;
            border-radius: 999px;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        #clear-all-data-btn:hover {
            transform: scale(1.03);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }
        
        /* --- Other Specifics --- */
        .history-empty {
            font-style: italic;
        }

        #gallery-error {
            color: var(--accent-pink);
            font-weight: 500;
        }

        /* --- Custom Modal & Toast --- */
        .custom-modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(10, 5, 15, 0.85);
            backdrop-filter: blur(8px);
            z-index: var(--modal-z-index);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0s linear 0.3s;
        }

        .custom-modal-overlay.visible {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s ease, visibility 0s linear 0s;
        }

        .custom-modal-content {
            background: var(--bg-dark-2);
            border: 1px solid var(--glass-border);
            padding: 1.5rem;
            border-radius: 1.2rem;
            max-width: 90vw;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
            text-align: center;
            transform: scale(0.95);
            transition: transform 0.3s ease;
            border-image: linear-gradient(to bottom right, var(--accent-purple), var(--accent-magenta)) 1;
            word-wrap: break-word;
            position: relative;
        }

        .custom-modal-overlay.visible .custom-modal-content {
            transform: scale(1);
        }

        /* --- Comment Modal Layout --- */
        #comment-modal.custom-modal-overlay {
            padding: 0;
        }
        #comment-modal .custom-modal-content {
            width: 100%;
            height: 100%;
            max-width: 100vw;
            max-height: 100vh;
            border-radius: 0;
            border-image: none;
            border: none;
            padding: 1.5rem 1rem;
            text-align: left;
            display: flex;
            flex-direction: column;
        }
        @media (min-width: 640px) {
            #comment-modal.custom-modal-overlay {
                padding: 1rem;
            }
            #comment-modal .custom-modal-content {
                width: 100%;
                height: auto;
                max-width: 640px;
                max-height: 90vh;
                border-radius: 1.2rem;
                padding: 1.5rem;
                border: 1px solid var(--glass-border);
                border-image: linear-gradient(to bottom right, var(--accent-purple), var(--accent-magenta)) 1;
            }
        }

        #comment-list {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 0.5rem;
            margin: 1rem 0;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .comment-item {
            display: flex;
            gap: 0.75rem;
        }
        .comment-author-img {
            width: 2.25rem;
            height: 2.25rem;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .comment-content .author {
            font-weight: 600;
            font-size: 0.9rem;
        }
         .comment-content .timestamp {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-left: 0.5rem;
        }
        .comment-content .text {
            font-size: 0.95rem;
            color: var(--text-primary);
            line-height: 1.5;
            word-break: break-word;
        }
        #comment-form {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            border-top: 1px solid var(--glass-border);
            padding-top: 1rem;
            align-items: center;
        }
        #comment-input {
             flex-grow: 1;
             padding: 0.6rem 1rem;
             border-radius: 99px;
             background: rgba(0, 0, 0, 0.3);
             border: 1px solid rgba(255, 255, 255, 0.1);
             color: var(--text-primary);
        }
         #comment-input::placeholder { color: var(--text-placeholder); }
         #comment-input:focus { outline: none; box-shadow: 0 0 0 2px var(--accent-magenta); }

        .custom-modal-close-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            color: var(--text-secondary);
            background: none;
            border: none;
            padding: 0.25rem;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .custom-modal-close-btn:hover {
            color: var(--text-primary);
        }

        .custom-modal-close-btn i {
            width: 1.5rem;
            height: 1.5rem;
        }

        .custom-modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
            padding-right: 2rem;
        }

        .custom-modal-body {
            margin-bottom: 1.5rem;
            color: var(--text-secondary);
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .custom-modal-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1.5rem;
        }

        .modal-button {
            padding: 0.6rem 1.2rem;
            border-radius: 999px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            min-width: 100px;
        }

        .modal-button-primary {
            background: var(--accent-gradient);
            color: white;
        }

        .modal-button-primary:hover {
            background: var(--accent-gradient-hover);
            transform: scale(1.03);
        }

        .modal-button-secondary {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .modal-button-secondary:hover {
            background-color: rgba(255, 255, 255, 0.15);
            color: var(--text-primary);
        }
        
        .modal-button-danger {
            background: linear-gradient(115deg, #b91c1c, #ef4444);
            color: white;
        }

        .modal-button-danger:hover {
            background: linear-gradient(115deg, #a01818, #dc2626);
            transform: scale(1.03);
        }
        
        #custom-delete-reason.hidden {
            display: none;
        }

        #toast-container {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: var(--toast-z-index);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            align-items: flex-end;
            pointer-events: none;
        }

        .toast-item {
            pointer-events: auto;
            padding: 0.8rem 1.2rem;
            border-radius: 0.5rem;
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.4s ease, transform 0.4s cubic-bezier(0.215, 0.610, 0.355, 1);
            max-width: 300px;
            word-wrap: break-word;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toast-item.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast-item.success {
            background: linear-gradient(to right, var(--accent-green), #34d399);
        }

        .toast-item.error {
            background: linear-gradient(to right, var(--accent-red), #f87171);
        }

        .toast-item.info {
            background: linear-gradient(to right, var(--accent-blue), #93c5fd);
        }

        .toast-item i {
            flex-shrink: 0;
        }
    </style>
</head>

<body class="text-gray-200">

    <!-- Initial App Loader -->
    <div id="initial-loader">
        <div class="loader !w-16 !h-16 !border-4"></div>
        <p class="mt-4 text-lg text-gray-400">Menyiapkan NekoNime... <span class="uwu-text">♡</span></p>
    </div>

    <!-- SVG Symbols Definition -->
    <svg width="0" height="0" style="position:absolute;z-index:-1;">
        <symbol id="cat-symbol" viewBox="0 0 100 100">
            <path d="M 20 90 C 20 70, 30 60, 50 60 S 80 70, 80 90 Z" fill="currentColor" />
            <path d="M 20 65 L 30 40 L 40 65 Z" fill="currentColor" />
            <path d="M 80 65 L 70 40 L 60 65 Z" fill="currentColor" />
            <circle cx="40" cy="75" r="4" fill="#110c1b" />
            <circle cx="60" cy="75" r="4" fill="#110c1b" />
        </symbol>
        <symbol id="token-symbol" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path
                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 15.5c-3.04 0-5.5-2.46-5.5-5.5S8.96 6.5 12 6.5s5.5 2.46 5.5 5.5-2.46 5.5-5.5 5.5z" />
            <path d="M12 12l3-3" />
        </symbol>
    </svg>

    <!-- Main Application Container -->
    <div id="app-container">

        <!-- Header (Now Fixed) -->
        <header id="main-header" class="glassmorphism">
            <h1 id="header-title" class="text-xl lg:text-2xl font-bold text-white uwu-text"
                style="filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.5));">
                <a href="#gallery">NekoNime</a>
            </h1>

            <!-- Desktop Navigation -->
            <nav id="desktop-nav" class="hidden lg:flex items-center">
                <a href="#gallery" class="nav-link" data-page="gallery" title="Galeri Moe~"><i
                        data-lucide="layout-grid"></i></a>
                <a href="#random-girl" class="nav-link" data-page="random-girl"
                    title="Gacha Keberuntungan Universal! ♡"><i data-lucide="gift"></i></a>
                <a href="#favorites" class="nav-link" data-page="favorites" title="Favorit Kesayangan 💖"><i
                        data-lucide="heart"></i></a>
                <a href="#history" class="nav-link" data-page="history" title="Jejak Petualanganmu 📜"><i
                        data-lucide="history"></i></a>
                <a href="#collections" class="nav-link" data-page="collections" title="Koleksi Pribadimu 📚"><i
                        data-lucide="library"></i></a>
                <a href="#social" class="nav-link" data-page="social" title="Kumpul & Berbagi Cerita!"><i
                        data-lucide="users"></i></a>
                <a href="#profile" class="nav-link" data-page="profile" title="Profil Manismu ✨"><i
                        data-lucide="user-circle-2"></i></a>
                <a href="#about" class="nav-link" data-page="about" title="Tentang NekoNime Uwu~"><i
                        data-lucide="info"></i></a>
                <a href="#settings" class="nav-link" data-page="settings" title="Setelan Manja ✨"><i
                        data-lucide="settings"></i></a>
            </nav>

            <!-- Desktop Authentication & Token Container -->
            <div id="auth-container-desktop" class="auth-container hidden lg:flex">
                <!-- Content will be injected by JavaScript -->
            </div>

            <!-- Mobile Menu Toggle -->
            <button id="mobile-menu-toggle"
                class="p-2 rounded-full hover:bg-white/10 active:bg-white/20 transition-colors duration-150 lg:hidden">
                <i data-lucide="cat" class="w-7 h-7 text-pink-300"></i>
            </button>
        </header>

        <!-- Content Wrapper -->
        <div id="content-wrapper">
            <!-- Main Content Scrolling Area -->
            <div id="main-content-area">
                <main id="main-content">

                    <!-- Page: Gallery -->
                    <section id="page-gallery" class="page hidden">
                        <h2 class="text-3xl font-semibold mb-3 text-center uwu-text mt-0">Galeri Ilustrasi <span
                                class="text-lg">✨Nyaa~✨</span></h2>
                        <div id="category-selector-container" class="px-2 flex flex-wrap justify-center gap-2 mb-6">
                        </div>
                        <p class="text-center mb-6 text-gray-400 text-sm">Klik gambar buat intip lebih dekat & dapat
                            <span class="font-bold text-yellow-300">5 Neko Token</span>, <span class="uwu-text">Sayang
                                ♡</span>.</p>
                        <div id="gallery-loader" class="loader hidden"></div>
                        <div id="gallery-grid" class="masonry-grid"></div>
                        <div id="gallery-error" class="text-center mt-6 hidden px-4 text-lg"></div>
                        <div id="load-more-container">
                            <button id="load-more-btn">
                                <span id="load-more-btn-text">Muat Lebih Banyak Manisnya~</span>
                                <span id="load-more-spinner-text" class="hidden">Lagi ambil gambar uwu...</span>
                                <div id="load-more-spinner" class="loader !w-5 !h-5 !border-2 !m-0"></div>
                            </button>
                        </div>
                    </section>

                    <!-- Page: Profile -->
                    <section id="page-profile" class="page hidden">
                        <h2 class="text-3xl font-semibold mb-6 text-center uwu-text mt-0">Profil Manismu <span
                                class="text-lg">👤💖</span></h2>
                        <div id="profile-content-wrapper" class="max-w-2xl mx-auto space-y-6">
                            <!-- This will be populated by JS: either login prompt or profile data -->
                        </div>
                    </section>

                    <!-- Page: Social -->
                    <section id="page-social" class="page hidden">
                        <h2 class="text-3xl font-semibold mb-6 text-center uwu-text mt-0">NekoVerse Social <span
                                class="text-lg">🌐💞</span></h2>
                        <div id="social-content-wrapper">
                            <div class="tabs-container">
                                <button id="social-tab-feed" class="tab-btn active"
                                    data-target="social-feed-content">Feed Publik 📰</button>
                                <button id="social-tab-upload" class="tab-btn"
                                    data-target="social-upload-content">Upload Gambar 🖼️</button>
                                <button id="social-tab-chat" class="tab-btn" data-target="social-chat-content">Chat Umum
                                    💬</button>
                            </div>
                            <div id="social-feed-content" class="social-content max-w-2xl mx-auto">
                                <div id="social-feed-loader" class="loader"></div>
                                <div id="social-feed-grid"></div>
                                <p id="social-feed-empty"
                                    class="history-empty text-center text-gray-400 mt-6 hidden px-4"
                                    data-empty-message="Feed masih sepi... Jadilah yang pertama posting sesuatu!">Feed
                                    masih sepi... Jadilah yang pertama posting sesuatu!</p>
                            </div>
                            <div id="social-upload-content" class="social-content hidden max-w-2xl mx-auto">
                                <p class="text-center text-gray-400 mb-4">Bagikan gambar <span
                                        class="uwu-text">moe</span>-mu ke seluruh dunia!</p>
                                <form id="upload-post-form" class="upload-form">
                                    <textarea id="upload-caption" placeholder="Kasih caption yang manis dong..."></textarea>
                                    <div>
                                        <input type="file" id="upload-image-file"
                                            accept="image/png, image/jpeg, image/gif, image/webp" class="hidden" required>
                                        <label for="upload-image-file" id="file-upload-label"
                                            class="file-upload-label">
                                            <i data-lucide="upload-cloud" class="w-10 h-10 mx-auto mb-2 text-gray-400"></i>
                                            <span id="file-upload-text">Klik atau seret gambar kesini (Wajib)</span>
                                        </label>
                                        <div id="image-preview-container" class="hidden text-center">
                                            <img id="image-preview" src="#" alt="Pratinjau Gambar">
                                        </div>
                                    </div>
                                    <div>
                                        <label for="upload-privacy"
                                            class="block mb-2 font-medium text-sm text-gray-300">Siapa yang boleh
                                            lihat?</label>
                                        <select id="upload-privacy" class="cursor-pointer">
                                            <option value="public">Publik (Semua Orang)</option>
                                            <option value="unlisted">Hanya via Link (Tersembunyi)</option>
                                            <option value="private">Pribadi (Hanya Kamu)</option>
                                        </select>
                                    </div>
                                    <button type="submit" id="upload-submit-btn"
                                        class="modal-button modal-button-primary w-full flex items-center justify-center gap-2">
                                        <i data-lucide="send" class="w-5 h-5"></i> <span id="upload-btn-text">Posting Sekarang!</span>
                                    </button>
                                </form>
                            </div>
                            <div id="social-chat-content" class="social-content hidden max-w-2xl mx-auto">
                                <p class="text-center text-gray-400 mb-4">Ngobrol santai dengan sesama penghuni
                                    NekoNime! <span class="uwu-text">(Be nice yaa~)</span></p>
                                <div id="chat-container">
                                    <div id="chat-messages">
                                        <div id="chat-loader" class="loader my-auto"></div>
                                    </div>
                                    <form id="chat-form">
                                        <input id="chat-input" type="text" placeholder="Ketik pesan manismu..." required>
                                        <button type="submit" id="chat-send-btn"
                                            class="modal-button modal-button-primary"><i
                                                data-lucide="send-horizontal"></i></button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Page: History -->
                    <section id="page-history" class="page hidden">
                        <h2 class="text-3xl font-semibold mb-6 text-center uwu-text mt-0">History Petualanganmu <span
                                class="text-lg">📜🕰️</span></h2>
                        <div class="tabs-container">
                            <button id="history-tab-browse" class="tab-btn active">Jelajah ✨</button>
                            <button id="history-tab-gacha" class="tab-btn">Gacha 🎰</button>
                        </div>
                        <div id="history-browse-content" class="history-content">
                            <p class="text-center mb-4 text-gray-400 text-sm">Gambar-gambar <span
                                    class="uwu-text">gemes</span> yang udah kamu intip~</p>
                            <div id="history-browse-loader" class="loader hidden"></div>
                            <div id="history-browse-grid" class="masonry-grid"></div>
                            <p id="history-browse-empty"
                                class="history-empty text-center text-gray-400 mt-6 hidden"
                                data-empty-message="History jelajahmu masih kosong nih... (｡•́︿•̀｡) Ayo jelajahi galerinya~">
                                .</p>
                        </div>
                        <div id="history-gacha-content" class="history-content hidden">
                            <p class="text-center mb-4 text-gray-400 text-sm">Hasil Gacha <span
                                    class="uwu-text">keberuntunganmu</span> yang pernah didapat!</p>
                            <div id="history-gacha-loader" class="loader hidden"></div>
                            <div id="history-gacha-grid" class="masonry-grid"></div>
                            <p id="history-gacha-empty"
                                class="history-empty text-center text-gray-400 mt-6 hidden"
                                data-empty-message="Belum pernah Gacha yaa? (¬_¬ ) Coba keberuntunganmu sekarang!">.</p>
                        </div>
                    </section>

                    <!-- Page: Collections -->
                    <section id="page-collections" class="page hidden">
                        <h2 class="text-3xl font-semibold mb-4 text-center uwu-text mt-0">Koleksi Pribadimu <span
                                class="text-lg">📚💖</span></h2>
                        <div id="collections-main-view">
                            <p class="text-center mb-4 text-gray-400">Bikin koleksi baru dapat <span
                                    class="font-bold text-yellow-300">15 Neko Token</span>!</p>
                            <div class="max-w-2xl mx-auto mb-6">
                                <form id="create-collection-form" class="flex items-center gap-2">
                                    <input type="text" id="new-collection-name"
                                        placeholder="Nama Koleksi Baru yang Manis..." required
                                        class="flex-grow p-2.5 rounded-lg bg-black/30 border border-white/10 focus:outline-none focus:ring-2 focus:ring-[var(--accent-magenta)] text-gray-200 placeholder-gray-500">
                                    <button type="submit"
                                        class="text-white font-bold py-2.5 px-5 rounded-lg transition-colors bg-[var(--accent-gradient)] hover:bg-[var(--accent-gradient-hover)] shadow-md flex items-center gap-1.5 flex-shrink-0">
                                        <i data-lucide="plus" class="w-5 h-5"></i> Bikin!
                                    </button>
                                </form>
                            </div>
                            <div id="collection-list-loader" class="loader hidden"></div>
                            <div id="collection-list" class="max-w-2xl mx-auto space-y-3"></div>
                            <p id="collection-list-empty"
                                class="history-empty text-center text-gray-400 mt-6 hidden"
                                data-empty-message="Kamu belum punya koleksi... Σ(°ロ°) Buat satu yuk pakai tombol di atas! ↑">
                                .</p>
                        </div>
                        <div id="collection-detail-view" class="hidden">
                            <button id="back-to-collections-btn"
                                class="mb-4 flex items-center gap-1 text-sm text-purple-300 hover:text-purple-100">
                                <i data-lucide="arrow-left" class="w-4 h-4"></i> Kembali ke Daftar Koleksi
                            </button>
                            <h3 id="collection-detail-title" class="text-2xl font-semibold mb-4 text-center uwu-text">
                            </h3>
                            <div id="collection-image-loader" class="loader hidden"></div>
                            <div id="collection-image-grid" class="masonry-grid"></div>
                            <p id="collection-image-empty"
                                class="history-empty text-center text-gray-400 mt-6 hidden"
                                data-empty-message="Koleksi ini masih kosong melompong (っ´ω`)ﾉ(╥ω╥). Yuk, tambahkan gambar favoritmu!">
                                .</p>
                        </div>
                    </section>

                    <!-- Page: Favorites -->
                    <section id="page-favorites" class="page hidden">
                        <h2 class="text-3xl font-semibold mb-6 text-center uwu-text mt-0">Favorit Kesayanganmu <span
                                class="text-lg">💖😍</span></h2>
                        <p class="text-center mb-6 text-gray-400">Setiap nge-like dapat <span
                                class="font-bold text-yellow-300">10 Neko Token</span> lho~ Kyaa!</p>
                        <div id="favorites-loader" class="loader hidden"></div>
                        <div id="favorites-grid" class="masonry-grid"></div>
                        <p id="favorites-empty" class="history-empty text-center text-gray-400 mt-6 hidden"
                            data-empty-message="Ehh? Belum ada favorit? ( T д T ) Jangan malu-malu, klik ikon hati ♡ di gambar yang kamu suka ya!">
                            .</p>
                    </section>

                    <!-- Page: Gacha (Universal Gacha, With Token Cost!) -->
                    <section id="page-random-girl" class="page hidden flex flex-col items-center justify-center text-center">
                        <h2 class="text-3xl font-semibold mb-6 uwu-text mt-0">Gacha Universal NekoNime! <span
                                class="text-lg">🎰💖</span></h2>
                        <p class="mb-6 text-gray-400 max-w-md mx-auto">Siap-siap dapet kejutan <span
                                class="uwu-text">moe acak</span> dari SEMUA kategori di API <strong id="gacha-api-name"
                                class="text-purple-300">ini</strong>! Semoga dapet waifu/husbando idaman~</p>

                        <!-- Gacha Buttons Container -->
                        <div id="gacha-actions"
                            class="w-full max-w-lg flex flex-col sm:flex-row items-center justify-center gap-4 mb-6">
                            <button id="gacha-button"
                                class="text-white font-bold py-3 px-8 rounded-full shadow-lg transform hover:scale-105 transition duration-300 ease-in-out text-lg relative overflow-hidden bg-[var(--accent-gradient)] hover:bg-[var(--accent-gradient-hover)] !shadow-magenta-500/30 hover:!shadow-magenta-500/40 flex-shrink-0">
                                <span class="relative z-10 flex items-center gap-2">
                                    <i data-lucide="dices" class="w-5 h-5"></i>
                                    <span id="gacha-button-text">Gacha Sekarang!</span>
                                </span>
                            </button>
                            <button id="gacha-reset-button" class="hidden text-sm flex-shrink-0">
                                <i data-lucide="rotate-ccw"></i> Reset?
                            </button>
                        </div>

                        <!-- Gacha Result Container -->
                        <div class="w-full max-w-lg flex flex-col items-center">
                            <div id="gacha-result-container"
                                class="w-full flex flex-col items-center justify-center min-h-[50vh] glassmorphism p-4 rounded-xl relative overflow-hidden">
                                <div id="gacha-animation-container" class="hidden"></div>
                                <div id="gacha-image-wrapper" class="hidden opacity-0">
                                    <img id="gacha-result-image" src="" alt="Hasil Gacha Anime Uwu~" />
                                </div>
                                <p id="gacha-placeholder">
                                    Ayo tekan tombol Gacha di atas!<br><span class="uwu-text text-sm">(Semoga
                                        beruntung yaa ♡)</span>
                                </p>
                                <p id="gacha-error" class="hidden">Aduuh, Gachanya lagi ngambek nih...</p>
                            </div>
                        </div>
                    </section>

                    <!-- Page: Settings -->
                    <section id="page-settings" class="page hidden max-w-xl mx-auto">
                        <h2 class="text-3xl font-semibold mb-6 text-center uwu-text mt-0">Setelan Manja <span
                                class="text-lg">⚙️🔧</span></h2>
                        <p class="text-center mb-8 text-gray-400">Atur NekoNime <span class="uwu-text">sesuai
                                seleramu</span> di sini~</p>

                        <div class="settings-data-group">
                            <h3>Sumber Gambar Galeri & Gacha (API) <span class="uwu-text">♡</span></h3>
                            <label id="api-selector-label" for="api-selector">Pilih API buat Galeri & Gacha:</label>
                            <select id="api-selector"
                                class="w-full p-2.5 rounded-lg bg-black/30 border border-white/10 focus:outline-none focus:ring-2 focus:ring-[var(--accent-purple)] text-gray-200 cursor-pointer">
                            </select>
                            <p class="text-xs text-gray-500">Ganti API bakal muat ulang galeri & ganti sumber gacha,
                                <span class="uwu-text">sayang</span>.</p>
                        </div>

                        <div class="settings-data-group">
                            <h3>Manajemen Data <span class="uwu-text">(Hati-hati!)</span></h3>
                            <p class="text-sm">Aksi ini akan mempengaruhi data sesuai mode-mu saat ini: <strong
                                    class="text-yellow-300">data lokal (jika logout)</strong> atau <strong
                                    class="text-blue-300">data cloud (jika login)</strong>.</p>
                            <div class="mt-4 space-y-1">
                                <div class="settings-data-action">
                                    <span>History Jelajah</span>
                                    <button id="clear-history-browse-btn" class="clear-button">Hapus</button>
                                </div>
                                <div class="settings-data-action">
                                    <span>History Gacha</span>
                                    <button id="clear-history-gacha-btn" class="clear-button">Hapus</button>
                                </div>
                                <div class="settings-data-action">
                                    <span>Favorit Kesayangan</span>
                                    <button id="clear-favorites-btn" class="clear-button">Hapus</button>
                                </div>
                                <div class="settings-data-action">
                                    <span>Semua Koleksi</span>
                                    <button id="clear-collections-btn" class="clear-button">Hapus</button>
                                </div>
                            </div>
                            <div class="mt-6 pt-4 border-t border-[var(--glass-border)] flex flex-col items-center">
                                <button id="clear-all-data-btn">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i> Hapus SEMUA Data!?
                                </button>
                                <p class="text-xs text-center text-gray-500 mt-3">(*Tindakan Hapus ini <strong
                                        class="text-red-400">permanen</strong> lho! Yakin nih?)</p>
                            </div>
                        </div>
                    </section>

                    <!-- Page: About -->
                    <section id="page-about" class="page hidden glassmorphism p-6 max-w-3xl mx-auto rounded-xl">
                        <h2 class="text-3xl font-bold mb-4 text-center uwu-text mt-0">Tentang NekoNime <span
                                class="text-lg">(ﾉ´ヮ´)ﾉ*:･ﾟ✧</span></h2>
                        <div class="flex justify-center mb-4">
                            <svg class="w-16 h-16" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"
                                style="filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));">
                                <defs>
                                    <linearGradient id="chibiHair2" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" stop-color="#fbcfe8" />
                                        <stop offset="100%" stop-color="#f9a8d4" />
                                    </linearGradient>
                                </defs>
                                <circle cx="50" cy="45" r="35" fill="url(#chibiHair2)" />
                                <circle cx="38" cy="40" r="6" fill="#271c2e" />
                                <circle cx="62" cy="40" r="6" fill="#271c2e" />
                                <path d="M 40 55 Q 50 65 60 55" stroke="#e11d48" fill="none" stroke-width="3"
                                    stroke-linecap="round" />
                                <path d="M 20 25 Q 30 5 40 25 Z" fill="url(#chibiHair2)" stroke="#4a044e"
                                    stroke-width="1.5" />
                                <path d="M 80 25 Q 70 5 60 25 Z" fill="url(#chibiHair2)" stroke="#4a044e"
                                    stroke-width="1.5" />
                            </svg>
                        </div>
                        <p class="mb-4 text-lg leading-relaxed text-center">
                            Halooo Minna-san~ <span class="uwu-text">(≧∇≦)/</span> Selamat datang di versi terbaru <strong
                                class="font-semibold text-purple-300">NekoNime</strong>! Tempat paling <em
                                class="uwu-text font-medium">uwu</em> dan <em
                                class="uwu-text font-medium">interaktif</em> di jagat web! <span
                                class="uwu-text">♡ඩ⌔ඩ♡</span>
                        </p>
                        <p class="mb-4 text-gray-300 leading-relaxed text-center">
                            NekoNime telah berevolusi! Sekarang bukan cuma galeri, tapi jadi sebuah <strong
                                class="text-blue-300">platform sosial mini</strong> buat kamu para pecinta anime sejati!
                            Dapatkan <strong class="text-yellow-300">Neko Token</strong> dari aktivitasmu dan gunakan
                            untuk Gacha!
                        </p>
                        <p class="mb-4 text-gray-300 leading-relaxed text-center">
                            Fitur baru yang <span class="uwu-text">bikin heboh</span>:
                        <ul class="list-none text-center mt-2 space-y-1 text-gray-400">
                             <li><i data-lucide="thumbs-up" class="inline-block w-4 h-4 text-red-400 mr-1"></i> <strong
                                    class="text-red-300">Sistem Like, Komen, Share, Edit & Hapus</strong> (<span class="uwu-text">Pegang kendali penuh!</span>)</li>
                            <li><i data-lucide="image-down" class="inline-block w-4 h-4 text-teal-300 mr-1"></i> <strong
                                    class="text-teal-300">Kompresi Gambar Otomatis</strong> (<span class="uwu-text">upload lebih cepat & hemat!</span>)</li>
                            <li><i data-lucide="coins" class="inline-block w-4 h-4 text-yellow-300 mr-1"></i> <strong
                                    class="text-yellow-300">Sistem Neko Token</strong> (<span class="uwu-text">kumpulkan
                                    dari aktivitas, pakai buat Gacha!</span>)</li>
                            <li><i data-lucide="users" class="inline-block w-4 h-4 text-cyan-300 mr-1"></i> <strong
                                    class="text-cyan-300">Fitur Sosial Aktif!</strong> (<span class="uwu-text">upload
                                    gambar, feed & chat!</span>)</li>
                            <li><i data-lucide="user-circle-2"
                                    class="inline-block w-4 h-4 text-pink-400 mr-1"></i> <strong
                                    class="text-pink-300">Halaman Profil Pengguna</strong> (<span class="uwu-text">atur
                                    username & lihat statistikmu!</span>)</li>
                        </ul>
                        </p>
                        <p class="text-gray-300 leading-relaxed text-center">
                            Semua keajaiban ini berjalan mulus pakai <strong class="text-red-400">Firebase (Auth,
                                Firestore)</strong>, <strong class="text-teal-300">Tailwind CSS</strong> &
                            <strong class="text-yellow-300">JavaScript</strong> murni dalam <em
                                class="text-green-300">Single Page Application (SPA)</em>. Cepat, ringan, dan <span
                                class="uwu-text">uwu</span> pastinya! <span class="uwu-text">(づ￣ ³￣)づ</span>
                        </p>
                        <p class="mt-6 text-center text-sm text-gray-400">
                            Versi 10.0.8 | Dibuat dengan <i data-lucide="sparkles"
                                class="inline-block w-4 h-4 text-yellow-400"></i> oleh <span
                                class="font-semibold text-purple-300">Delta Astra</span>.
                            Makasih udah mampir~! <span class="uwu-text">(⌒▽⌒)☆</span>
                        </p>
                    </section>

                </main>
            </div> <!-- End #main-content-area -->
        </div> <!-- End #content-wrapper -->

        <!-- Mobile Navigation Overlay -->
        <div id="mobile-nav-overlay">
            <button id="close-mobile-nav-btn" class="absolute top-6 right-6 text-gray-300 hover:text-white z-50">
                <i data-lucide="x" class="w-8 h-8"></i>
            </button>
            <div id="mobile-nav-links" class="glassmorphism">
                <div id="mobile-nav-main-links">
                    <a href="#gallery" data-page="gallery" class="nav-link">Galeri Moe~</a>
                    <a href="#random-girl" data-page="random-girl" class="nav-link">Gacha Hoki ♡</a>
                    <a href="#favorites" data-page="favorites" class="nav-link">Favorit 💖</a>
                    <a href="#history" data-page="history" class="nav-link">History 📜</a>
                    <a href="#collections" data-page="collections" class="nav-link">Koleksi 📚</a>
                    <a href="#social" data-page="social" class="nav-link">Sosial 🌐</a>
                    <a href="#profile" data-page="profile" class="nav-link">Profil ✨</a>
                    <a href="#about" data-page="about" class="nav-link">Tentang ✨</a>
                    <a href="#settings" data-page="settings" class="nav-link">Setelan ⚙️</a>
                </div>

                <!-- Mobile Authentication Container -->
                <div id="auth-container-mobile">
                    <!-- Content will be injected by JavaScript -->
                </div>

                <button id="feedback-button-mobile"
                    class="mt-2 text-sm text-purple-300 hover:text-purple-100 transition-colors py-2 flex items-center gap-1 justify-center w-full">
                    <i data-lucide="message-circle-question" class="w-4 h-4"></i> Kirim Masukanmu~
                </button>
            </div>
        </div>

        <!-- Feedback Modal -->
        <div id="feedback-modal" class="custom-modal-overlay">
            <div class="custom-modal-content">
                <button id="close-feedback-modal" class="custom-modal-close-btn"> <i data-lucide="x"></i> </button>
                <h3 class="custom-modal-title uwu-text">Bisikin Sesuatu? <span class="text-base">(´• ω •`) ♡</span>
                </h3>
                <p class="custom-modal-body">Saran, kritik, atau nemu bug aneh? Kasih tau dong~ Masukanmu berharga banget
                    lho!</p>
                <form id="feedback-form">
                    <textarea id="feedback-message" rows="4"
                        class="w-full p-3 rounded-lg bg-black/30 border border-white/10 focus:outline-none focus:ring-2 focus:ring-[var(--accent-magenta)] text-gray-200 placeholder-gray-500 mb-4"
                        placeholder="Tulis uneg-unegmu di sini..." required></textarea>
                    <button type="submit" class="modal-button modal-button-primary w-full"> Kirim Bisikan! </button>
                </form>
                <p id="feedback-status" class="text-center text-sm mt-3"></p>
            </div>
        </div>

        <!-- Lightbox Modal -->
        <div id="lightbox-modal" onclick="closeLightbox()">
            <div id="lightbox-content" onclick="event.stopPropagation()">
                <button id="close-lightbox-btn" onclick="closeLightbox()"> <i data-lucide="x" class="w-4 h-4"></i>
                </button>
                <img id="lightbox-image" src="" alt="Anime Illustration Detail Uwu~">
                <div id="lightbox-details">
                    Art oleh <span id="lightbox-artist" class="uwu-text"></span>
                    <a id="lightbox-source" href="#" target="_blank" rel="noopener noreferrer"
                        onclick="event.stopPropagation()" title="Kunjungi Sumber Asli!">
                        <i data-lucide="external-link" class="inline-block w-4 h-4"></i> Sumber
                    </a>
                </div>
                <div id="lightbox-actions">
                    <button id="lightbox-favorite-btn" class="flex items-center gap-1">
                        <i data-lucide="heart" class="w-4 h-4"></i> <span>Favorit</span>
                    </button>
                    <button id="lightbox-add-collection-btn" class="flex items-center gap-1">
                        <i data-lucide="plus-square" class="w-4 h-4"></i> <span>Tambah ke Koleksi</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Comment Modal -->
        <div id="comment-modal" class="custom-modal-overlay">
            <div class="custom-modal-content">
                <button id="close-comment-modal" class="custom-modal-close-btn"> <i data-lucide="x"></i> </button>
                <h3 class="custom-modal-title uwu-text">Komentar Manis <span class="text-base">💬</span></h3>
                
                <div id="comment-list">
                   <div class="loader my-auto"></div>
                </div>

                <form id="comment-form">
                    <input id="comment-input" type="text" placeholder="Tulis komentar manismu..." required>
                    <button type="submit" id="comment-send-btn" class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 bg-[var(--accent-gradient)] hover:bg-[var(--accent-gradient-hover)] transition-transform duration-200 hover:scale-110">
                        <i data-lucide="send" class="w-5 h-5 text-white"></i>
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Post Options Modal -->
        <div id="post-options-modal" class="custom-modal-overlay">
            <div class="custom-modal-content !max-w-xs">
                <button id="close-post-options-modal-btn" class="custom-modal-close-btn"> <i data-lucide="x"></i> </button>
                <h3 class="custom-modal-title">Opsi Postingan</h3>
                <div class="custom-modal-actions !flex-col !items-stretch">
                    <button id="post-options-edit-btn" class="modal-button modal-button-secondary flex items-center justify-center">
                        <i data-lucide="edit" class="w-4 h-4 mr-2"></i>Edit Postingan
                    </button>
                    <button id="post-options-delete-btn" class="modal-button !bg-red-500/20 !text-red-400 !border-red-500/30 hover:!bg-red-500/30 hover:!text-red-300 flex items-center justify-center">
                        <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>Hapus Postingan
                    </button>
                </div>
            </div>
        </div>

        <!-- Edit Post Modal -->
        <div id="edit-post-modal" class="custom-modal-overlay">
            <div class="custom-modal-content">
                <button id="close-edit-post-modal" class="custom-modal-close-btn"> <i data-lucide="x"></i> </button>
                <h3 class="custom-modal-title uwu-text">Edit Postingan Manismu <span class="text-base">✍️</span></h3>
                <form id="edit-post-form">
                    <div class="custom-modal-body !p-0 !mb-4 text-left">
                        <label for="edit-caption" class="block mb-2 font-medium text-sm text-gray-300">Caption:</label>
                        <textarea id="edit-caption" rows="4" class="w-full p-3 rounded-lg bg-black/30 border border-white/10 focus:outline-none focus:ring-2 focus:ring-[var(--accent-magenta)] text-gray-200 placeholder-gray-500 mb-4" placeholder="Caption yang manis..."></textarea>
                        
                        <label for="edit-privacy" class="block mb-2 font-medium text-sm text-gray-300">Siapa yang boleh lihat?</label>
                        <select id="edit-privacy" class="w-full p-2.5 rounded-lg bg-black/30 border border-white/10 focus:outline-none focus:ring-2 focus:ring-[var(--accent-magenta)] text-gray-200 cursor-pointer">
                            <option value="public">Publik (Semua Orang)</option>
                            <option value="unlisted">Hanya via Link (Tersembunyi)</option>
                            <option value="private">Pribadi (Hanya Kamu)</option>
                        </select>
                    </div>
                    <div class="custom-modal-actions">
                        <button type="button" id="edit-post-cancel-btn" class="modal-button modal-button-secondary">Batal</button>
                        <button type="submit" class="modal-button modal-button-primary">Simpan Perubahan</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Delete Post Modal -->
        <div id="delete-post-modal" class="custom-modal-overlay">
            <div class="custom-modal-content">
                <button id="close-delete-post-modal-btn" class="custom-modal-close-btn"> <i data-lucide="x"></i> </button>
                <h3 class="custom-modal-title text-red-400">Hapus Postingan?</h3>
                <p class="custom-modal-body !mb-4">Tindakan ini tidak bisa dibatalkan. Postingan akan hilang selamanya. Pilih alasan penghapusan di bawah ini.</p>
                
                <form id="delete-post-form" class="text-left space-y-2">
                    <label class="flex items-center gap-2 p-2 rounded-md hover:bg-white/5 cursor-pointer">
                        <input type="radio" name="delete_reason" value="spam" class="accent-pink-500" checked> Spam atau Promosi
                    </label>
                    <label class="flex items-center gap-2 p-2 rounded-md hover:bg-white/5 cursor-pointer">
                        <input type="radio" name="delete_reason" value="inappropriate" class="accent-pink-500"> Konten Tidak Pantas
                    </label>
                    <label class="flex items-center gap-2 p-2 rounded-md hover:bg-white/5 cursor-pointer">
                        <input type="radio" name="delete_reason" value="mistake" class="accent-pink-500"> Salah Upload / Tidak Disengaja
                    </label>
                    <label class="flex items-center gap-2 p-2 rounded-md hover:bg-white/5 cursor-pointer">
                        <input type="radio" name="delete_reason" value="other" class="accent-pink-500"> Lainnya...
                    </label>
                    <textarea id="custom-delete-reason" placeholder="Tulis alasan lain di sini..." class="w-full p-2 mt-2 rounded-lg bg-black/30 border border-white/10 focus:outline-none focus:ring-1 focus:ring-[var(--accent-red)] text-gray-200 placeholder-gray-500 text-sm hidden"></textarea>

                    <div class="custom-modal-actions">
                        <button type="button" id="delete-post-cancel-btn" class="modal-button modal-button-secondary">Batal</button>
                        <button type="submit" class="modal-button modal-button-danger">Ya, Hapus Sekarang</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add to Collection Modal -->
        <div id="add-to-collection-modal" class="custom-modal-overlay">
            <div class="custom-modal-content">
                <button id="close-add-to-collection-modal" class="custom-modal-close-btn"> <i data-lucide="x"></i>
                </button>
                <h3 class="custom-modal-title uwu-text">Mau Simpan Kemana Nih? ♡</h3>
                <p class="custom-modal-body !mb-3">Menambah ke koleksi dapat <span
                        class="font-bold text-yellow-300">15 Neko Token</span>! Pilih yang sudah ada atau buat baru~</p>
                <div id="add-to-collection-modal-list"></div>
                <p id="add-to-collection-empty" class="history-empty text-sm text-gray-500 my-4 hidden"
                    data-empty-message="Yah.. belum ada koleksi (っ˘̩╭╮˘̩)っ Bikin baru dulu yuk ↓">Belum ada koleksi.</p>
                <form id="add-create-collection-form" class="flex flex-col sm:flex-row gap-2 mt-4">
                    <input type="text" id="add-new-collection-name"
                        placeholder="Atau ketik nama koleksi baru di sini..."
                        class="flex-grow p-2 rounded-lg bg-black/30 border border-white/10 focus:outline-none focus:ring-1 focus:ring-[var(--accent-magenta)] text-gray-200 placeholder-gray-500 text-sm w-full sm:w-auto">
                    <button type="submit"
                        class="modal-button modal-button-primary !px-4 !py-2 text-sm flex items-center gap-1 justify-center w-full sm:w-auto flex-shrink-0">
                        <i data-lucide="plus" class="w-4 h-4"></i> Bikin & Tambah!
                    </button>
                </form>
            </div>
        </div>

        <!-- Alert Modal -->
        <div id="alert-modal" class="custom-modal-overlay">
            <div class="custom-modal-content">
                <button class="custom-modal-close-btn"> <i data-lucide="x"></i> </button>
                <h3 id="alert-modal-title" class="custom-modal-title uwu-text">Info Penting! ✨</h3>
                <p id="alert-modal-body" class="custom-modal-body">Msg.</p>
                <div class="custom-modal-actions">
                    <button id="alert-modal-ok" class="modal-button modal-button-primary">Oke Deh!</button>
                </div>
            </div>
        </div>

        <!-- Confirm Modal -->
        <div id="confirm-modal" class="custom-modal-overlay">
            <div class="custom-modal-content">
                <button class="custom-modal-close-btn"> <i data-lucide="x"></i> </button>
                <h3 id="confirm-modal-title" class="custom-modal-title uwu-text">Konfirmasi Dulu Dong~ 🤔</h3>
                <p id="confirm-modal-body" class="custom-modal-body">Yakin nih mau lanjut?</p>
                <div class="custom-modal-actions">
                    <button id="confirm-modal-cancel" class="modal-button modal-button-secondary">Eh, Nggak
                        Jadi!</button>
                    <button id="confirm-modal-ok" class="modal-button modal-button-primary">Iya, Yakin!</button>
                </div>
            </div>
        </div>

        <!-- Toast Notification Container -->
        <div id="toast-container"></div>

    </div> <!-- End #app-container -->

    <!-- MERGED JAVASCRIPT: Firebase + App Logic -->
    <script type="module">
        // --- FIREBASE INITIALIZATION ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, writeBatch, collection, addDoc, query, where, orderBy, limit, getDocs, onSnapshot, serverTimestamp, runTransaction, arrayUnion, arrayRemove, increment, deleteDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyB1ckKXbGKjfMi2M_hT6ut3bbuXHotPFmE",
            authDomain: "nekonime-phi.firebaseapp.com",
            projectId: "nekonime-phi",
            storageBucket: "nekonime-phi.appspot.com",
            messagingSenderId: "32265704368",
            appId: "1:32265704368:web:1b7d19214fae873e3fbc75",
            measurementId: "G-RXC8MJR2B6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- APP LOGIC ---

        // --- Constants and Configuration ---
        const GALLERY_IMAGES_PER_LOAD = 24;
        const HISTORY_MAX_ITEMS = 50;
        const FEEDBACK_EMAIL = "deltaastra24@gmail.com";
        const FETCH_TIMEOUT = 20000;
        const GACHA_ANIMATION_BASE_DURATION = 1800;
        const GACHA_ANIMATION_STAGGER_DELAY = 150;
        const GACHA_COST = 50;
        const COMPRESSION_THRESHOLD = 200 * 1024; 
        const ABSOLUTE_MAX_SIZE = 5 * 1024 * 1024;
        const COMPRESSION_MAX_DIMENSION = 1280;
        const COMPRESSION_QUALITY = 0.75;

        // --- API Configuration (No changes) ---
        const API_CONFIG = {
            nekos: { name: 'Nekos.best', baseUrl: 'https://nekos.best/api/v2/', categories: [{ name: "Waifu Tercinta ♡", endpoint: "waifu" }, { name: "Neko Gemes 🐾", endpoint: "neko" }, { name: "Husbu Idaman ✨", endpoint: "husbando" }, { name: "Kitsune Cerdik 🦊", endpoint: "kitsune" }, { name: "Senyum Manis 😊", endpoint: "smile" }, { name: "Peluk Hangat 🤗", endpoint: "cuddle" }, { name: "Cium Mesra 😘", endpoint: "kiss" }, { name: "Tampar Manja 👋", endpoint: "slap" }, { name: "Elus Kepala 👋", endpoint: "pat" }, { name: "Gigit Gemes >.<", endpoint: "bite" }, { name: "Malu-malu😳", endpoint: "blush" }, { name: "Kedip Nakal 😉", endpoint: "wink" }, { name: "Manyun Lucu 😗", endpoint: "pout" }, { name: "Tos Semangat 🙌", endpoint: "highfive" }, { name: "Menari Ria 💃", endpoint: "dance" },], allEndpoints: ["waifu", "neko", "husbando", "kitsune", "smile", "cuddle", "kiss", "lick", "pat", "smug", "bonk", "yeet", "blush", "smile", "wave", "highfive", "handhold", "nom", "bite", "glomp", "slap", "kill", "kick", "happy", "wink", "poke", "dance", "cringe", "baka", "bored", "cry", "feed", "hug", "laugh", "poke", "pout", "shrug", "sleep", "stare", "think", "thumbsup", "tickle", "tired", "wink"], defaultGachaCategory: 'waifu', parser: (data) => { const item = data?.results?.[0] || data; if (item?.url) { const artistName = item.artist_name ? String(item.artist_name) : 'Artis Misterius (nekos.best)'; const sourceUrl = item.source_url ? String(item.source_url) : item.url; return { url: item.url, artist_name: artistName, source_url: sourceUrl, apiSource: 'nekos' }; } return null; } },
            waifupics: { name: 'waifu.pics', baseUrl: 'https://api.waifu.pics/', categories: [{ name: 'Waifu (SFW)', endpoint: 'sfw/waifu' }, { name: 'Neko (SFW)', endpoint: 'sfw/neko' }, { name: 'Shinobu', endpoint: 'sfw/shinobu' }, { name: 'Megumin', endpoint: 'sfw/megumin' }, { name: 'Peluk (SFW)', endpoint: 'sfw/hug' }, { name: 'Cium (SFW)', endpoint: 'sfw/kiss' }, { name: 'Elus (SFW)', endpoint: 'sfw/pat' }, { name: 'Senyum (SFW)', endpoint: 'sfw/smile' }, { name: 'Waifu (NSFW) 🔥', endpoint: 'nsfw/waifu' }, { name: 'Neko (NSFW) 🔥', endpoint: 'nsfw/neko' }, { name: 'Trap (NSFW) 🤫', endpoint: 'nsfw/trap' }, { name: 'Blowjob (NSFW) 🔞', endpoint: 'nsfw/blowjob' }], allEndpoints: ['sfw/waifu', 'sfw/neko', 'sfw/shinobu', 'sfw/megumin', 'sfw/bully', 'sfw/cuddle', 'sfw/cry', 'sfw/hug', 'sfw/awoo', 'sfw/kiss', 'sfw/lick', 'sfw/pat', 'sfw/smug', 'sfw/bonk', 'sfw/yeet', 'sfw/blush', 'sfw/smile', 'sfw/wave', 'sfw/highfive', 'sfw/handhold', 'sfw/nom', 'sfw/bite', 'sfw/glomp', 'sfw/slap', 'sfw/kill', 'sfw/kick', 'sfw/happy', 'sfw/wink', 'sfw/poke', 'sfw/dance', 'sfw/cringe', 'nsfw/waifu', 'nsfw/neko', 'nsfw/trap', 'nsfw/blowjob'], defaultGachaCategory: 'sfw/waifu', parser: (data) => { if (data?.url) { return { url: data.url, artist_name: 'Artis Misterius (waifu.pics)', source_url: data.url, apiSource: 'waifupics' }; } return null; } }
        };

        // --- DOM Element References ---
        const initialLoader = document.getElementById('initial-loader');
        const appContainer = document.getElementById('app-container');
        const mainContent = document.getElementById('main-content');
        const mainContentArea = document.getElementById('main-content-area');
        const pages = document.querySelectorAll('.page');
        const toastContainer = document.getElementById('toast-container');
        const headerTitle = document.getElementById('header-title');
        const authContainerDesktop = document.getElementById('auth-container-desktop');
        const authContainerMobile = document.getElementById('auth-container-mobile');
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        const mobileNavOverlay = document.getElementById('mobile-nav-overlay');
        const closeMobileNavBtn = document.getElementById('close-mobile-nav-btn');
        const mobileNavLinksContainer = document.getElementById('mobile-nav-links');
        const galleryGrid = document.getElementById('gallery-grid');
        const galleryLoader = document.getElementById('gallery-loader');
        const categorySelectorContainer = document.getElementById('category-selector-container');
        const galleryError = document.getElementById('gallery-error');
        const loadMoreContainer = document.getElementById('load-more-container');
        const loadMoreBtn = document.getElementById('load-more-btn');
        const gachaButton = document.getElementById('gacha-button');
        const gachaButtonText = document.getElementById('gacha-button-text');
        const gachaPlaceholder = document.getElementById('gacha-placeholder');
        const gachaImageWrapper = document.getElementById('gacha-image-wrapper');
        const gachaResultImage = document.getElementById('gacha-result-image');
        const gachaResetButton = document.getElementById('gacha-reset-button');
        const gachaAnimationContainer = document.getElementById('gacha-animation-container');
        const gachaErrorMsg = document.getElementById('gacha-error');
        const gachaApiNameSpan = document.getElementById('gacha-api-name');
        const historyTabBrowse = document.getElementById('history-tab-browse');
        const historyTabGacha = document.getElementById('history-tab-gacha');
        const historyBrowseContent = document.getElementById('history-browse-content');
        const historyGachaContent = document.getElementById('history-gacha-content');
        const historyBrowseGrid = document.getElementById('history-browse-grid');
        const historyGachaGrid = document.getElementById('history-gacha-grid');
        const historyBrowseLoader = document.getElementById('history-browse-loader');
        const historyGachaLoader = document.getElementById('history-gacha-loader');
        const historyBrowseEmpty = document.getElementById('history-browse-empty');
        const historyGachaEmpty = document.getElementById('history-gacha-empty');
        const createCollectionForm = document.getElementById('create-collection-form');
        const newCollectionNameInput = document.getElementById('new-collection-name');
        const collectionListContainer = document.getElementById('collection-list');
        const collectionListLoader = document.getElementById('collection-list-loader');
        const collectionListEmpty = document.getElementById('collection-list-empty');
        const collectionDetailView = document.getElementById('collection-detail-view');
        const collectionsMainView = document.getElementById('collections-main-view');
        const collectionDetailTitle = document.getElementById('collection-detail-title');
        const collectionImageGrid = document.getElementById('collection-image-grid');
        const collectionImageLoader = document.getElementById('collection-image-loader');
        const collectionImageEmpty = document.getElementById('collection-image-empty');
        const backToCollectionsBtn = document.getElementById('back-to-collections-btn');
        const favoritesGrid = document.getElementById('favorites-grid');
        const favoritesLoader = document.getElementById('favorites-loader');
        const favoritesEmpty = document.getElementById('favorites-empty');
        const alertModal = document.getElementById('alert-modal');
        const alertModalBody = document.getElementById('alert-modal-body');
        const alertModalOk = document.getElementById('alert-modal-ok');
        const alertModalTitle = document.getElementById('alert-modal-title');
        const closeAlertModalBtn = document.querySelector('#alert-modal .custom-modal-close-btn');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalBody = document.getElementById('confirm-modal-body');
        const confirmModalCancel = document.getElementById('confirm-modal-cancel');
        const confirmModalOk = document.getElementById('confirm-modal-ok');
        const confirmModalTitle = document.getElementById('confirm-modal-title');
        const closeConfirmModalBtn = document.querySelector('#confirm-modal .custom-modal-close-btn');
        const lightboxModal = document.getElementById('lightbox-modal');
        const lightboxImage = document.getElementById('lightbox-image');
        const lightboxArtist = document.getElementById('lightbox-artist');
        const lightboxSource = document.getElementById('lightbox-source');
        const lightboxFavoriteBtn = document.getElementById('lightbox-favorite-btn');
        const lightboxAddCollectionBtn = document.getElementById('lightbox-add-collection-btn');
        const addToCollectionModal = document.getElementById('add-to-collection-modal');
        const closeAddToCollectionModalBtn = document.getElementById('close-add-to-collection-modal');
        const addToCollectionModalList = document.getElementById('add-to-collection-modal-list');
        const addCreateCollectionForm = document.getElementById('add-create-collection-form');
        const addNewCollectionNameInput = document.getElementById('add-new-collection-name');
        const addToCollectionEmpty = document.getElementById('add-to-collection-empty');
        const apiSelector = document.getElementById('api-selector');
        const clearHistoryBrowseBtn = document.getElementById('clear-history-browse-btn');
        const clearHistoryGachaBtn = document.getElementById('clear-history-gacha-btn');
        const clearFavoritesBtn = document.getElementById('clear-favorites-btn');
        const clearCollectionsBtn = document.getElementById('clear-collections-btn');
        const clearAllDataBtn = document.getElementById('clear-all-data-btn');
        const profileContentWrapper = document.getElementById('profile-content-wrapper');
        const socialContentWrapper = document.getElementById('social-content-wrapper');
        const socialTabFeed = document.getElementById('social-tab-feed');
        const socialTabUpload = document.getElementById('social-tab-upload');
        const socialTabChat = document.getElementById('social-tab-chat');
        const socialFeedContent = document.getElementById('social-feed-content');
        const socialUploadContent = document.getElementById('social-upload-content');
        const socialChatContent = document.getElementById('social-chat-content');
        const socialFeedGrid = document.getElementById('social-feed-grid');
        const socialFeedLoader = document.getElementById('social-feed-loader');
        const socialFeedEmpty = document.getElementById('social-feed-empty');
        const uploadPostForm = document.getElementById('upload-post-form');
        const uploadCaption = document.getElementById('upload-caption');
        const uploadImageFile = document.getElementById('upload-image-file');
        const fileUploadLabel = document.getElementById('file-upload-label');
        const fileUploadText = document.getElementById('file-upload-text');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const uploadPrivacy = document.getElementById('upload-privacy');
        const uploadSubmitBtn = document.getElementById('upload-submit-btn');
        const uploadBtnText = document.getElementById('upload-btn-text');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const feedbackModal = document.getElementById('feedback-modal');
        const feedbackButtonMobile = document.getElementById('feedback-button-mobile');
        const closeFeedbackModalButton = document.getElementById('close-feedback-modal');
        const feedbackForm = document.getElementById('feedback-form');
        const feedbackMessage = document.getElementById('feedback-message');
        const feedbackStatus = document.getElementById('feedback-status');
        const commentModal = document.getElementById('comment-modal');
        const closeCommentModalBtn = document.getElementById('close-comment-modal');
        const commentList = document.getElementById('comment-list');
        const commentForm = document.getElementById('comment-form');
        const commentInput = document.getElementById('comment-input');
        const postOptionsModal = document.getElementById('post-options-modal');
        const closePostOptionsModalBtn = document.getElementById('close-post-options-modal-btn');
        const postOptionsEditBtn = document.getElementById('post-options-edit-btn');
        const postOptionsDeleteBtn = document.getElementById('post-options-delete-btn');
        const editPostModal = document.getElementById('edit-post-modal');
        const closeEditPostModal = document.getElementById('close-edit-post-modal');
        const editPostForm = document.getElementById('edit-post-form');
        const editCaption = document.getElementById('edit-caption');
        const editPrivacy = document.getElementById('edit-privacy');
        const editPostCancelBtn = document.getElementById('edit-post-cancel-btn');
        const deletePostModal = document.getElementById('delete-post-modal');
        const closeDeletePostModalBtn = document.getElementById('close-delete-post-modal-btn');
        const deletePostForm = document.getElementById('delete-post-form');
        const deletePostCancelBtn = document.getElementById('delete-post-cancel-btn');
        const customDeleteReason = document.getElementById('custom-delete-reason');
        const chatLoader = document.getElementById('chat-loader'); 
        const chatMessages = document.getElementById('chat-messages'); 


        // --- Application State ---
        let historyBrowse = [];
        let historyGacha = [];
        let currentFavorites = [];
        let currentCollections = {};
        let currentApiId = 'nekos';
        let currentApiConf = API_CONFIG[currentApiId];
        let currentGalleryCategory = currentApiConf?.categories[0]?.endpoint || '';
        let isLoadingMore = false;
        let currentLightboxImageData = null;
        let pendingLightboxData = null;
        let isGachaRunning = false;
        let currentGachaResultData = null;
        let currentUser = null;
        let isInitialAuthCheckComplete = false;
        let chatUnsubscribe = null;
        let nekoTokens = 0;
        let userProfile = { username: null };
        let lastLoginDate = null;
        let currentPostIdForComments = null;
        let currentPostIdForAction = null;

        // --- Utility Functions ---
        function compressImage(file, maxDim, quality) { return new Promise((resolve, reject) => { const img = new Image(); const blobUrl = URL.createObjectURL(file); img.src = blobUrl; img.onload = () => { URL.revokeObjectURL(blobUrl); let { width, height } = img; if (width > height) { if (width > maxDim) { height = Math.round(height * (maxDim / width)); width = maxDim; } } else { if (height > maxDim) { width = Math.round(width * (maxDim / height)); height = maxDim; } } const canvas = document.createElement('canvas'); canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height); resolve(canvas.toDataURL('image/jpeg', quality)); }; img.onerror = (err) => { URL.revokeObjectURL(blobUrl); reject(err); }; }); }
        function imageToBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = (error) => reject(error); }); }
        function saveToLocalStorage(key, data) { try { localStorage.setItem(key, JSON.stringify(data)); } catch (e) { console.error("LS Save Error:", e); showToast("Aww~ Gagal simpan data lokalmu. Memorinya penuh ya?", "error"); } }
        function loadFromLocalStorage(key, defaultValue) { try { const data = localStorage.getItem(key); return data ? JSON.parse(data) : defaultValue; } catch (e) { console.error("LS Load Error:", e); localStorage.removeItem(key); return defaultValue; } }
        function saveState(stateKey, data) { const localStorageKeyMap = { favorites: 'nekonime_favorites_v9', collections: 'nekonime_collections_v9', historyBrowse: 'nekonime_history_browse_v9', historyGacha: 'nekonime_history_gacha_v9', nekoTokens: 'nekonime_tokens_v10', userProfile: 'nekonime_profile_v10', lastLoginDate: 'nekonime_last_login_v10', }; if (currentUser) { saveDataToFirestore({ [stateKey]: data }); } else { const localStorageKey = localStorageKeyMap[stateKey]; if (localStorageKey) { saveToLocalStorage(localStorageKey, data); } } }
        function clearAllStateVariables() { historyBrowse = []; historyGacha = []; currentFavorites = []; currentCollections = {}; nekoTokens = 0; userProfile = { username: null }; lastLoginDate = null; }
        function showLoader(el) { el?.classList.remove('hidden'); }
        function hideLoader(el) { el?.classList.add('hidden'); }
        function renderInfo(el, msg, makeVisible = true) { if (el) { el.innerHTML = msg; el.classList.toggle('hidden', !makeVisible); el.classList.toggle('visible', makeVisible); } }
        function hideInfo(el) { if (el) { el.classList.add('hidden'); el.classList.remove('visible'); el.innerHTML = ''; } }
        function escapeHTML(str) { if (!str) return ''; return str.toString().replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;'); }
        function showToast(message, type = 'info', duration = 3500) { if (!toastContainer) return; const toastId = `toast-${Date.now()}`; const toast = document.createElement('div'); toast.id = toastId; toast.className = `toast-item ${type}`; let icon = 'info'; let uwuPrefix = ''; if (type === 'success') { icon = 'check-circle'; uwuPrefix = 'Yatta! 🎉 '; } else if (type === 'error') { icon = 'alert-circle'; uwuPrefix = 'Aduuh! Σ(°ロ°) '; } else { uwuPrefix = 'Pssst! 🤫 '; } toast.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5"></i><span>${uwuPrefix}${message}</span>`; toastContainer.appendChild(toast); lucide.createIcons({ nodes: [toast.querySelector('i')] }); requestAnimationFrame(() => { toast.classList.add('show'); }); setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => { toast.remove(); }, { once: true }); }, duration); }
        function showAlert(message, title = "Info Penting! ✨") { alertModalTitle.innerHTML = title; alertModalBody.textContent = message; alertModal.classList.add('visible'); return new Promise(resolve => { alertModalOk.addEventListener('click', () => { alertModal.classList.remove('visible'); resolve(); }, { once: true }); }); }
        function showConfirm(message, title = "Konfirmasi Dulu Dong~ 🤔") { confirmModalTitle.innerHTML = title; confirmModalBody.textContent = message; confirmModal.classList.add('visible'); return new Promise((resolve) => { const okHandler = () => { confirmModal.classList.remove('visible'); resolve(true); }; const cancelHandler = () => { confirmModal.classList.remove('visible'); resolve(false); }; confirmModalOk.addEventListener('click', okHandler, { once: true }); confirmModalCancel.addEventListener('click', cancelHandler, { once: true }); }); }
        function isToday(dateString) { if (!dateString) return false; const date = new Date(dateString); const today = new Date(); return date.getFullYear() === today.getFullYear() && date.getMonth() === today.getMonth() && date.getDate() === today.getDate(); }

        // --- Navigation & Page Handling ---
        function updateHeaderTitle(pageId) { const pageTitles = { gallery: "Galeri Moe~", "random-girl": "Gacha Universal ♡", favorites: "Favorit Kesayangan 💖", history: "History Petualanganmu 📜", collections: "Koleksi Pribadimu 📚", social: "NekoVerse Social 🌐", profile: "Profil Manismu ✨", about: "Tentang NekoNime Uwu~", settings: "Setelan Manja ✨" }; const title = pageTitles[pageId] || "NekoNime"; const baseTitle = "NekoNime"; const version = "v10.0.8"; if (headerTitle) { const isGallery = pageId === 'gallery'; headerTitle.innerHTML = isGallery ? `<a href="#gallery">${baseTitle} <span class='text-sm align-super uwu-text'> uwu~</span></a>` : escapeHTML(title); } document.title = `${baseTitle} ${version} - ${title}`; }
        function showPage(pageId) { console.log(`Pindah ke halaman: ${pageId} ♡`); if (chatUnsubscribe) { chatUnsubscribe(); chatUnsubscribe = null; } pages.forEach(page => page.classList.add('hidden')); const activePage = document.getElementById(`page-${pageId}`); if (activePage) { activePage.classList.remove('hidden'); mainContentArea.scrollTop = 0; const isGalleryPage = pageId === 'gallery'; loadMoreContainer?.classList.toggle('hidden', !isGalleryPage); if (isGalleryPage) { currentApiConf = API_CONFIG[currentApiId]; if (!currentApiConf?.categories?.some(c => c.endpoint === currentGalleryCategory)) { currentGalleryCategory = currentApiConf?.categories?.[0]?.endpoint || ''; } renderCategorySelectors(); if (!galleryGrid.dataset.loadedCategory || galleryGrid.dataset.loadedCategory !== currentGalleryCategory || galleryGrid.children.length === 0) { loadGallery(currentGalleryCategory, true); } } else if (pageId === 'history') { loadHistoryPage(); } else if (pageId === 'favorites') { loadFavorites(); } else if (pageId === 'collections') { loadCollectionsPage(); } else if (pageId === 'profile') { loadProfilePage(); } else if (pageId === 'social') { loadSocialPage(); } else if (pageId === 'random-girl') { currentApiConf = API_CONFIG[currentApiId]; gachaApiNameSpan.textContent = currentApiConf?.name || 'Tidak Diketahui'; updateGachaButtonUI(); } else if (pageId === 'settings') { populateApiSelector(); } } else { console.warn(`Halaman ${pageId} nggak ketemu! Balik ke galeri ya~`); window.location.hash = '#gallery'; return; } document.querySelectorAll('.nav-link').forEach(link => { link.classList.toggle('active', link.dataset.page === pageId); }); updateHeaderTitle(pageId); closeMobileNav(); }
        function handleHashChange() { const hash = window.location.hash.substring(1); const pageId = hash || 'gallery'; showPage(pageId); }
        function openMobileNav() { mobileNavOverlay?.classList.add('visible'); }
        function closeMobileNav() { mobileNavOverlay?.classList.remove('visible'); }

        // --- Neko Token System ---
        function updateNekoTokens(amount, reason) { if (amount === 0) return; nekoTokens += amount; if (nekoTokens < 0) nekoTokens = 0; saveState('nekoTokens', nekoTokens); updateTokenUI(); if (amount > 0) { const reasonText = reason ? `(${reason})` : ''; showToast(`+${amount} Neko Token! ${reasonText}`, 'success', 2500); const tokenDisplay = document.querySelector('#neko-token-display'); if (tokenDisplay) { tokenDisplay.classList.remove('animate-gain'); void tokenDisplay.offsetWidth; tokenDisplay.classList.add('animate-gain'); } } updateGachaButtonUI(); }
        function updateTokenUI() { const tokenDisplays = document.querySelectorAll('.neko-token-count'); tokenDisplays.forEach(el => el.textContent = Math.floor(nekoTokens)); }
        function checkDailyLogin() { if (isToday(lastLoginDate)) { console.log("Daily login bonus already claimed today."); return; } updateNekoTokens(20, 'Bonus Login Harian'); lastLoginDate = new Date().toISOString(); saveState('lastLoginDate', lastLoginDate); }

        // --- API Fetching ---
        async function fetchApiData(endpoint, count = 1) { currentApiConf = API_CONFIG[currentApiId]; if (!currentApiConf) { return { data: [], errorCount: count, error: "Konfigurasi API-nya ilang nih T_T." }; } const safeEndpoint = endpoint || currentApiConf.defaultGachaCategory || API_CONFIG.nekos.defaultGachaCategory; const promises = []; for (let i = 0; i < count; i++) { const url = `${currentApiConf.baseUrl}${safeEndpoint}`; const controller = new AbortController(); const timeoutId = setTimeout(() => controller.abort(), FETCH_TIMEOUT); promises.push(fetch(url, { signal: controller.signal, cache: 'no-cache' }).then(async response => { clearTimeout(timeoutId); if (!response.ok) { return null; } const contentType = response.headers.get("content-type"); if (!contentType || !contentType.includes("application/json")) { return null; } return currentApiConf.parser(await response.json()); }).catch(error => { clearTimeout(timeoutId); return null; })); } try { const results = await Promise.all(promises); const validResults = results.filter(r => r?.url); const errorCount = results.length - validResults.length; const uniqueResults = Array.from(new Map(validResults.map(item => [item.url, item])).values()); return { data: uniqueResults, errorCount: errorCount }; } catch (e) { return { data: [], errorCount: count, error: "Aww, gagal proses hasil API-nya." }; } }

        // --- Gallery Functions ---
        function createImageCard(imageData, sourceContext = 'gallery') { const imageUrl = imageData.url; const artistName = imageData.artist_name || 'Artisnya Misterius~ 🤫'; const sourceUrl = imageData.source_url || imageUrl; const imageId = imageUrl; const isFavorite = isFavoriteCheck(imageUrl); const isInCollection = isImageInAnyCollection(imageUrl); const apiSource = imageData.apiSource || 'unknown'; const safeImageUrl = escapeHTML(imageUrl); const safeArtistName = escapeHTML(artistName); const safeSourceUrl = escapeHTML(sourceUrl); const dataForJson = { url: imageUrl, artist_name: artistName, source_url: sourceUrl, apiSource: apiSource }; const imageDataStringEscaped = escapeHTML(JSON.stringify(dataForJson)); const showRemoveButton = ['history_browse', 'history_gacha', 'favorites'].includes(sourceContext) || sourceContext.startsWith('collection_'); let removeButtonTitle = 'Hapus?'; if (sourceContext.startsWith('collection_')) removeButtonTitle = 'Keluarkan dari Koleksi Ini'; else if (sourceContext === 'favorites') removeButtonTitle = 'Hapus dari Favorit Kesayangan'; else if (sourceContext.startsWith('history_')) removeButtonTitle = 'Hapus dari Jejak History'; return `<div class="image-card group" data-url="${safeImageUrl}" data-artist="${escapeHTML(encodeURIComponent(artistName))}" data-source-url="${safeSourceUrl}" data-id="${imageId}" data-source-api="${escapeHTML(apiSource)}" title="Art oleh ${safeArtistName}. Klik buat intip & dapat token!"><img src="${safeImageUrl}" alt="Ilustrasi anime oleh ${safeArtistName}" class="w-full h-auto object-cover block bg-black/20" loading="lazy" decoding="async" onerror="this.closest('.image-card')?.remove();"><div class="card-overlay"><button class="add-to-collection-card-btn card-button ${isInCollection ? 'in-collection' : ''}" title="${isInCollection ? 'Udah ada di Koleksi!' : 'Tambah ke Koleksi (+15 Token)!'}" onclick="event.stopPropagation(); window.handleAddToCollectionClick(this.dataset.image);" data-image='${imageDataStringEscaped}'><i data-lucide="${isInCollection ? 'folder-check' : 'plus-square'}"></i></button><button class="favorite-btn card-button ${isFavorite ? 'active' : ''}" data-image='${imageDataStringEscaped}' title="${isFavorite ? 'Batalin Favorit?' : 'Jadikan Favorit (+10 Token)! ♡'}" onclick="event.stopPropagation(); window.toggleFavorite(this);"><i data-lucide="heart" style="fill: ${isFavorite ? 'currentColor' : 'none'}"></i></button></div>${showRemoveButton ? `<button class="remove-item-btn" data-id="${imageId}" data-source="${sourceContext}" title="${removeButtonTitle}" onclick="event.stopPropagation(); window.handleRemoveItem(this, '${sourceContext}');"><i data-lucide="x"></i></button>` : ''}</div>`; }
        async function loadGallery(category, replace = false) { if (isLoadingMore) return; isLoadingMore = true; showLoader(galleryLoader); hideInfo(galleryError); loadMoreBtn.disabled = true; loadMoreBtn.classList.add('loading'); if (replace) { galleryGrid.innerHTML = ''; mainContentArea.scrollTop = 0; galleryGrid.dataset.loadedCategory = category; } try { const { data: images, errorCount } = await fetchApiData(category, GALLERY_IMAGES_PER_LOAD); if (images.length > 0) { let htmlFragment = ''; images.forEach(img => { htmlFragment += createImageCard(img, 'gallery'); addToHistory(img, 'browse'); }); galleryGrid.insertAdjacentHTML('beforeend', htmlFragment); lucide.createIcons({ nodes: galleryGrid.querySelectorAll('[data-lucide]') }); } else if (galleryGrid.children.length === 0) { renderInfo(galleryError, "Yah, nggak nemu gambar buat kategori ini... (´。＿。｀)"); } } catch (e) { renderInfo(galleryError, `Waduh, ada error: ${e.message}`); } finally { isLoadingMore = false; hideLoader(galleryLoader); loadMoreBtn.disabled = false; loadMoreBtn.classList.remove('loading'); } }
        function renderCategorySelectors() { if (!categorySelectorContainer) return; categorySelectorContainer.innerHTML = ''; currentApiConf = API_CONFIG[currentApiId]; const displayCategories = currentApiConf?.categories; if (!displayCategories || displayCategories.length === 0) { categorySelectorContainer.innerHTML = '<p class="text-sm text-gray-500 uwu-text">Yah, kategori buat API ini nggak ada T_T</p>'; if (galleryGrid.children.length === 0) { renderInfo(galleryError, "Gagal muat kategori untuk API ini."); } loadMoreContainer?.classList.remove('hidden'); if (loadMoreBtn) { loadMoreBtn.disabled = true; } return; } if (!currentGalleryCategory || !displayCategories.some(c => c.endpoint === currentGalleryCategory)) { currentGalleryCategory = displayCategories[0]?.endpoint || ''; } displayCategories.forEach(cat => { if (!cat || !cat.endpoint || !cat.name) return; const btn = document.createElement('button'); btn.className = 'category-btn'; btn.dataset.endpoint = cat.endpoint; btn.textContent = cat.name; btn.classList.toggle('active', cat.endpoint === currentGalleryCategory); btn.addEventListener('click', () => { if (!isLoadingMore && currentGalleryCategory !== cat.endpoint) { currentGalleryCategory = cat.endpoint; document.querySelectorAll('#category-selector-container .category-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); loadGallery(currentGalleryCategory, true); } else if (isLoadingMore) { showToast("Sabar dong~ Lagi ngambil gambar nih...", "info"); } }); categorySelectorContainer.appendChild(btn); }); }

        // --- History, Favorites, Collections Functions ---
        function addToHistory(imageData, type = 'browse') { if (!imageData?.url) return; const item = { url: imageData.url, artist_name: imageData.artist_name || 'Artisnya Misterius~ 🤫', source_url: imageData.source_url || imageData.url, timestamp: Date.now(), apiSource: imageData.apiSource || 'unknown' }; let history = (type === 'gacha') ? historyGacha : historyBrowse; history = history.filter(i => i?.url !== item.url); history.unshift(item); if (history.length > HISTORY_MAX_ITEMS) { history = history.slice(0, HISTORY_MAX_ITEMS); } if (type === 'gacha') { historyGacha = history; saveState('historyGacha', historyGacha); } else { historyBrowse = history; saveState('historyBrowse', historyBrowse); } }
        function toggleFavoriteDirect(data, makeFav) { const url = data.url; if (!url) return; const isAlreadyFav = isFavoriteCheck(url); if (makeFav && !isAlreadyFav) { const item = { url: url, artist_name: data.artist_name || 'Artisnya Misterius~ 🤫', source_url: data.source_url || url, apiSource: data.apiSource || 'unknown' }; currentFavorites.unshift(item); updateNekoTokens(10, "Favoritkan Gambar"); } else if (!makeFav && isAlreadyFav) { currentFavorites = currentFavorites.filter(i => i?.url !== url); } saveState('favorites', currentFavorites); updateFavoriteStatusUI(url, makeFav); if (window.location.hash === '#favorites' && !makeFav) { loadFavorites(); } }
        async function createCollection(name, dataToAdd = null) { const trimmed = name.trim(); if (!trimmed) { await showToast("Nama koleksinya nggak boleh kosong dong~", "error"); return { success: false, name: null }; } if (currentCollections[trimmed]) { await showToast(`Koleksi "${escapeHTML(trimmed)}" udah ada, <span class="uwu-text">Sayang</span>. Pilih nama lain ya~`, "error"); return { success: false, name: trimmed }; } currentCollections[trimmed] = []; updateNekoTokens(15, "Buat Koleksi Baru"); let msg = `Koleksi baru "${escapeHTML(trimmed)}" berhasil dibuat! Yeay! 🎉`; if (dataToAdd && dataToAdd.url) { if (!currentCollections[trimmed].some(i => i.url === dataToAdd.url)) { currentCollections[trimmed].unshift({ url: dataToAdd.url, artist_name: dataToAdd.artist_name || 'Artisnya Misterius~ 🤫', source_url: dataToAdd.source_url || dataToAdd.url, apiSource: dataToAdd.apiSource || 'unknown' }); msg = `Koleksi "${escapeHTML(trimmed)}" dibuat & gambar <span class="uwu-text">manis</span> ini ditambah! ♡`; updateNekoTokens(15, "Tambah ke Koleksi"); } } saveCollections(); await showToast(msg, "success"); return { success: true, name: trimmed }; }
        async function addImageToCollection(name) { const data = pendingLightboxData; if (!data || !data.url || !name || !currentCollections[name]) { await showAlert("Gagal nambahin ke koleksi nih, datanya aneh.", "Error"); closeAddToCollectionModal(true); return; } if (currentCollections[name].some(i => i.url === data.url)) { await showToast(`Eh, udah ada di "${escapeHTML(name)}" ternyata! 😉`, "info"); closeAddToCollectionModal(true); return; } currentCollections[name].unshift({ url: data.url, artist_name: data.artist_name || 'Artisnya Misterius~ 🤫', source_url: data.source_url || data.url, apiSource: data.apiSource || 'unknown' }); updateNekoTokens(15, "Tambah ke Koleksi"); saveCollections(); updateCollectionButtonStatus(data.url, true); closeAddToCollectionModal(true); await showToast(`Berhasil ditambah ke koleksi "${escapeHTML(name)}"! Mantap! 👍`, "success"); if (!collectionDetailView.classList.contains('hidden') && collectionDetailTitle.textContent === `Isi Koleksi: ${escapeHTML(name)}`) { loadCollectionImages(name); } if (!collectionsMainView.classList.contains('hidden')) { loadCollectionsList(); } }
        function loadItems(grid, loader, emptyElement, data, context) { if (!grid || !loader || !emptyElement) return; showLoader(loader); grid.innerHTML = ''; hideInfo(emptyElement); if (!data || data.length === 0) { const emptyMessage = emptyElement.dataset.emptyMessage || "Di sini kosong..."; renderInfo(emptyElement, emptyMessage); } else { let htmlFragment = ''; data.forEach(d => { if (d?.url) { htmlFragment += createImageCard(d, context); } }); grid.insertAdjacentHTML('beforeend', htmlFragment); lucide.createIcons({ nodes: grid.querySelectorAll('[data-lucide]') }); } hideLoader(loader); }
        function loadFavorites() { loadItems(favoritesGrid, favoritesLoader, favoritesEmpty, currentFavorites, 'favorites'); }
        function loadBrowseHistory() { loadItems(historyBrowseGrid, historyBrowseLoader, historyBrowseEmpty, historyBrowse, 'history_browse'); }
        function loadGachaHistory() { loadItems(historyGachaGrid, historyGachaLoader, historyGachaEmpty, historyGacha, 'history_gacha'); }
        function loadHistoryPage() { switchHistoryTab('browse'); loadBrowseHistory(); loadGachaHistory(); }
        function switchHistoryTab(tab) { document.querySelectorAll('#page-history .tab-btn').forEach(b => b.classList.remove('active')); document.querySelectorAll('.history-content').forEach(c => c.classList.add('hidden')); if (tab === 'browse') { historyTabBrowse?.classList.add('active'); historyBrowseContent?.classList.remove('hidden'); } else if (tab === 'gacha') { historyTabGacha?.classList.add('active'); historyGachaContent?.classList.remove('hidden'); } mainContentArea.scrollTop = 0; }
        function saveCollections() { saveState('collections', currentCollections); }
        function loadCollectionsList() { showLoader(collectionListLoader); collectionListContainer.innerHTML = ''; hideInfo(collectionListEmpty); const names = Object.keys(currentCollections); if (names.length === 0) { renderInfo(collectionListEmpty, collectionListEmpty.dataset.emptyMessage || "Kamu belum punya koleksi..."); } else { names.sort((a, b) => a.localeCompare(b)).forEach(name => { const count = currentCollections[name]?.length || 0; const li = document.createElement('div'); li.className = 'collection-list-item group'; const escapedName = escapeHTML(name); li.innerHTML = `<div class="collection-name-wrapper" onclick="window.showCollectionDetail('${escapedName}')" title="Lihat isi koleksi '${escapedName}'"><span class="collection-name">${escapedName}</span></div><span class="collection-count">${count} item${count !== 1 ? 's' : ''}</span><button class="collection-delete-btn" data-name="${escapedName}" title="Hapus Koleksi '${escapedName}'? (Hati-hati!)"><i data-lucide="trash-2"></i></button>`; li.querySelector('.collection-delete-btn').addEventListener('click', (e) => { e.stopPropagation(); deleteCollection(name); }); collectionListContainer.appendChild(li); }); lucide.createIcons({ nodes: collectionListContainer.querySelectorAll('[data-lucide]') }); } hideLoader(collectionListLoader); }
        async function deleteCollection(name) { const confirm = await showConfirm(`Yakin mau hapus koleksi "${escapeHTML(name)}"? Ini akan dihapus dari data ${currentUser ? 'cloud' : 'lokal'} kamu.`, "Hapus Koleksi?"); if (confirm) { delete currentCollections[name]; saveCollections(); loadCollectionsList(); updateAllCollectionButtonsState(); await showToast(`Koleksi "${escapeHTML(name)}" sudah dihapus... Bye bye~ 👋`, "info"); } }
        function loadCollectionsPage() { showCollectionView('main'); loadCollectionsList(); }
        function showCollectionView(view) { collectionsMainView?.classList.toggle('hidden', view === 'detail'); collectionDetailView?.classList.toggle('hidden', view !== 'detail'); mainContentArea.scrollTop = 0; }
        function showCollectionDetail(name) { if (!currentCollections[name]) { showToast("Aww, koleksi itu nggak ketemu.", "error"); showCollectionView('main'); return; } showCollectionView('detail'); collectionDetailTitle.textContent = `Isi Koleksi: ${escapeHTML(name)}`; loadCollectionImages(name); }
        function loadCollectionImages(name) { const images = currentCollections[name] || []; loadItems(collectionImageGrid, collectionImageLoader, collectionImageEmpty, images, `collection_${name}`); }
        function isImageInAnyCollection(url) { if (!url) return false; return Object.values(currentCollections).some(coll => coll?.some(img => img?.url === url)); }

        // --- Gacha Functions ---
        function updateGachaButtonUI() { if (!gachaButton) return; if (nekoTokens >= GACHA_COST) { gachaButton.disabled = false; gachaButtonText.innerHTML = `Gacha Sekarang! <span class="gacha-cost">(${GACHA_COST} Token)</span>`; } else { gachaButton.disabled = true; gachaButtonText.innerHTML = `Butuh ${GACHA_COST} Token...`; } }
        function resetGachaDisplay() { gachaImageWrapper.classList.add('hidden', 'opacity-0'); gachaResultImage.src = ""; gachaResultImage.onload = null; gachaResultImage.onerror = null; hideInfo(gachaErrorMsg); gachaPlaceholder.classList.remove('hidden'); gachaAnimationContainer.classList.remove('visible'); gachaAnimationContainer.innerHTML = ''; gachaResetButton.classList.add('hidden'); currentGachaResultData = null; }
        function triggerGachaAnimation() { gachaAnimationContainer.innerHTML = ''; for (let i = 0; i < 3; i++) { const card = document.createElement('div'); card.className = 'gacha-spinner-card'; card.style.animationDelay = `${i * GACHA_ANIMATION_STAGGER_DELAY}ms`; gachaAnimationContainer.appendChild(card); } gachaAnimationContainer.classList.add('visible'); }
        async function performGacha() { if (isGachaRunning) { showToast("Sabar dulu yaa~ Gachanya lagi muter nih!", "info"); return; } if (nekoTokens < GACHA_COST) { showToast(`Aww, token-mu kurang! Butuh ${GACHA_COST} untuk Gacha.`, 'error'); return; } isGachaRunning = true; gachaButton.disabled = true; resetGachaDisplay(); updateNekoTokens(-GACHA_COST, "Gacha Pull"); gachaPlaceholder.classList.add('hidden'); triggerGachaAnimation(); currentApiConf = API_CONFIG[currentApiId]; const availableEndpoints = currentApiConf?.allEndpoints || currentApiConf?.categories?.map(c => c.endpoint); if (!availableEndpoints || availableEndpoints.length === 0) { renderInfo(gachaErrorMsg, `Waduh, nggak ada kategori buat Gacha di API ${currentApiConf?.name || 'ini'} T_T`, true); gachaAnimationContainer.classList.remove('visible'); gachaPlaceholder.classList.remove('hidden'); isGachaRunning = false; updateGachaButtonUI(); updateNekoTokens(GACHA_COST, "Refund Gacha Error"); return; } const randomEndpoint = availableEndpoints[Math.floor(Math.random() * availableEndpoints.length)]; try { const { data: images } = await fetchApiData(randomEndpoint, 1); if (!images || images.length === 0 || !images[0]?.url) { throw new Error(`Gagal dapet gambar dari kategori acak <span class='uwu-text'>(${escapeHTML(randomEndpoint)})</span>. Coba lagi yuk?`); } const gachaData = images[0]; addToHistory(gachaData, 'gacha'); const imgPreload = new Image(); imgPreload.onload = () => { setTimeout(() => { gachaResultImage.src = gachaData.url; currentGachaResultData = gachaData; gachaAnimationContainer.classList.remove('visible'); gachaImageWrapper.classList.remove('hidden'); requestAnimationFrame(() => gachaImageWrapper.classList.remove('opacity-0')); gachaResetButton.classList.remove('hidden'); hideInfo(gachaErrorMsg); showToast("Dapet ini! Semoga suka yaa~ ♡", "success", 4500); isGachaRunning = false; updateGachaButtonUI(); }, GACHA_ANIMATION_BASE_DURATION - 200); }; imgPreload.onerror = () => { throw new Error("Yah, gambarnya gagal dimuat... (｡•́︿•̀｡) Coba Gacha lagi?"); }; imgPreload.src = gachaData.url; } catch (error) { gachaAnimationContainer.classList.remove('visible'); renderInfo(gachaErrorMsg, error.message || "Aduuh, Gachanya lagi ngambek nih...", true); gachaPlaceholder.classList.remove('hidden'); isGachaRunning = false; updateGachaButtonUI(); updateNekoTokens(GACHA_COST, "Refund Gacha Error"); } }

        // --- Profile Page Functions ---
        function loadProfilePage() { if (!currentUser) { profileContentWrapper.innerHTML = ` <div class="text-center glassmorphism p-8 rounded-xl"> <i data-lucide="log-in" class="w-12 h-12 mx-auto text-purple-400 mb-4"></i> <h3 class="text-xl font-semibold mb-2">Login Dulu Yuk!</h3> <p class="text-gray-400 mb-4">Kamu harus login untuk melihat profil, mengatur username, dan melihat statistik kerenmu!</p> <button onclick="window.loginWithGoogle()" class="nav-link login-btn mx-auto"><i data-lucide="log-in"></i> Login dengan Google</button> </div>`; lucide.createIcons(); return; } const username = userProfile?.username || currentUser.displayName; const email = currentUser.email; profileContentWrapper.innerHTML = ` <div class="profile-card"> <img src="${escapeHTML(currentUser.photoURL || '')}" alt="Foto Profil"> <h3 class="profile-username">${escapeHTML(username)}</h3> <p class="profile-email">${escapeHTML(email)}</p> <div class="profile-stats-grid"> <div class="stat-item"> <div class="stat-value text-yellow-300 neko-token-count">${Math.floor(nekoTokens)}</div> <div class="stat-label">Neko Token</div> </div> <div class="stat-item"> <div class="stat-value text-red-400">${currentFavorites.length}</div> <div class="stat-label">Favorit</div> </div> <div class="stat-item"> <div class="stat-value text-blue-400">${Object.keys(currentCollections).length}</div> <div class="stat-label">Koleksi</div> </div> <div class="stat-item"> <div class="stat-value text-green-400">${historyBrowse.length + historyGacha.length}</div> <div class="stat-label">Jejak History</div> </div> </div> </div> <div class="glassmorphism p-6 rounded-xl"> <h4 class="text-lg font-semibold mb-3 uwu-text">Atur Username Manismu</h4> <form id="profile-username-form" class="flex gap-2"> <input type="text" id="profile-username-input" placeholder="Username baru..." required class="flex-grow p-2.5 rounded-lg bg-black/30 border border-white/10 focus:outline-none focus:ring-2 focus:ring-[var(--accent-magenta)] text-gray-200 placeholder-gray-500" value="${escapeHTML(userProfile?.username || '')}"> <button type="submit" class="modal-button modal-button-primary !px-4"><i data-lucide="save"></i> Simpan</button> </form> </div> `; document.getElementById('profile-username-form').addEventListener('submit', handleUsernameUpdate); lucide.createIcons(); }
        async function handleUsernameUpdate(e) { e.preventDefault(); const newUsername = document.getElementById('profile-username-input').value.trim(); if (newUsername.length < 3) { showToast("Username harus minimal 3 karakter yaa~", "error"); return; } userProfile.username = newUsername; saveState('userProfile', userProfile); updateAuthUI(currentUser); loadProfilePage(); showToast("Username berhasil diperbarui! Keren! ✨", "success"); }

        // --- Social Page Functions ---
        function loadSocialPage() { if (!currentUser) { socialContentWrapper.innerHTML = ` <div class="text-center glassmorphism p-8 rounded-xl max-w-lg mx-auto"> <i data-lucide="log-in" class="w-12 h-12 mx-auto text-cyan-400 mb-4"></i> <h3 class="text-xl font-semibold mb-2">Login untuk Masuk NekoVerse!</h3> <p class="text-gray-400 mb-4">Fitur sosial cuma buat anggota terdaftar. Yuk, gabung komunitasnya!</p> <button onclick="window.loginWithGoogle()" class="nav-link login-btn mx-auto"><i data-lucide="log-in"></i> Login dengan Google</button> </div>`; lucide.createIcons(); return; } if (!document.getElementById('social-tab-feed')) { setTimeout(() => showPage('social'), 50); return; } switchSocialTab('feed'); }
        function switchSocialTab(tab) { document.querySelectorAll('#social-content-wrapper .tab-btn').forEach(b => b.classList.remove('active')); document.querySelectorAll('.social-content').forEach(c => c.classList.add('hidden')); if (chatUnsubscribe) { chatUnsubscribe(); chatUnsubscribe = null; } if (tab === 'feed') { socialTabFeed?.classList.add('active'); socialFeedContent?.classList.remove('hidden'); loadSocialFeed(); } else if (tab === 'upload') { socialTabUpload?.classList.add('active'); socialUploadContent?.classList.remove('hidden'); } else if (tab === 'chat') { socialTabChat?.classList.add('active'); socialChatContent?.classList.remove('hidden'); setupChatListener(); } mainContentArea.scrollTop = 0; }
        async function loadSocialFeed() { showLoader(socialFeedLoader); socialFeedGrid.innerHTML = ''; hideInfo(socialFeedEmpty); try { const postsRef = collection(db, "user_posts"); const q = query(postsRef, where("privacy", "==", "public"), orderBy("createdAt", "desc"), limit(20)); const querySnapshot = await getDocs(q); if (querySnapshot.empty) { renderInfo(socialFeedEmpty, socialFeedEmpty.dataset.emptyMessage || "Feed masih sepi..."); } else { let feedHtml = ''; querySnapshot.forEach(doc => { feedHtml += createPostCard(doc.id, doc.data()); }); socialFeedGrid.innerHTML = feedHtml; lucide.createIcons({ nodes: socialFeedGrid.querySelectorAll('[data-lucide]') }); } } catch (error) { console.error("Error loading social feed:", error); renderInfo(socialFeedEmpty, "Aduh, gagal memuat feed... Coba lagi nanti ya."); } finally { hideLoader(socialFeedLoader); } }
        function createPostCard(id, data) {
            const authorName = data.authorUsername || 'User Misterius';
            const timestamp = data.createdAt?.toDate().toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' }) || '';
            const imageSource = data.imageData;
            if (!imageSource) return '';

            const isLiked = currentUser && Array.isArray(data.likers) && data.likers.includes(currentUser.uid);
            const likesCount = data.likesCount || 0;
            const commentsCount = data.commentsCount || 0;
            const isAuthor = currentUser && currentUser.uid === data.authorId;

            const lightboxData = { url: imageSource, artist_name: `Diposting oleh ${escapeHTML(authorName)}`, source_url: '#' };
            const lightboxDataString = escapeHTML(JSON.stringify(lightboxData));

            return `
                <div class="social-post-card" data-post-id="${id}">
                    <div class="post-header">
                        <img src="${escapeHTML(data.authorPhotoURL || 'https://i.pravatar.cc/150')}" alt="Author" class="post-author-img">
                        <div class="post-author-info">
                            <div class="post-author-name">${escapeHTML(authorName)}</div>
                            <div class="post-timestamp">${timestamp}</div>
                        </div>
                        ${isAuthor ? `
                        <button class="post-options-btn" onclick="window.togglePostOptions(event, '${id}')" title="Opsi Postingan">
                            <i data-lucide="more-horizontal"></i>
                        </button>` : ''}
                    </div>
                    <img src="${escapeHTML(imageSource)}" alt="Post Image" class="post-image" onclick='window.openLightbox(${lightboxDataString})'>
                    ${data.caption ? `<p class="post-caption">${escapeHTML(data.caption)}</p>` : ''}
                    <div class="post-actions">
                         <button class="post-action-btn like-btn ${isLiked ? 'liked' : ''}" onclick="window.handleLikeClick('${id}', this)">
                            <i data-lucide="heart" class="w-5 h-5" style="fill: ${isLiked ? 'currentColor' : 'none'}"></i>
                            <span>Suka (<span class="like-count">${likesCount}</span>)</span>
                         </button>
                         <button class="post-action-btn" onclick="window.openCommentsModal('${id}')">
                            <i data-lucide="message-circle" class="w-5 h-5"></i>
                            <span>Komen (<span class="comment-count">${commentsCount}</span>)</span>
                         </button>
                         <button class="post-action-btn" onclick="window.handleShareClick('${id}')">
                            <i data-lucide="share-2" class="w-5 h-5"></i>
                            <span>Bagikan</span>
                         </button>
                    </div>
                </div>`;
        }
        async function togglePostOptions(event, postId) { event.stopPropagation(); if (!currentUser) return; try { const postRef = doc(db, "user_posts", postId); const postSnap = await getDoc(postRef); if (postSnap.exists() && postSnap.data().authorId === currentUser.uid) { currentPostIdForAction = postId; postOptionsModal.classList.add('visible'); } else { showToast("Kamu bukan pemilik postingan ini!", "error"); } } catch (e) { showToast("Gagal mengambil data postingan.", "error"); console.error("Error fetching post for options:", e); } }
        async function handleImageUpload(e) { e.preventDefault(); if (!currentUser) { showToast("Harus login dulu untuk posting!", "error"); return; } const caption = uploadCaption.value.trim(); const file = uploadImageFile.files[0]; const privacy = uploadPrivacy.value; if (!file) { showToast("Gambar tidak boleh kosong ya~", "error"); return; } if (file.size > ABSOLUTE_MAX_SIZE) { showToast(`Maaf, file terlalu besar (> ${ABSOLUTE_MAX_SIZE / 1024 / 1024}MB) untuk diproses.`, "error"); return; } uploadSubmitBtn.disabled = true; uploadBtnText.innerHTML = '<div class="loader !w-5 !h-5 !border-2 !m-0"></div>'; try { let base64Image; if (file.size > COMPRESSION_THRESHOLD) { showToast("Gambar terlalu besar, sedang dikompres...", "info"); uploadBtnText.textContent = 'Mengompres...'; base64Image = await compressImage(file, COMPRESSION_MAX_DIMENSION, COMPRESSION_QUALITY); } else { base64Image = await imageToBase64(file); } uploadBtnText.textContent = 'Mengupload...'; await addDoc(collection(db, "user_posts"), { authorId: currentUser.uid, authorUsername: userProfile.username || currentUser.displayName, authorPhotoURL: currentUser.photoURL, caption: caption, imageData: base64Image, privacy: privacy, likesCount: 0, commentsCount: 0, likers: [], createdAt: serverTimestamp() }); showToast("Postingan berhasil diunggah! Yatta!", "success"); uploadPostForm.reset(); imagePreviewContainer.classList.add('hidden'); imagePreview.src = '#'; fileUploadText.textContent = "Klik atau seret gambar kesini (Wajib)"; switchSocialTab('feed'); } catch (error) { console.error("Error uploading post: ", error); showToast("Aduh, gagal mengunggah postingan.", "error"); } finally { uploadSubmitBtn.disabled = false; uploadBtnText.textContent = 'Posting Sekarang!'; } }
        async function handleLikeClick(postId, button) { if (!currentUser) { showToast("Login dulu untuk suka postingan!", "error"); return; } const postRef = doc(db, "user_posts", postId); button.disabled = true; try { await runTransaction(db, async (transaction) => { const postDoc = await transaction.get(postRef); if (!postDoc.exists()) { throw "Postingan ini sudah tidak ada!"; } const postData = postDoc.data(); const likers = Array.isArray(postData?.likers) ? postData.likers : []; const isLiked = likers.includes(currentUser.uid); if (isLiked) { transaction.update(postRef, { likers: arrayRemove(currentUser.uid), likesCount: increment(-1) }); } else { transaction.update(postRef, { likers: arrayUnion(currentUser.uid), likesCount: increment(1) }); } }); const postCard = document.querySelector(`.social-post-card[data-post-id="${postId}"]`); if (postCard) { const likeBtn = postCard.querySelector('.like-btn'); const likeCountSpan = postCard.querySelector('.like-count'); const isNowLiked = !likeBtn.classList.contains('liked'); let currentCount = parseInt(likeCountSpan.textContent, 10); if (isNaN(currentCount)) currentCount = 0; likeBtn.classList.toggle('liked', isNowLiked); const icon = likeBtn.querySelector('i'); if (icon) { icon.style.fill = isNowLiked ? 'currentColor' : 'none'; } likeCountSpan.textContent = isNowLiked ? currentCount + 1 : Math.max(0, currentCount - 1); } } catch (e) { console.error("Like transaction failed: ", e); showToast("Gagal melakukan aksi suka. Coba lagi.", "error"); } finally { button.disabled = false; } }
        async function openCommentsModal(postId) { if (!currentUser) { showToast("Login dulu untuk lihat & tambah komentar!", "error"); return; } currentPostIdForComments = postId; commentList.innerHTML = '<div class="loader my-auto"></div>'; commentModal.classList.add('visible'); try { const commentsRef = collection(db, `user_posts/${postId}/comments`); const q = query(commentsRef, orderBy("createdAt", "asc")); const querySnapshot = await getDocs(q); if (querySnapshot.empty) { commentList.innerHTML = `<p class="history-empty text-center text-gray-400 m-auto">Jadilah yang pertama berkomentar!</p>`; } else { let commentsHtml = ''; querySnapshot.forEach(doc => { commentsHtml += createCommentItem(doc.data()); }); commentList.innerHTML = commentsHtml; lucide.createIcons({nodes: commentList.querySelectorAll('[data-lucide]')}); } commentList.scrollTop = commentList.scrollHeight; } catch(e) { console.error("Error fetching comments: ", e); commentList.innerHTML = `<p class="history-empty text-center text-red-400 m-auto">Gagal memuat komentar. Pastikan Security Rules-mu benar ya!</p>`; } }
        function closeCommentsModal() { commentModal.classList.remove('visible'); currentPostIdForComments = null; }
        function createCommentItem(data) { const timestamp = data.createdAt?.toDate().toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'short' }) || ''; return ` <div class="comment-item"> <img src="${escapeHTML(data.authorPhotoURL || 'https://i.pravatar.cc/150')}" alt="Author" class="comment-author-img"> <div class="comment-content"> <div> <span class="author">${escapeHTML(data.authorUsername)}</span> <span class="timestamp">${timestamp}</span> </div> <p class="text">${escapeHTML(data.text)}</p> </div> </div>`; }
        async function handleCommentSubmit(e) { e.preventDefault(); if (!currentUser || !currentPostIdForComments) return; const text = commentInput.value.trim(); if (!text) return; commentInput.disabled = true; const submitBtn = commentForm.querySelector('button[type="submit"]'); submitBtn.disabled = true; try { const postRef = doc(db, "user_posts", currentPostIdForComments); const commentsRef = collection(postRef, 'comments'); const newCommentData = { authorId: currentUser.uid, authorUsername: userProfile.username || currentUser.displayName, authorPhotoURL: currentUser.photoURL, text: text, createdAt: serverTimestamp() }; const batch = writeBatch(db); batch.set(doc(commentsRef), newCommentData); batch.update(postRef, { commentsCount: increment(1) }); await batch.commit(); commentInput.value = ''; openCommentsModal(currentPostIdForComments); const postCard = document.querySelector(`.social-post-card[data-post-id="${currentPostIdForComments}"]`); if(postCard) { const countSpan = postCard.querySelector('.comment-count'); countSpan.textContent = parseInt(countSpan.textContent, 10) + 1; } } catch (e) { console.error("Error submitting comment: ", e); showToast("Gagal mengirim komentar.", "error"); } finally { commentInput.disabled = false; submitBtn.disabled = false; } }
        async function handleShareClick(postId) { const postUrl = `${window.location.origin}${window.location.pathname}#social`; const postCard = document.querySelector(`.social-post-card[data-post-id="${postId}"]`); const caption = postCard ? postCard.querySelector('.post-caption')?.textContent.substring(0, 100) + '...' : "Lihat postingan keren ini!"; if (navigator.share) { try { await navigator.share({ title: 'Lihat Postingan di NekoNime!', text: caption, url: postUrl, }); showToast("Link dibagikan!", "success"); } catch (e) { if (e.name !== 'AbortError') { console.error("Share API error: ", e); showToast("Gagal membagikan link.", "error"); } else { console.log("Share canceled."); } } } else { try { await navigator.clipboard.writeText(postUrl); showToast("Link postingan disalin ke clipboard!", "success"); } catch (e) { showToast("Gagal menyalin link.", "error"); } } }
        function setupChatListener() { showLoader(chatLoader); chatMessages.innerHTML = ''; const chatRef = collection(db, "global_chat"); const q = query(chatRef, orderBy("createdAt", "desc"), limit(50)); chatUnsubscribe = onSnapshot(q, (querySnapshot) => { hideLoader(chatLoader); let newMessagesHtml = ''; const newDocs = []; querySnapshot.docChanges().forEach(change => { if (change.type === "added") { newDocs.unshift(change.doc.data()); } }); newMessagesHtml = querySnapshot.docs.map(d => createChatMessage(d.data())).join(''); chatMessages.innerHTML = newMessagesHtml; lucide.createIcons({ nodes: chatMessages.querySelectorAll('[data-lucide]') }); }, (error) => { console.error("Chat listener error:", error); hideLoader(chatLoader); chatMessages.innerHTML = `<p class="text-center text-red-400 m-auto">Gagal memuat chat...</p>`; }); }
        function createChatMessage(data) { const isSent = data.authorId === currentUser.uid; const author = isSent ? 'Kamu' : data.authorUsername || 'User Misterius'; return ` <div class="chat-message-item ${isSent ? 'sent' : 'received'}"> <span class="chat-author">${escapeHTML(author)}</span> <div class="chat-bubble">${escapeHTML(data.text)}</div> </div> `; }
        async function handleSendMessage(e) { e.preventDefault(); if (!currentUser) return; const text = chatInput.value.trim(); if (!text) return; const originalText = text; chatInput.value = ''; chatSendBtn.disabled = true; try { await addDoc(collection(db, "global_chat"), { authorId: currentUser.uid, authorUsername: userProfile.username || currentUser.displayName, text: originalText, createdAt: serverTimestamp() }); } catch (error) { console.error("Error sending message:", error); showToast("Gagal mengirim pesan.", "error"); chatInput.value = originalText; } finally { chatSendBtn.disabled = false; } }
        function closePostOptionsModal() { postOptionsModal.classList.remove('visible'); }
        async function openEditModal() { if (!currentPostIdForAction) return; closePostOptionsModal(); const postRef = doc(db, "user_posts", currentPostIdForAction); try { const docSnap = await getDoc(postRef); if (docSnap.exists()) { const data = docSnap.data(); if (data.authorId !== currentUser.uid) { showToast("Akses ditolak!", "error"); currentPostIdForAction = null; return; } editCaption.value = data.caption || ''; editPrivacy.value = data.privacy || 'public'; editPostModal.classList.add('visible'); } else { showToast("Postingan tidak ditemukan.", "error"); currentPostIdForAction = null; } } catch(e) { showToast("Gagal memuat data untuk diedit.", "error"); console.error(e); currentPostIdForAction = null; } }
        function closeEditModal() { editPostModal.classList.remove('visible'); currentPostIdForAction = null; }
        async function handleEditPost(e) { e.preventDefault(); if (!currentPostIdForAction || !currentUser) return; const newCaption = editCaption.value.trim(); const newPrivacy = editPrivacy.value; const submitBtn = editPostForm.querySelector('button[type="submit"]'); submitBtn.disabled = true; submitBtn.textContent = 'Menyimpan...'; const postRef = doc(db, "user_posts", currentPostIdForAction); try { await updateDoc(postRef, { caption: newCaption, privacy: newPrivacy, }); showToast("Postingan berhasil diperbarui!", "success"); const postCard = document.querySelector(`.social-post-card[data-post-id="${currentPostIdForAction}"]`); if (postCard) { const captionEl = postCard.querySelector('.post-caption'); if (newCaption) { if(captionEl) { captionEl.textContent = newCaption; } else { const newCaptionEl = document.createElement('p'); newCaptionEl.className = 'post-caption'; newCaptionEl.textContent = newCaption; postCard.querySelector('.post-image').insertAdjacentElement('afterend', newCaptionEl); } } else { captionEl?.remove(); } } closeEditModal(); } catch(e) { showToast("Gagal menyimpan perubahan.", "error"); console.error(e); } finally { submitBtn.disabled = false; submitBtn.textContent = 'Simpan Perubahan'; } }
        function openDeleteModal() { if (!currentPostIdForAction) return; closePostOptionsModal(); deletePostModal.classList.add('visible'); }
        function closeDeleteModal() { deletePostModal.classList.remove('visible'); deletePostForm.reset(); customDeleteReason.classList.add('hidden'); currentPostIdForAction = null; }
        async function handleDeletePost(e) { e.preventDefault(); if (!currentPostIdForAction || !currentUser) return; const submitBtn = deletePostForm.querySelector('button[type="submit"]'); submitBtn.disabled = true; submitBtn.textContent = 'Menghapus...'; const postRef = doc(db, "user_posts", currentPostIdForAction); const reasonData = new FormData(deletePostForm); const reason = reasonData.get('delete_reason'); const customReasonVal = customDeleteReason.value.trim(); if(reason === 'other' && !customReasonVal) { showToast('Tolong isi alasan lainnya.', 'error'); submitBtn.disabled = false; submitBtn.textContent = 'Ya, Hapus Sekarang'; return; } try { const logRef = doc(collection(db, "deletion_logs")); await setDoc(logRef, { postId: currentPostIdForAction, deletedBy: currentUser.uid, reason: reason === 'other' ? `Other: ${customReasonVal}` : reason, deletedAt: serverTimestamp(), }); await deleteDoc(postRef); showToast("Postingan berhasil dihapus.", "success"); const postCard = document.querySelector(`.social-post-card[data-post-id="${currentPostIdForAction}"]`); if (postCard) { postCard.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out'; postCard.style.opacity = '0'; postCard.style.transform = 'scale(0.95)'; postCard.addEventListener('transitionend', () => postCard.remove()); } closeDeleteModal(); } catch(e) { showToast("Gagal menghapus postingan.", "error"); console.error(e); submitBtn.disabled = false; submitBtn.textContent = 'Ya, Hapus Sekarang'; } }
        
        // --- Authentication and Cloud Sync Functions ---
        async function loginWithGoogle() { const provider = new GoogleAuthProvider(); try { await signInWithPopup(auth, provider); closeMobileNav(); } catch (error) { showToast(`Waduh, login gagal: ${error.code}`, 'error'); } }
        async function logout() { try { await signOut(auth); closeMobileNav(); } catch (error) { showToast(`Gagal logout: ${error.message}`, 'error'); } }
        function updateAuthUI(user) { const tokenHTML = `<div id="neko-token-display" title="Neko Token-mu! Dapatkan dari aktivitas~"><svg class="w-5 h-5"><use xlink:href="#token-symbol"></use></svg><span class="neko-token-count">${Math.floor(nekoTokens)}</span></div>`; const loggedOutHTML = `<button id="login-btn" class="nav-link login-btn"><i data-lucide="log-in"></i> Login</button>`; const loggedOutMobileHTML = `<button id="mobile-login-btn" class="nav-link login-btn"><i data-lucide="log-in"></i> Login dengan Google</button>`; if (user) { const displayName = userProfile?.username || user.displayName.split(' ')[0] || 'User'; const loggedInHTML = `${tokenHTML}<div class="user-profile" onclick="window.location.hash='#profile'"><img src="${escapeHTML(user.photoURL || '')}" alt="${escapeHTML(displayName)}"><span class="text-white">${escapeHTML(displayName)}</span></div><button id="logout-btn" class="nav-link" title="Logout"><i data-lucide="log-out"></i></button>`; const loggedInMobileHTML = `<div id="mobile-user-profile"><img src="${escapeHTML(user.photoURL || '')}" alt="${escapeHTML(displayName)}"><span>Halo, ${escapeHTML(displayName)}!</span><div class="mt-2">${tokenHTML}</div></div><button id="mobile-logout-btn" class="nav-link mobile-logout-btn"><i data-lucide="log-out"></i> Logout</button>`; authContainerDesktop.innerHTML = loggedInHTML; authContainerMobile.innerHTML = loggedInMobileHTML; document.getElementById('logout-btn')?.addEventListener('click', logout); document.getElementById('mobile-logout-btn')?.addEventListener('click', logout); } else { authContainerDesktop.innerHTML = loggedOutHTML; authContainerMobile.innerHTML = loggedOutMobileHTML; document.getElementById('login-btn')?.addEventListener('click', loginWithGoogle); document.getElementById('mobile-login-btn')?.addEventListener('click', loginWithGoogle); } lucide.createIcons(); }
        async function saveDataToFirestore(data) { if (!currentUser) return; try { const userDocRef = doc(db, 'users', currentUser.uid); await setDoc(userDocRef, data, { merge: true }); } catch (error) { console.error("Firestore Save Error:", error); showToast('Gagal simpan data ke cloud. (｡•́︿•̀｡)', 'error'); } }
        async function loadDataFromFirestore(uid) { const userDocRef = doc(db, 'users', uid); try { const docSnap = await getDoc(userDocRef); if (docSnap.exists()) { const cloudData = docSnap.data(); currentFavorites = cloudData.favorites || []; currentCollections = cloudData.collections || {}; historyBrowse = cloudData.historyBrowse || []; historyGacha = cloudData.historyGacha || []; nekoTokens = cloudData.nekoTokens || 0; userProfile = cloudData.userProfile || { username: null }; lastLoginDate = cloudData.lastLoginDate || null; } else { showToast('Selamat datang! Akun cloud-mu sudah dibuat. Mulai koleksi dari sekarang!', 'info'); await setDoc(userDocRef, { favorites: [], collections: {}, historyBrowse: [], historyGacha: [], nekoTokens: 0, userProfile: { username: null }, lastLoginDate: null, createdAt: serverTimestamp() }); } } catch (error) { console.error("Firestore Load Error:", error); showToast('Gagal ambil data dari cloud. ( T д T )', 'error'); } }
        function loadAllDataFromLocal() { historyBrowse = loadFromLocalStorage('nekonime_history_browse_v9', []); historyGacha = loadFromLocalStorage('nekonime_history_gacha_v9', []); currentFavorites = loadFromLocalStorage('nekonime_favorites_v9', []); currentCollections = loadFromLocalStorage('nekonime_collections_v9', {}); nekoTokens = loadFromLocalStorage('nekonime_tokens_v10', 0); userProfile = loadFromLocalStorage('nekonime_profile_v10', { username: null }); lastLoginDate = loadFromLocalStorage('nekonime_last_login_v10', null); }
        function reloadCurrentPageView() { const pageId = window.location.hash.substring(1) || 'gallery'; showPage(pageId); updateAllCollectionButtonsState(); updateFavoriteStatusUI(null, false); updateTokenUI(); updateGachaButtonUI(); }

        // --- Main App Initialization ---
        onAuthStateChanged(auth, async (user) => { const wasLoggedIn = !!currentUser; const isLoggedInNow = !!user; if (!isInitialAuthCheckComplete) { if (user) { currentUser = user; await loadDataFromFirestore(user.uid); checkDailyLogin(); } else { currentUser = null; loadAllDataFromLocal(); } initializeAppUI(); isInitialAuthCheckComplete = true; } else if (wasLoggedIn !== isLoggedInNow) { if (user) { showToast(`Halo lagi, ${user.displayName}! ♡ Sinkronisasi data dari cloud...`, 'info'); currentUser = user; clearAllStateVariables(); await loadDataFromFirestore(user.uid); checkDailyLogin(); updateAuthUI(user); reloadCurrentPageView(); } else { showToast('Logout berhasil! Kembali ke data lokal...', 'info'); currentUser = null; clearAllStateVariables(); loadAllDataFromLocal(); updateAuthUI(null); reloadCurrentPageView(); } } });
        function initializeAppUI() { console.log("NekoNime v10.0.8 Berangkat! Bug Fixes Implemented! Nyaa~ (づ｡◕‿‿◕｡)づ"); updateAuthUI(currentUser); currentApiId = loadFromLocalStorage('nekonime_api_v9', 'nekos'); currentApiConf = API_CONFIG[currentApiId]; currentGalleryCategory = currentApiConf?.categories[0]?.endpoint || ''; populateApiSelector(); setupEventListeners(); handleHashChange(); initialLoader.classList.add('hidden'); appContainer.style.visibility = 'visible'; }
        function setupEventListeners() {
            window.addEventListener('hashchange', handleHashChange);
            mainContent.addEventListener('click', (e) => { const card = e.target.closest('.image-card'); if (card && !e.target.closest('button')) { openLightbox(card); } });
            window.addEventListener('keydown', (e) => { if (e.key === 'Escape') { if(commentModal.classList.contains('visible')) closeCommentsModal(); else if (addToCollectionModal.classList.contains('visible')) closeAddToCollectionModal(true); else if (lightboxModal.classList.contains('visible')) closeLightbox(); else if (alertModal.classList.contains('visible')) closeAlertModal(); else if (confirmModal.classList.contains('visible')) closeConfirmModal(); else if (feedbackModal.classList.contains('visible')) closeFeedbackModal(); else if (mobileNavOverlay.classList.contains('visible')) closeMobileNav(); else if (postOptionsModal.classList.contains('visible')) closePostOptionsModal(); else if (editPostModal.classList.contains('visible')) closeEditModal(); else if (deletePostModal.classList.contains('visible')) closeDeleteModal(); } });
            loadMoreBtn?.addEventListener('click', () => loadGallery(currentGalleryCategory, false));
            gachaButton?.addEventListener('click', performGacha);
            gachaResetButton?.addEventListener('click', resetGachaDisplay);
            gachaImageWrapper?.addEventListener('click', () => { if (currentGachaResultData) { openLightbox(currentGachaResultData); } });
            mobileMenuToggle?.addEventListener('click', openMobileNav);
            closeMobileNavBtn?.addEventListener('click', closeMobileNav);
            mobileNavLinksContainer?.addEventListener('click', (e) => { const link = e.target.closest('a.nav-link'); const fbBtn = e.target.closest('#feedback-button-mobile'); if (link) closeMobileNav(); else if (fbBtn) openFeedbackModal(); });
            historyTabBrowse?.addEventListener('click', () => switchHistoryTab('browse'));
            historyTabGacha?.addEventListener('click', () => switchHistoryTab('gacha'));
            socialTabFeed?.addEventListener('click', () => switchSocialTab('feed'));
            socialTabUpload?.addEventListener('click', () => switchSocialTab('upload'));
            socialTabChat?.addEventListener('click', () => switchSocialTab('chat'));
            createCollectionForm?.addEventListener('submit', (e) => { e.preventDefault(); const name = newCollectionNameInput.value; createCollection(name).then(({ success }) => { if (success) { newCollectionNameInput.value = ''; loadCollectionsList(); } else { newCollectionNameInput.focus(); } }); });
            chatForm?.addEventListener('submit', handleSendMessage);
            uploadPostForm?.addEventListener('submit', handleImageUpload);
            uploadImageFile?.addEventListener('change', () => { const file = uploadImageFile.files[0]; if (file) { fileUploadText.textContent = file.name; const objectUrl = URL.createObjectURL(file); imagePreview.src = objectUrl; imagePreview.onload = () => URL.revokeObjectURL(objectUrl); imagePreviewContainer.classList.remove('hidden'); } });
            backToCollectionsBtn?.addEventListener('click', () => showCollectionView('main'));
            closeAddToCollectionModalBtn?.addEventListener('click', () => closeAddToCollectionModal(true));
            addCreateCollectionForm?.addEventListener('submit', handleAddCreateCollectionSubmit);
            apiSelector?.addEventListener('change', handleApiChange);
            clearHistoryBrowseBtn?.addEventListener('click', () => clearData('historyBrowse', 'History Jelajah'));
            clearHistoryGachaBtn?.addEventListener('click', () => clearData('historyGacha', 'History Gacha'));
            clearFavoritesBtn?.addEventListener('click', () => clearData('favorites', 'Favorit'));
            clearCollectionsBtn?.addEventListener('click', () => clearData('collections', 'Koleksi'));
            clearAllDataBtn?.addEventListener('click', clearAllUserData);
            lightboxFavoriteBtn?.addEventListener('click', toggleFavoriteLightbox);
            lightboxAddCollectionBtn?.addEventListener('click', () => { if (currentLightboxImageData) { handleAddToCollectionClick(currentLightboxImageData); } });
            closeAlertModalBtn?.addEventListener('click', closeAlertModal);
            closeConfirmModalBtn?.addEventListener('click', closeConfirmModal);
            alertModalOk?.addEventListener('click', closeAlertModal);
            confirmModalCancel?.addEventListener('click', closeConfirmModal);
            closeFeedbackModalButton?.addEventListener('click', closeFeedbackModal);
            feedbackForm?.addEventListener('submit', handleFeedbackSubmit);
            closeCommentModalBtn?.addEventListener('click', closeCommentsModal);
            commentForm?.addEventListener('submit', handleCommentSubmit);
            closePostOptionsModalBtn.addEventListener('click', () => { closePostOptionsModal(); currentPostIdForAction = null; });
            postOptionsEditBtn.addEventListener('click', openEditModal);
            postOptionsDeleteBtn.addEventListener('click', openDeleteModal);
            closeEditPostModal.addEventListener('click', closeEditModal);
            editPostCancelBtn.addEventListener('click', closeEditModal);
            editPostForm.addEventListener('submit', handleEditPost);
            closeDeletePostModalBtn.addEventListener('click', closeDeleteModal);
            deletePostCancelBtn.addEventListener('click', closeDeleteModal);
            deletePostForm.addEventListener('submit', handleDeletePost);
            deletePostForm.addEventListener('change', (e) => { if (e.target.name === 'delete_reason') { const isOther = e.target.value === 'other'; customDeleteReason.classList.toggle('hidden', !isOther); customDeleteReason.required = isOther; } });
        }

        // --- Expose necessary functions to the global window object ---
        window.closeLightbox = closeLightbox;
        window.toggleFavorite = (btn) => toggleFavoriteDirect(JSON.parse(btn.dataset.image), !btn.classList.contains('active'));
        window.handleAddToCollectionClick = handleAddToCollectionClick;
        window.handleRemoveItem = handleRemoveItem;
        window.showCollectionDetail = showCollectionDetail;
        window.loginWithGoogle = loginWithGoogle;
        window.openLightbox = openLightbox;
        window.togglePostOptions = togglePostOptions;
        window.handleLikeClick = handleLikeClick;
        window.openCommentsModal = openCommentsModal;
        window.handleShareClick = handleShareClick;

        // --- The rest of the functions (lightbox, modals, settings, etc.) ---
        function closeAlertModal() { alertModal.classList.remove('visible'); }
        function closeConfirmModal() { confirmModal.classList.remove('visible'); }
        function openLightbox(cardOrData) { let data; if (cardOrData.nodeType) { const card = cardOrData; data = { url: card.dataset.url, artist_name: decodeURIComponent(card.dataset.artist), source_url: card.dataset.sourceUrl, apiSource: card.dataset.sourceApi }; } else { data = cardOrData; } if (!data.url) return; if (data.url !== currentLightboxImageData?.url && !data.url.startsWith('data:image')) { updateNekoTokens(5, 'Lihat Gambar'); } currentLightboxImageData = { ...data }; lightboxImage.src = ''; lightboxImage.alt = `Ilustrasi oleh ${escapeHTML(data.artist_name)}`; lightboxImage.src = data.url; lightboxArtist.textContent = data.artist_name; if (data.source_url && data.source_url !== '#' && data.source_url !== data.url) { lightboxSource.href = data.source_url; lightboxSource.style.display = 'inline-block'; } else { lightboxSource.style.display = 'none'; } updateSingleFavButtonUI(lightboxFavoriteBtn, isFavoriteCheck(data.url)); updateSingleCollectionButtonUI(lightboxAddCollectionBtn, isImageInAnyCollection(data.url)); lightboxModal.classList.add('visible'); }
        function closeLightbox() { lightboxModal.classList.remove('visible'); currentLightboxImageData = null; }
        function toggleFavoriteLightbox() { if (!currentLightboxImageData) return; const isFav = isFavoriteCheck(currentLightboxImageData.url); toggleFavoriteDirect(currentLightboxImageData, !isFav); showToast(isFav ? 'Dihapus dari favorit... (╥_╥)' : 'Yeaay! Jadi favoritmu! ♡', 'success'); }
        function isFavoriteCheck(url) { return currentFavorites.some(f => f?.url === url); }
        function updateFavoriteStatusUI(url, isFav) { const selector = url ? `.image-card[data-id="${escapeHTML(url)}"] .favorite-btn, .social-post-card[data-post-id="${escapeHTML(url)}"] .favorite-btn` : '.favorite-btn'; document.querySelectorAll(selector).forEach(btn => { const card = btn.closest('.image-card') || btn.closest('.social-post-card'); const cardId = card?.dataset.id || card?.dataset.postId; const shouldBeActive = url ? (cardId === url ? isFav : isFavoriteCheck(cardId)) : isFavoriteCheck(cardId); updateSingleFavButtonUI(btn, shouldBeActive); }); if (lightboxModal.classList.contains('visible') && currentLightboxImageData) { if (url === null || currentLightboxImageData.url === url) { updateSingleFavButtonUI(lightboxFavoriteBtn, url ? isFav : isFavoriteCheck(currentLightboxImageData.url)); } } }
        function updateSingleFavButtonUI(btn, isFav) { if (!btn) return; const icon = btn.querySelector('i[data-lucide="heart"]'); const span = btn.querySelector('span'); if (isFav) { btn.classList.add('active'); if(icon) icon.style.fill = 'currentColor'; btn.title = 'Batalin Favorit?'; if (span) span.textContent = 'Favorited ♡'; } else { btn.classList.remove('active'); if(icon) icon.style.fill = 'none'; btn.title = 'Jadikan Favorit! (+10 Token)'; if (span) span.textContent = 'Favorit'; } }
        function updateCollectionButtonStatus(url, isInColl) { const selector = `.image-card[data-id="${escapeHTML(url)}"] .add-to-collection-card-btn`; document.querySelectorAll(selector).forEach(btn => updateSingleCollectionButtonUI(btn, isInColl)); if (lightboxModal.classList.contains('visible') && currentLightboxImageData?.url === url) { updateSingleCollectionButtonUI(lightboxAddCollectionBtn, isInColl); } }
        function updateAllCollectionButtonsState() { document.querySelectorAll('.add-to-collection-card-btn').forEach(btn => { const card = btn.closest('.image-card'); if (card?.dataset.id) { updateSingleCollectionButtonUI(btn, isImageInAnyCollection(card.dataset.id)); } }); if (lightboxModal.classList.contains('visible') && currentLightboxImageData?.url) { updateSingleCollectionButtonUI(lightboxAddCollectionBtn, isImageInAnyCollection(currentLightboxImageData.url)); } }
        function updateSingleCollectionButtonUI(btn, inColl) { if (!btn) return; const icon = btn.querySelector('i'); const span = btn.querySelector('span'); if (inColl) { btn.classList.add('in-collection'); btn.title = 'Udah ada di Koleksi!'; if (icon) icon.dataset.lucide = 'folder-check'; if (span) span.textContent = 'Di Koleksi ✔'; } else { btn.classList.remove('in-collection'); btn.title = 'Tambah ke Koleksi (+15 Token)'; if (icon) icon.dataset.lucide = 'plus-square'; if (span) span.textContent = 'Tambah ke Koleksi'; } if (icon) lucide.createIcons({ nodes: [icon] }); }
        function handleAddToCollectionClick(dataInput) { try { let data = (typeof dataInput === 'string') ? JSON.parse(dataInput) : dataInput; if (!data?.url) throw new Error("URL invalid."); pendingLightboxData = { ...data }; openAddToCollectionModalInternal(); } catch (err) { showToast(`Gagal buka opsi koleksi: ${err.message}`, "error"); } }
        function openAddToCollectionModalInternal() { if (!pendingLightboxData?.url) return; addToCollectionModalList.innerHTML = ''; hideInfo(addToCollectionEmpty); const names = Object.keys(currentCollections); const url = pendingLightboxData.url; if (names.length === 0) { renderInfo(addToCollectionEmpty, addToCollectionEmpty.dataset.emptyMessage || "Belum ada koleksi."); } else { names.sort().forEach(name => { const exists = currentCollections[name]?.some(img => img.url === url); const btn = document.createElement('button'); btn.className = `add-to-collection-item ${exists ? 'exists' : ''}`; btn.innerHTML = `<span>${escapeHTML(name)}</span> ${exists ? '<i data-lucide="check-circle" class="check-icon w-4 h-4"></i>' : ''}`; btn.onclick = () => { if (!exists) addImageToCollection(name); else showToast(`Udah ada di "${escapeHTML(name)}" kok~ 😉`, "info"); }; addToCollectionModalList.appendChild(btn); }); lucide.createIcons({ nodes: addToCollectionModalList.querySelectorAll('[data-lucide]') }); } addNewCollectionNameInput.value = ''; addToCollectionModal.classList.add('visible'); }
        function closeAddToCollectionModal(reopenLightbox = true) { addToCollectionModal.classList.remove('visible'); const dataToReopen = pendingLightboxData; pendingLightboxData = null; if (reopenLightbox && dataToReopen) { openLightbox(dataToReopen); } }
        async function handleAddCreateCollectionSubmit(e) { e.preventDefault(); const name = addNewCollectionNameInput.value; const { success } = await createCollection(name, pendingLightboxData); if (success) { updateCollectionButtonStatus(pendingLightboxData.url, true); closeAddToCollectionModal(false); if (!collectionsMainView.classList.contains('hidden')) loadCollectionsList(); } }
        async function clearData(dataType, typeName) { const confirm = await showConfirm(`Yakin mau hapus semua ${typeName}? (dari data ${currentUser ? 'cloud' : 'lokal'})`); if (confirm) { switch (dataType) { case 'historyBrowse': historyBrowse = []; saveState('historyBrowse', []); loadBrowseHistory(); break; case 'historyGacha': historyGacha = []; saveState('historyGacha', []); loadGachaHistory(); break; case 'favorites': currentFavorites = []; saveState('favorites', []); updateFavoriteStatusUI(null, false); loadFavorites(); break; case 'collections': currentCollections = {}; saveCollections(); updateAllCollectionButtonsState(); loadCollectionsList(); showCollectionView('main'); break; } showToast(`Data ${typeName} sudah dihapus!`, "info"); } }
        async function clearAllUserData() { const confirm = await showConfirm(`Serius mau HAPUS SEMUA data (History, Favorit, Koleksi, Token)? Ini nggak bisa dibalikin! (Akan menghapus data ${currentUser ? 'cloud' : 'lokal'})`, "Hapus Semua Data?"); if (confirm) { clearAllStateVariables(); saveState('historyBrowse', []); saveState('historyGacha', []); saveState('favorites', []); saveState('collections', {}); saveState('nekoTokens', 0); saveState('userProfile', { username: null }); saveState('lastLoginDate', null); reloadCurrentPageView(); showToast("Semua datamu sudah dihapus bersih!", "success"); } }
        function handleRemoveItem(button, context) { const id = button.dataset.id; if (!id) return; let msg = ''; const card = button.closest('.image-card'); if (context === 'history_browse') { historyBrowse = historyBrowse.filter(i => i?.url !== id); saveState('historyBrowse', historyBrowse); msg = 'Dihapus dari History'; } else if (context === 'history_gacha') { historyGacha = historyGacha.filter(i => i?.url !== id); saveState('historyGacha', historyGacha); msg = 'Dihapus dari History'; } else if (context === 'favorites') { toggleFavoriteDirect({ url: id }, false); msg = 'Dihapus dari Favorit'; } else if (context.startsWith('collection_')) { const name = context.split('_')[1]; if (currentCollections[name]) { currentCollections[name] = currentCollections[name].filter(i => i?.url !== id); saveCollections(); msg = `Dihapus dari koleksi "${escapeHTML(name)}"`; updateAllCollectionButtonsState(); loadCollectionsList(); } } if (card) { card.style.transition = 'opacity .3s'; card.style.opacity = '0'; card.addEventListener('transitionend', () => card.remove(), { once: true }); } if (msg && context !== 'favorites') showToast(msg, 'info'); }
        function handleApiChange(event) { const newId = event.target.value; if (newId !== currentApiId) { currentApiId = newId; currentApiConf = API_CONFIG[newId]; currentGalleryCategory = currentApiConf?.categories?.[0]?.endpoint || ''; saveToLocalStorage('nekonime_api_v9', newId); showToast(`Oke! Ganti API ke ${currentApiConf.name}.`, 'info'); if (window.location.hash !== '#gallery') { window.location.hash = '#gallery'; } else { showPage('gallery'); } if (gachaApiNameSpan) gachaApiNameSpan.textContent = currentApiConf?.name || '...'; } }
        function populateApiSelector() { if (!apiSelector) return; apiSelector.innerHTML = ''; Object.keys(API_CONFIG).forEach(key => { const opt = document.createElement('option'); opt.value = key; opt.textContent = API_CONFIG[key].name; if (key === currentApiId) opt.selected = true; apiSelector.appendChild(opt); }); }
        function handleFeedbackSubmit(e) { e.preventDefault(); const msg = feedbackMessage.value.trim(); if (!msg) return; const subject = `Masukan buat NekoNime v10`; const body = `Pesan:\n${msg}\n\nInfo:\nAPI: ${currentApiConf?.name}\nUser: ${currentUser?.uid || 'logout'}`; window.open(`mailto:${FEEDBACK_EMAIL}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`); showToast("Makasih masukannya! ♡", "success"); closeFeedbackModal(); }
        function openFeedbackModal() { feedbackModal.classList.add('visible'); }
        function closeFeedbackModal() { feedbackModal.classList.remove('visible'); }
    </script>

</body>
</html>
