
<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NekoNime v9.5.1 - Login & Cloud Save Fix! ‚ô°</title>
    <meta name="description" content="NekoNime dengan Login Google & Cloud Save! Simpan favorit, koleksi, dan history-mu di cloud. Akses dari mana saja, kapan saja! Gacha tanpa cooldown, galeri lengkap, scroll lancar~ üíñ">

    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Inline Styles -->
    <style>
        /* --- Root Variables (Color Palette, Layout, Z-Index) --- */
        :root {
            --bg-dark-1: #0a0510; --bg-dark-2: #110b1a; --bg-dark-3: #1a112a;
            --glass-bg: rgba(20, 12, 31, 0.85);
            --glass-border: rgba(255, 255, 255, 0.08);
            --card-bg: rgba(26, 17, 42, 0.65); --text-primary: #f0f1f5; --text-secondary: #a8b2cc;
            --text-uwu: #f9a8d4; --text-placeholder: #626a7f; --accent-magenta: #ec4899;
            --accent-pink: #f472b6; --accent-red: #ef4444; --accent-purple: #a855f7;
            --accent-blue: #60a5fa; --accent-yellow: #facc15; --accent-green: #4ade80;

            /* Gradients */
            --accent-gradient: linear-gradient(115deg, var(--accent-purple), var(--accent-magenta) 55%, var(--accent-red) 100%);
            --accent-gradient-hover: linear-gradient(115deg, var(--accent-purple), var(--accent-pink) 55%, var(--accent-red) 100%);
            --green-gradient: linear-gradient(115deg, #22c55e, #4ade80);
            --gacha-card-gradient: linear-gradient(140deg, var(--accent-purple) 10%, var(--accent-magenta) 60%, var(--accent-pink) 95%);

            /* Layout & Z-Index */
            --mobile-header-height: 3.75rem; /* 60px */
            --toast-z-index: 150; --modal-z-index: 130;
            --mobile-nav-z-index: 120; --lightbox-z-index: 110;
            --mobile-header-z-index: 100;
            --gacha-anim-z-index: 15; --gacha-result-z-index: 10; --gacha-placeholder-z-index: 5;
            --gacha-error-z-index: 20;
        }

        /* --- Base Styles --- */
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(150deg, var(--bg-dark-1), var(--bg-dark-2) 45%, var(--bg-dark-3) 90%);
            background-attachment: fixed;
            color: var(--text-primary);
            overscroll-behavior: none;
            margin: 0;
            padding: 0;
        }
        .glassmorphism {
            background: var(--glass-bg);
            backdrop-filter: blur(18px) saturate(190%);
            -webkit-backdrop-filter: blur(18px) saturate(190%);
            border-bottom: 1px solid var(--glass-border);
            box-shadow: 0 7px 45px rgba(0, 0, 0, 0.4);
        }
        .uwu-text { color: var(--text-uwu); font-style: italic; }

        /* --- Image Card Styles --- */
        .image-card {
            display: inline-block; width: 100%; margin-bottom: 1rem; break-inside: avoid;
            cursor: pointer; border-radius: 0.85rem; background-color: var(--card-bg);
            position: relative; overflow: hidden; border: 1px solid rgba(255,255,255,0.05);
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .image-card img {
            border-radius: 0.8rem; display: block; width: 100%; height: auto;
            background-color: var(--bg-dark-3); object-fit: cover; min-height: 100px;
        }
        .image-card:hover { transform: scale(1.02) rotate(-0.5deg); box-shadow: 0 8px 35px rgba(236, 72, 153, 0.3); z-index: 10; }
        .card-overlay {
            position: absolute; bottom: 0; left: 0; right: 0; height: 50px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.85) 0%, rgba(0, 0, 0, 0) 100%);
            opacity: 0; transition: opacity 0.3s ease-in-out; pointer-events: none;
            display: flex; align-items: flex-end; padding: 0.6rem; box-sizing: border-box;
        }
        .image-card:hover .card-overlay { opacity: 1; pointer-events: auto; }
        .card-button {
            background-color: rgba(20, 12, 31, 0.6); backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.1); color: var(--text-secondary);
            border-radius: 999px; padding: 0.4rem; display: inline-flex;
            align-items: center; justify-content: center; transition: all 0.2s ease;
            z-index: 15; pointer-events: auto; cursor: pointer;
        }
        .card-button i { width: 1.1rem; height: 1.1rem; }
        .card-button:hover { background-color: rgba(20, 12, 31, 0.8); transform: scale(1.05); }
        .add-to-collection-card-btn { margin-right: auto; }
        .add-to-collection-card-btn:hover { color: var(--accent-blue); }
        .favorite-btn:hover { color: var(--accent-red); }
        .add-to-collection-card-btn.in-collection { background: var(--green-gradient); color: white; box-shadow: 0 2px 8px rgba(74, 222, 128, 0.4); border-color: transparent; }
        .add-to-collection-card-btn.in-collection:hover { background: var(--green-gradient); transform: scale(1.05); }
        .favorite-btn.active { background: var(--accent-red); color: white; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4); border-color: transparent;}
        .favorite-btn.active:hover { background: var(--accent-red); transform: scale(1.05); }
        .favorite-btn.active i { fill: currentColor; }

        /* --- Remove Item Button --- */
        .remove-item-btn {
            position: absolute; top: 0.5rem; right: 0.5rem; background: rgba(0, 0, 0, 0.5);
            color: rgba(255, 255, 255, 0.7); border: none; border-radius: 50%;
            padding: 0.25rem; line-height: 0; cursor: pointer; transition: all 0.2s ease;
            z-index: 15; opacity: 0; pointer-events: none;
        }
        .image-card:hover .remove-item-btn { opacity: 1; pointer-events: auto; }
        .remove-item-btn:hover { background: var(--accent-red); color: white; transform: scale(1.1); }
        .remove-item-btn i { width: 0.8rem; height: 0.8rem; display: block; }

        /* --- Navigation Styles --- */
        .nav-link {
            position: relative; transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
            border-radius: 0.75rem; display: inline-flex; align-items: center; justify-content: center; text-decoration: none;
        }
        .nav-link:not(.active):hover { background-color: rgba(255, 255, 255, 0.08); color: white; transform: translateY(-2px); }
        .nav-link.active { background: var(--accent-gradient); color: white; font-weight: 600; box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4); transform: translateY(-1px) scale(1.03); }
        .nav-link.disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; }
        .nav-link.disabled::after { content: "Soon!"; font-size: 0.6rem; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: var(--accent-yellow); color: var(--bg-dark-1); padding: 1px 4px; border-radius: 4px; font-weight: bold; text-transform: uppercase; }
        #desktop-nav .nav-link { padding: 0.6rem; }
        #desktop-nav .nav-link.active { transform: scale(1.1); box-shadow: 0 2px 8px rgba(236, 72, 153, 0.3);}
        #desktop-nav .nav-link:not(.active):hover { transform: scale(1.1) translateY(-1px); }
        #mobile-nav-links .nav-link { justify-content: center; padding: 0.75rem 1.25rem; width: 100%; }
        #mobile-nav-links .nav-link.active { transform: scale(1.02); }
        
        /* Auth Container Styles */
        .auth-container { display: flex; align-items: center; gap: 0.75rem; margin-left: auto; }
        .user-profile { display: flex; align-items: center; gap: 0.5rem; background-color: rgba(255,255,255,0.05); padding: 0.25rem 0.6rem 0.25rem 0.25rem; border-radius: 99px; border: 1px solid var(--glass-border); }
        .user-profile img { width: 2rem; height: 2rem; border-radius: 50%; border: 2px solid var(--accent-pink); }
        .user-profile span { font-size: 0.8rem; font-weight: 500; display: none; }
        @media (min-width: 1280px) { .user-profile span { display: block; } }
        #logout-btn { padding: 0.6rem; }
        #logout-btn:hover { background-color: var(--accent-red); color: white; }
        .login-btn { padding: 0.5rem 1rem !important; gap: 0.5rem; font-weight: 500; background: var(--accent-gradient); }
        .login-btn:hover { background: var(--accent-gradient-hover); transform: translateY(-1px); }
        
        #mobile-auth-container { width: 100%; margin-top: 1rem; border-top: 1px solid var(--glass-border); padding-top: 1rem; }
        #mobile-auth-container .login-btn { width: 100%; justify-content: center; }
        #mobile-user-profile { display: flex; flex-direction: column; align-items: center; gap: 0.75rem; }
        #mobile-user-profile img { width: 4rem; height: 4rem; border-radius: 50%; border: 3px solid var(--accent-pink); }
        #mobile-user-profile span { font-size: 1rem; font-weight: 600; color: var(--text-primary); }
        #mobile-logout-btn { background-color: rgba(239, 68, 68, 0.2); border: 1px solid var(--accent-red); color: var(--accent-red); padding: 0.6rem 1rem; width: 100%; justify-content: center; }

        /* --- Layout & Grid --- */
        .masonry-grid { column-count: 2; column-gap: 1rem; }
        @media (min-width: 640px) { .masonry-grid { column-count: 3; } }
        @media (min-width: 768px) { .masonry-grid { column-count: 4; } }
        @media (min-width: 1024px) { #main-header { justify-content: flex-start; padding: 0.5rem 1.5rem; } #desktop-nav { display: flex; gap: 0.5rem; } #header-title { margin-right: 1.5rem; } #mobile-menu-toggle { display: none; margin-left: auto; } }
        @media (max-width: 1023px) { #desktop-nav { display: none; } #main-header { justify-content: space-between; } }
        @media (min-width: 1024px) { .masonry-grid { column-count: 4; } }
        @media (min-width: 1280px) { .masonry-grid { column-count: 5; } }

        /* --- Loaders & Spinners --- */
        .loader { border: 4px solid rgba(255, 255, 255, 0.15); border-radius: 50%; border-top-color: var(--accent-magenta); width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Initial App Loader */
        #initial-loader { position: fixed; inset: 0; background-color: var(--bg-dark-1); z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease; }
        #initial-loader.hidden { opacity: 0; pointer-events: none; }

        /* --- App Structure (FIXED HEADER + SCROLL FIX) --- */
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            visibility: hidden; /* Initially hidden until JS confirms auth state */
        }
        #main-header {
            position: fixed;
            top: 0; left: 0; width: 100%;
            z-index: var(--mobile-header-z-index);
            padding: 0.5rem 1rem; height: var(--mobile-header-height);
            display: flex; align-items: center;
        }
        #content-wrapper {
             flex-grow: 1; 
             overflow: hidden; 
             display: block; 
        }
        #main-content-area {
            overflow-y: auto; 
            height: 100%; 
            padding: 1rem; 
            padding-top: calc(var(--mobile-header-height) + 1rem); 
            position: relative; 
        }
        @media (min-width: 1024px) {
            #main-content-area {
                padding: 1.5rem;
                padding-top: calc(var(--mobile-header-height) + 1.5rem);
            }
        }

        /* --- Mobile Navigation Overlay --- */
        #mobile-nav-overlay { position: fixed; inset: 0; background-color: rgba(10, 5, 15, 0.88); backdrop-filter: blur(16px) saturate(150%); z-index: var(--mobile-nav-z-index); display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.4s ease, visibility 0s linear 0.4s; perspective: 1000px; }
        #mobile-nav-overlay.visible { opacity: 1; visibility: visible; transition: opacity 0.4s ease, visibility 0s linear 0s; }
        #mobile-nav-links { position: relative; display: flex; flex-direction: column; align-items: stretch; gap: 0.9rem; padding: 3rem 2.5rem; width: 90%; max-width: 360px; border-radius: 2.5rem; transform: translateY(20px) scale(0.9); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease; opacity: 0; border-top: 3px solid; border-image-slice: 1; border-image-source: linear-gradient(to left, var(--accent-purple), var(--accent-magenta)); }
        #mobile-nav-overlay.visible #mobile-nav-links { transform: translateY(0) scale(1); opacity: 1; }

        /* --- Category Buttons --- */
        .category-btn { padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.875rem; font-weight: 500; background-color: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.1); color: var(--text-secondary); cursor: pointer; transition: all 0.2s ease; white-space: nowrap; }
        .category-btn:hover { background-color: rgba(255, 255, 255, 0.08); color: var(--text-primary); transform: translateY(-2px); }
        .category-btn.active { background: var(--accent-gradient); color: white; border-color: transparent; box-shadow: 0 3px 10px rgba(236, 72, 153, 0.3); }

        /* --- Load More Button (ALWAYS VISIBLE, STATE CHANGES) --- */
        #load-more-container { text-align: center; margin-top: 2rem; padding-bottom: 1.5rem; min-height: 70px; }
        #load-more-btn { padding: 0.75rem 2rem; background: var(--accent-gradient); color: white; font-weight: 600; border-radius: 999px; box-shadow: 0 4px 15px rgba(168, 85, 247, 0.25); transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.5rem; border: none; cursor: pointer; }
        #load-more-btn:hover:not(:disabled) { transform: scale(1.05); box-shadow: 0 6px 20px rgba(236, 72, 153, 0.35); background: var(--accent-gradient-hover); }
        #load-more-btn:disabled { opacity: 0.6; cursor: not-allowed; background: var(--glass-bg); box-shadow: none; transform: none; }
        #load-more-spinner { display: none; width: 1.25rem; height: 1.25rem; border-width: 2px; margin: 0; }
        #load-more-btn.loading #load-more-spinner { display: inline-block; }
        #load-more-btn.loading #load-more-btn-text { display: none; }
        #load-more-btn.loading #load-more-spinner-text { display: inline; }
        #load-more-btn:not(.loading) #load-more-spinner { display: none; }
        #load-more-btn:not(.loading) #load-more-spinner-text { display: none; }
        #load-more-btn:not(.loading) #load-more-btn-text { display: inline; }

        /* --- Lightbox Modal --- */
        #lightbox-modal { position: fixed; inset: 0; background-color: rgba(10, 5, 15, 0.92); backdrop-filter: blur(10px); z-index: var(--lightbox-z-index); display: flex; align-items: center; justify-content: center; padding: 1rem; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s linear 0.3s; cursor: pointer; }
        #lightbox-modal.visible { opacity: 1; visibility: visible; transition: opacity 0.3s ease, visibility 0s linear 0s;}
        #lightbox-content { position: relative; max-width: 90vw; max-height: 90vh; display: flex; flex-direction: column; align-items: center; cursor: default; }
        #lightbox-image { max-width: 100%; max-height: calc(90vh - 130px); object-fit: contain; border-radius: 0.75rem; margin-bottom: 0.75rem; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6); background-color: rgba(0,0,0,0.2); }
        #lightbox-details { background-color: rgba(0,0,0,0.65); padding: 0.6rem 1.2rem; border-radius: 0.75rem; text-align: center; color: var(--text-secondary); max-width: 85%; font-size: 0.9rem; margin-bottom: 0.75rem; }
        #lightbox-actions { display: flex; gap: 0.75rem; align-items: center; margin-top: 0.5rem; }
        #lightbox-favorite-btn, #lightbox-add-collection-btn { background: rgba(255,255,255, 0.1); border: 1px solid rgba(255,255,255,0.15); color: var(--text-primary); padding: 0.5rem 1rem; border-radius: 99px; font-size: 0.8rem; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 0.4rem; cursor: pointer;}
        #lightbox-favorite-btn:hover, #lightbox-add-collection-btn:hover { background: rgba(255,255,255, 0.18); transform: scale(1.03); }
        #lightbox-favorite-btn.active { background: var(--accent-red); color: white; border-color: transparent; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4); }
        #lightbox-favorite-btn.active i { fill: currentColor; }
        #lightbox-add-collection-btn.in-collection { background: var(--green-gradient); color: white; border-color: transparent; box-shadow: 0 2px 8px rgba(74, 222, 128, 0.4);}
        #lightbox-add-collection-btn.in-collection i { color: white; }
        #lightbox-artist { font-weight: 500; color: var(--text-primary); }
        #lightbox-source { color: var(--accent-blue); text-decoration: none; margin-left: 0.5rem; }
        #lightbox-source:hover { text-decoration: underline; }
        #close-lightbox-btn { position: absolute; top: -15px; right: -15px; background: var(--accent-red); color: white; border: none; border-radius: 50%; padding: 0.5rem; line-height: 0; cursor: pointer; transition: transform 0.2s ease; z-index: calc(var(--lightbox-z-index) + 1); box-shadow: 0 2px 5px rgba(0,0,0,0.4); }
        #close-lightbox-btn:hover { transform: scale(1.1) rotate(90deg); }

        /* --- Peeking Cat Animation --- */
        .peeking-cat { position: absolute; width: 60px; height: auto; pointer-events: none; animation: peek 5s ease-in-out infinite; fill: #d1d5db; filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.4)); z-index: -1;}
        #mobile-header-cat { top: 60%; right: -15px; width: 45px; animation-delay: 0.5s; transform-origin: top right; animation-name: mobile-peek; animation-timing-function: ease-in-out; animation-duration: 6s; }
        @keyframes peek { 0%, 30%, 100% { transform: translateY(100%) scaleX(-1); opacity: 0; } 40% { transform: translateY(-10px) scaleX(-1); opacity: 1; } 60% { transform: translateY(-5px) scaleX(-1); opacity: 1; } 70%, 90% { transform: translateY(-10px) scaleX(-1); opacity: 1; } }
        @keyframes mobile-peek { 0%, 30%, 100% { transform: translateY(0) rotate(15deg) scale(0.8); opacity: 0; } 40% { transform: translateY(-15px) rotate(0deg) scale(1); opacity: 1; } 60% { transform: translateY(-12px) rotate(0deg) scale(1); opacity: 1; } 70%, 90% { transform: translateY(-15px) rotate(0deg) scale(1); opacity: 1; } }

        /* --- Gacha Section Specifics --- */
        #gacha-result-container { position: relative; width: 100%; min-height: 50vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #gacha-image-wrapper { width: 100%; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: opacity 0.5s ease-in-out; z-index: var(--gacha-result-z-index); position: absolute; inset: 0; padding: 1rem; box-sizing: border-box; }
        #gacha-result-image { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 0.75rem; display: block; background-color: rgba(0,0,0,0.1); box-shadow: 0 5px 25px rgba(0,0,0, 0.3); }
        #gacha-image-wrapper.hidden { opacity: 0; pointer-events: none; }
        #gacha-placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--text-placeholder); z-index: var(--gacha-placeholder-z-index); text-align: center; transition: opacity 0.3s ease; }
        #gacha-placeholder.hidden { opacity: 0; pointer-events: none; }
        #gacha-error { position: absolute; bottom: 1rem; left: 1rem; right: 1rem; text-align: center; background: rgba(0, 0, 0, 0.7); padding: 0.75rem 1rem; border-radius: 0.5rem; color: var(--accent-red); z-index: var(--gacha-error-z-index); font-weight: 500; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s linear 0.3s; }
        #gacha-error.visible { opacity: 1; visibility: visible; transition: opacity 0.3s ease, visibility 0s linear 0s; }
        #gacha-actions { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
        #gacha-reset-button { padding: 0.6rem 1.2rem; background-color: rgba(255, 255, 255, 0.1); color: var(--text-secondary); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 99px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 0.4rem; }
        #gacha-reset-button:hover { background-color: rgba(255, 255, 255, 0.18); color: var(--text-primary); transform: scale(1.03); }
        #gacha-reset-button i { width: 1rem; height: 1rem; }
        #gacha-button:disabled { opacity: 0.6; cursor: not-allowed; background: var(--glass-bg); box-shadow: none; transform: none; }

        /* --- Enhanced Gacha Card Animation --- */
        #gacha-animation-container {
            position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
            perspective: 1000px; z-index: var(--gacha-anim-z-index); overflow: hidden; pointer-events: none; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0s linear 0.3s;
        }
        #gacha-animation-container.visible { opacity: 1; visibility: visible; transition: opacity 0.3s ease, visibility 0s linear 0s; }
        .gacha-spinner-card {
            width: 70px; height: 105px; background: var(--gacha-card-gradient);
            border-radius: 10px; margin: 0 8px; box-shadow: 0 6px 25px rgba(0,0,0,0.35);
            border: 1px solid rgba(255,255,255,0.1); opacity: 0;
            transform: translateY(150px) rotateY(180deg) scale(0.5);
            animation: gachaSpin 1.8s cubic-bezier(0.68, -0.6, 0.32, 1.6) forwards;
            position: relative; overflow: hidden;
        }
        .gacha-spinner-card::before {
            content: ''; position: absolute; top: 0; left: -80%; width: 60%; height: 100%;
            background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.35) 50%, rgba(255,255,255,0) 100%);
            transform: skewX(-25deg); animation: shine 1.8s cubic-bezier(0.68, -0.6, 0.32, 1.6) forwards;
            animation-delay: inherit;
        }
        @keyframes gachaSpin {
            0% { transform: translateY(150px) rotateY(180deg) scale(0.5); opacity: 0; }
            40% { transform: translateY(-20px) rotateY(0deg) scale(1.1); opacity: 1; }
            60% { transform: translateY(5px) rotateY(0deg) scale(0.95); opacity: 1; }
            80% { transform: translateY(0) rotateY(0deg) scale(1); opacity: 1; }
            100% { transform: translateY(-180px) rotateY(-180deg) scale(0.4); opacity: 0; }
        }
        @keyframes shine {
            0% { left: -80%; } 40% { left: 120%; } 100% { left: 120%; }
        }
        /* --- End Gacha Animation --- */

        /* --- Custom Modals --- */
        .custom-modal-overlay { position: fixed; inset: 0; background-color: rgba(10, 5, 15, 0.85); backdrop-filter: blur(8px); z-index: var(--modal-z-index); display: flex; align-items: center; justify-content: center; padding: 1rem; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s linear 0.3s; }
        .custom-modal-overlay.visible { opacity: 1; visibility: visible; transition: opacity 0.3s ease, visibility 0s linear 0s; }
        .custom-modal-content { background: var(--bg-dark-2); border: 1px solid var(--glass-border); padding: 1.5rem; border-radius: 1.2rem; max-width: 90vw; width: 100%; max-width: 450px; box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5); text-align: center; transform: scale(0.95); transition: transform 0.3s ease; border-image: linear-gradient(to bottom right, var(--accent-purple), var(--accent-magenta)) 1; word-wrap: break-word; position: relative; }
        .custom-modal-overlay.visible .custom-modal-content { transform: scale(1); }
        .custom-modal-close-btn { position: absolute; top: 0.75rem; right: 0.75rem; color: var(--text-secondary); background: none; border: none; padding: 0.25rem; cursor: pointer; transition: color 0.2s ease; }
        .custom-modal-close-btn:hover { color: var(--text-primary); }
        .custom-modal-close-btn i { width: 1.5rem; height: 1.5rem; }
        .custom-modal-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--text-primary); padding-right: 2rem; }
        .custom-modal-body { margin-bottom: 1.5rem; color: var(--text-secondary); line-height: 1.6; font-size: 0.95rem; }
        .custom-modal-actions { display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; margin-top: 1.5rem; }
        .modal-button { padding: 0.6rem 1.2rem; border-radius: 99px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; border: none; min-width: 100px; }
        .modal-button-primary { background: var(--accent-gradient); color: white; }
        .modal-button-primary:hover { background: var(--accent-gradient-hover); transform: scale(1.03); }
        .modal-button-secondary { background-color: rgba(255, 255, 255, 0.1); color: var(--text-secondary); border: 1px solid rgba(255, 255, 255, 0.15); }
        .modal-button-secondary:hover { background-color: rgba(255, 255, 255, 0.15); color: var(--text-primary); }

        /* --- Collection List/Modal Styles --- */
        .collection-list-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; background-color: rgba(255, 255, 255, 0.03); border-radius: 0.5rem; margin-bottom: 0.5rem; transition: background-color 0.2s ease, border-color 0.2s ease; border: 1px solid transparent; }
        .collection-list-item:hover { background-color: rgba(255, 255, 255, 0.06); border-color: var(--glass-border); }
        .collection-list-item .collection-name-wrapper { flex-grow: 1; margin-right: 1rem; overflow: hidden; cursor: pointer; }
        .collection-list-item .collection-name { font-weight: 500; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .collection-count { font-size: 0.8rem; color: var(--text-secondary); background-color: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 4px; flex-shrink: 0; }
        .collection-delete-btn { background: none; border: none; color: var(--accent-red); padding: 0.25rem; cursor: pointer; opacity: 0.7; transition: opacity 0.2s ease; flex-shrink: 0; }
        .collection-delete-btn:hover { opacity: 1; }
        .collection-delete-btn i { width: 1rem; height: 1rem; display: block; }
        #add-to-collection-modal-list { max-height: 25vh; overflow-y: auto; margin-bottom: 1rem; padding-right: 5px; border: 1px solid var(--glass-border); border-radius: 0.5rem; padding: 0.5rem; background: rgba(0,0,0,0.1);}
        #add-to-collection-modal-list::-webkit-scrollbar { width: 4px; }
        #add-to-collection-modal-list::-webkit-scrollbar-thumb { background: var(--accent-purple); border-radius: 2px; }
        .add-to-collection-item { display: flex; align-items: center; justify-content: space-between; width: 100%; text-align: left; padding: 0.6rem 1rem; border-radius: 0.375rem; cursor: pointer; transition: background-color 0.2s ease; color: var(--text-secondary); }
        .add-to-collection-item:hover { background-color: rgba(255, 255, 255, 0.1); color: var(--text-primary); }
        .add-to-collection-item .check-icon { color: var(--accent-green); display: none; margin-left: auto; flex-shrink: 0; }
        .add-to-collection-item.exists .check-icon { display: inline-block; }
        .add-to-collection-item span { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 0.5rem;}
        #add-create-collection-form { display: flex; flex-direction: column; sm:flex-row; gap: 0.75rem; margin-top: 1rem;}
        #add-new-collection-name { flex-grow: 1; padding: 0.75rem 1rem; border-radius: 0.5rem; background-color: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: var(--text-primary); }
        #add-create-collection-form button { flex-shrink: 0; }

        /* --- Settings Page Styles --- */
        .settings-data-group { margin-top: 1.5rem; padding: 1.2rem; background-color: rgba(0,0,0,0.2); border-radius: 0.75rem; border: 1px solid var(--glass-border); }
        .settings-data-group h3 { font-weight: 600; margin-bottom: 1rem; color: var(--text-secondary); font-size: 1rem; border-bottom: 1px solid var(--glass-border); padding-bottom: 0.75rem; }
        .settings-data-action { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding: 0.5rem 0; gap: 0.5rem;}
        .settings-data-action span { font-size: 0.95rem; margin-right: 1rem; }
        .clear-button { background-color: var(--accent-red); color: white; font-size: 0.8rem; padding: 0.3rem 0.7rem; border-radius: 0.375rem; transition: background-color 0.2s ease; flex-shrink: 0; cursor: pointer; border: none;}
        .clear-button:hover { background-color: #dc2626; }
        #api-selector-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-secondary); }
        #api-selector { width: 100%; padding: 0.75rem 1rem; border-radius: 0.5rem; background-color: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: var(--text-primary); cursor: pointer; appearance: none; -webkit-appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%23a8b2cc' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.7rem center; background-size: 1em; }
        #api-selector:focus { outline: none; border-color: var(--accent-purple); box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.4); }

        /* --- History Page Styles --- */
        .history-tab-btn { padding: 0.5rem 1.5rem; border-radius: 999px; font-weight: 500; transition: all 0.2s ease; color: var(--text-secondary); border: 1px solid transparent; cursor: pointer; }
        .history-tab-btn:hover { color: var(--text-primary); background-color: rgba(255, 255, 255, 0.05); border-color: rgba(255, 255, 255, 0.1); }
        .history-tab-btn.active { color: white; background: var(--accent-gradient); box-shadow: 0 2px 8px rgba(236, 72, 153, 0.25); border-color: transparent; }
        .history-empty { font-style: italic; }

        /* --- Toast Notifications --- */
        #toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: var(--toast-z-index); display: flex; flex-direction: column; gap: 0.75rem; align-items: flex-end; pointer-events: none;}
        .toast-item { pointer-events: auto; padding: 0.8rem 1.2rem; border-radius: 0.5rem; color: white; font-size: 0.9rem; font-weight: 500; box-shadow: 0 4px 15px rgba(0,0,0,0.3); opacity: 0; transform: translateX(100%); transition: opacity 0.4s ease, transform 0.4s cubic-bezier(0.215, 0.610, 0.355, 1); max-width: 300px; word-wrap: break-word; display: flex; align-items: center; gap: 0.5rem;}
        .toast-item.show { opacity: 1; transform: translateX(0); }
        .toast-item.success { background: linear-gradient(to right, var(--accent-green), #34d399); }
        .toast-item.error { background: linear-gradient(to right, var(--accent-red), #f87171); }
        .toast-item.info { background: linear-gradient(to right, var(--accent-blue), #93c5fd); }
        .toast-item i { flex-shrink: 0; }

        /* --- Gallery Error Message --- */
         #gallery-error { color: var(--accent-pink); font-weight: 500;}

    </style>
</head>

<body class="text-gray-200">
    
    <!-- Initial App Loader -->
    <div id="initial-loader">
        <div class="loader !w-16 !h-16 !border-4"></div>
        <p class="mt-4 text-lg text-gray-400">Menyiapkan NekoNime... <span class="uwu-text">‚ô°</span></p>
    </div>

    <!-- SVG Symbols Definition -->
    <svg width="0" height="0" style="position:absolute;z-index:-1;">
        <symbol id="cat-symbol" viewBox="0 0 100 100">
            <path d="M 20 90 C 20 70, 30 60, 50 60 S 80 70, 80 90 Z" fill="currentColor"/>
            <path d="M 20 65 L 30 40 L 40 65 Z" fill="currentColor"/>
            <path d="M 80 65 L 70 40 L 60 65 Z" fill="currentColor"/>
            <circle cx="40" cy="75" r="4" fill="#110c1b"/>
            <circle cx="60" cy="75" r="4" fill="#110c1b"/>
        </symbol>
    </svg>

    <!-- Main Application Container -->
    <div id="app-container">

        <!-- Header (Now Fixed) -->
        <header id="main-header" class="glassmorphism">
            <h1 id="header-title" class="text-xl lg:text-2xl font-bold text-white uwu-text" style="filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.5));">
                <a href="#gallery">NekoNime</a>
            </h1>
            
            <!-- Desktop Navigation -->
            <nav id="desktop-nav" class="hidden lg:flex items-center">
                <a href="#gallery" class="nav-link" data-page="gallery" title="Galeri Moe~"><i data-lucide="layout-grid"></i></a>
                <a href="#random-girl" class="nav-link" data-page="random-girl" title="Gacha Keberuntungan Universal! ‚ô°"><i data-lucide="gift"></i></a>
                <a href="#favorites" class="nav-link" data-page="favorites" title="Favorit Kesayangan üíñ"><i data-lucide="heart"></i></a>
                <a href="#history" class="nav-link" data-page="history" title="Jejak Petualanganmu üìú"><i data-lucide="history"></i></a>
                <a href="#collections" class="nav-link" data-page="collections" title="Koleksi Pribadimu üìö"><i data-lucide="library"></i></a>
                <a href="#social" class="nav-link disabled" data-page="social" title="Temu Kangen (Segera Hadir!)"><i data-lucide="share-2"></i></a>
                <a href="#about" class="nav-link" data-page="about" title="Tentang NekoNime Uwu~"><i data-lucide="info"></i></a>
                <a href="#settings" class="nav-link" data-page="settings" title="Setelan Manja ‚ú®"><i data-lucide="settings"></i></a>
            </nav>

            <!-- Desktop Authentication Container -->
            <div id="auth-container-desktop" class="auth-container hidden lg:flex">
                <!-- Content will be injected by JavaScript -->
            </div>

            <!-- Mobile Menu Toggle -->
            <button id="mobile-menu-toggle" class="p-2 rounded-full hover:bg-white/10 active:bg-white/20 transition-colors duration-150 lg:hidden">
                <i data-lucide="cat" class="w-7 h-7 text-pink-300"></i>
                <svg class="peeking-cat" id="mobile-header-cat"><use xlink:href="#cat-symbol"></use></svg>
            </button>
        </header>

        <!-- Content Wrapper (Takes remaining height after fixed header) -->
        <div id="content-wrapper">
            <!-- Main Content Scrolling Area (Has padding-top) -->
            <div id="main-content-area">
                <main id="main-content">

                    <!-- Page: Gallery -->
                    <section id="page-gallery" class="page hidden">
                        <h2 class="text-3xl font-semibold mb-3 text-center uwu-text mt-0">Galeri Ilustrasi <span class="text-lg">‚ú®Nyaa~‚ú®</span></h2>
                        <div id="category-selector-container" class="px-2 flex flex-wrap justify-center gap-2 mb-6"></div>
                        <p class="text-center mb-6 text-gray-400 text-sm">Klik gambar buat intip lebih dekat, <span class="uwu-text">Sayang ‚ô°</span>. Klik ikon ‚ô° atau ‚ûï buat aksi cepat ya~</p>
                        <div id="gallery-loader" class="loader hidden"></div>
                        <div id="gallery-grid" class="masonry-grid"></div>
                        <div id="gallery-error" class="text-center mt-6 hidden px-4 text-lg"></div>
                        <!-- Load More Container - Selalu ADA di halaman Galeri! -->
                        <div id="load-more-container">
                            <button id="load-more-btn">
                                <span id="load-more-btn-text">Muat Lebih Banyak Manisnya~</span>
                                <span id="load-more-spinner-text" class="hidden">Lagi ambil gambar uwu...</span>
                                <div id="load-more-spinner" class="loader !w-5 !h-5 !border-2 !m-0"></div>
                            </button>
                        </div>
                    </section>

                    <!-- Page: History -->
                    <section id="page-history" class="page hidden">
                        <h2 class="text-3xl font-semibold mb-6 text-center uwu-text mt-0">History Petualanganmu <span class="text-lg">üìúüï∞Ô∏è</span></h2>
                        <div class="flex justify-center gap-4 mb-6 border-b border-[var(--glass-border)] pb-3">
                            <button id="history-tab-browse" class="history-tab-btn active" data-target="history-browse-content">Jelajah ‚ú®</button>
                            <button id="history-tab-gacha" class="history-tab-btn" data-target="history-gacha-content">Gacha üé∞</button>
                        </div>
                        <div id="history-browse-content" class="history-content">
                            <p class="text-center mb-4 text-gray-400 text-sm">Gambar-gambar <span class="uwu-text">gemes</span> yang udah kamu intip~</p>
                            <div id="history-browse-loader" class="loader hidden"></div>
                            <div id="history-browse-grid" class="masonry-grid"></div>
                            <p id="history-browse-empty" class="history-empty text-center text-gray-400 mt-6 hidden" data-empty-message="History jelajahmu masih kosong nih... (ÔΩ°‚Ä¢ÃÅÔ∏ø‚Ä¢ÃÄÔΩ°) Ayo jelajahi galerinya~">.</p>
                        </div>
                        <div id="history-gacha-content" class="history-content hidden">
                            <p class="text-center mb-4 text-gray-400 text-sm">Hasil Gacha <span class="uwu-text">keberuntunganmu</span> yang pernah didapat!</p>
                            <div id="history-gacha-loader" class="loader hidden"></div>
                            <div id="history-gacha-grid" class="masonry-grid"></div>
                            <p id="history-gacha-empty" class="history-empty text-center text-gray-400 mt-6 hidden" data-empty-message="Belum pernah Gacha yaa? (¬¨_¬¨ ) Coba keberuntunganmu sekarang!">.</p>
                        </div>
                    </section>

                    <!-- Page: Collections -->
                    <section id="page-collections" class="page hidden">
                        <h2 class="text-3xl font-semibold mb-4 text-center uwu-text mt-0">Koleksi Pribadimu <span class="text-lg">üìöüíñ</span></h2>
                        <div id="collections-main-view">
                            <p class="text-center mb-4 text-gray-400">Atur koleksi gambar <span class="uwu-text">kesayanganmu</span> di sini!</p>
                            <div class="max-w-2xl mx-auto mb-6">
                                <form id="create-collection-form" class="flex gap-2">
                                    <input type="text" id="new-collection-name" placeholder="Nama Koleksi Baru yang Manis..." required class="flex-grow p-2.5 rounded-lg bg-black/30 border border-white/10 focus:outline-none focus:ring-2 focus:ring-[var(--accent-magenta)] text-gray-200 placeholder-gray-500">
                                    <button type="submit" class="text-white font-bold py-2.5 px-5 rounded-lg transition-colors bg-[var(--accent-gradient)] hover:bg-[var(--accent-gradient-hover)] shadow-md flex items-center gap-1">
                                        <i data-lucide="plus" class="w-5 h-5"></i> Bikin!
                                    </button>
                                </form>
                            </div>
                            <div id="collection-list-loader" class="loader hidden"></div>
                            <div id="collection-list" class="max-w-2xl mx-auto space-y-2"></div>
                            <p id="collection-list-empty" class="history-empty text-center text-gray-400 mt-6 hidden" data-empty-message="Kamu belum punya koleksi... Œ£(¬∞„É≠¬∞) Buat satu yuk pakai tombol di atas! ‚Üë">.</p>
                        </div>
                        <div id="collection-detail-view" class="hidden">
                            <button id="back-to-collections-btn" class="mb-4 flex items-center gap-1 text-sm text-purple-300 hover:text-purple-100">
                                <i data-lucide="arrow-left" class="w-4 h-4"></i> Kembali ke Daftar Koleksi
                            </button>
                            <h3 id="collection-detail-title" class="text-2xl font-semibold mb-4 text-center uwu-text"></h3>
                            <div id="collection-image-loader" class="loader hidden"></div>
                            <div id="collection-image-grid" class="masonry-grid"></div>
                            <p id="collection-image-empty" class="history-empty text-center text-gray-400 mt-6 hidden" data-empty-message="Koleksi ini masih kosong melompong („Å£¬¥œâ`)Ôæâ(‚ï•œâ‚ï•). Yuk, tambahkan gambar favoritmu!">.</p>
                        </div>
                    </section>

                    <!-- Page: Favorites -->
                    <section id="page-favorites" class="page hidden">
                        <h2 class="text-3xl font-semibold mb-6 text-center uwu-text mt-0">Favorit Kesayanganmu <span class="text-lg">üíñüòç</span></h2>
                        <p class="text-center mb-6 text-gray-400">Ini dia koleksi waifu/husbando <span class="uwu-text">paling top</span> pilihanmu~ Kyaa!</p>
                        <div id="favorites-loader" class="loader hidden"></div>
                        <div id="favorites-grid" class="masonry-grid"></div>
                        <p id="favorites-empty" class="history-empty text-center text-gray-400 mt-6 hidden" data-empty-message="Ehh? Belum ada favorit? ( T –¥ T ) Jangan malu-malu, klik ikon hati ‚ô° di gambar yang kamu suka ya!">.</p>
                    </section>

                     <!-- Page: Gacha (Universal Gacha, Tanpa Cooldown!) -->
                    <section id="page-random-girl" class="page hidden flex flex-col items-center justify-center text-center">
                        <h2 class="text-3xl font-semibold mb-6 uwu-text mt-0">Gacha Universal NekoNime! <span class="text-lg">üé∞üíñ</span></h2>
                        <p class="mb-6 text-gray-400 max-w-md mx-auto">Siap-siap dapet kejutan <span class="uwu-text">moe acak</span> dari SEMUA kategori di API <strong id="gacha-api-name" class="text-purple-300">ini</strong>! Semoga dapet waifu/husbando idaman~ <span class="uwu-text">(Klik secepatnya boleh kok!)</span></p>

                        <!-- Gacha Buttons Container -->
                        <div id="gacha-actions" class="w-full max-w-lg flex flex-col sm:flex-row items-center justify-center gap-4 mb-6">
                            <button id="gacha-button" class="text-white font-bold py-3 px-8 rounded-full shadow-lg transform hover:scale-105 transition duration-300 ease-in-out text-lg relative overflow-hidden bg-[var(--accent-gradient)] hover:bg-[var(--accent-gradient-hover)] !shadow-magenta-500/30 hover:!shadow-magenta-500/40 flex-shrink-0">
                                <span class="relative z-10 flex items-center gap-2"><i data-lucide="dices" class="w-5 h-5"></i> Gacha Sekarang!</span>
                            </button>
                            <button id="gacha-reset-button" class="hidden text-sm flex-shrink-0">
                                <i data-lucide="rotate-ccw"></i> Reset?
                            </button>
                        </div>

                        <!-- Gacha Result Container -->
                        <div class="w-full max-w-lg flex flex-col items-center">
                            <div id="gacha-result-container" class="w-full flex flex-col items-center justify-center min-h-[50vh] glassmorphism p-4 rounded-xl relative overflow-hidden">
                                <!-- Gacha Animation (Plays on demand with enhanced style) -->
                                <div id="gacha-animation-container" class="hidden">
                                    <!-- Cards generated by JS -->
                                </div>
                                <!-- Image Wrapper (Clickable for Lightbox) -->
                                <div id="gacha-image-wrapper" class="hidden opacity-0">
                                    <img id="gacha-result-image" src="" alt="Hasil Gacha Anime Uwu~" />
                                </div>
                                <!-- Placeholder Text -->
                                <p id="gacha-placeholder">
                                    Ayo tekan tombol Gacha di atas!<br><span class="uwu-text text-sm">(Semoga beruntung yaa ‚ô°)</span>
                                </p>
                                <!-- Error Message -->
                                <p id="gacha-error" class="hidden">Aduuh, Gachanya lagi ngambek nih...</p>
                            </div>
                        </div>
                    </section>

                    <!-- Page: Settings -->
                    <section id="page-settings" class="page hidden glassmorphism p-6 max-w-xl mx-auto rounded-xl">
                        <h2 class="text-3xl font-semibold mb-6 text-center uwu-text mt-0">Setelan Manja <span class="text-lg">‚öôÔ∏èüîß</span></h2>
                        <p class="text-center mb-8 text-gray-400">Atur NekoNime <span class="uwu-text">sesuai seleramu</span> di sini~</p>
                        <div class="settings-data-group mb-6">
                            <h3>Sumber Gambar Galeri & Gacha (API) <span class="uwu-text">‚ô°</span></h3>
                            <label id="api-selector-label" for="api-selector">Pilih API buat Galeri & Gacha:</label>
                            <select id="api-selector" class="w-full p-2.5 rounded-lg bg-black/30 border border-white/10 focus:outline-none focus:ring-2 focus:ring-[var(--accent-purple)] text-gray-200 cursor-pointer">
                            </select>
                            <p class="text-xs text-gray-500 mt-2">Ganti API bakal muat ulang galeri & ganti sumber gacha, <span class="uwu-text">sayang</span>.</p>
                        </div>
                        <div class="settings-data-group">
                             <h3>Manajemen Data <span class="uwu-text">(Hati-hati!)</span></h3>
                             <p class="text-sm text-gray-400 mb-4">Aksi ini akan mempengaruhi data di <strong class="text-yellow-300">perangkat ini (lokal)</strong> dan juga di <strong class="text-blue-300">cloud (jika kamu login)</strong>.</p>
                            <div class="settings-data-action"><span>History Jelajah</span> <button id="clear-history-browse-btn" class="clear-button">Hapus</button></div>
                            <div class="settings-data-action"><span>History Gacha</span> <button id="clear-history-gacha-btn" class="clear-button">Hapus</button></div>
                            <div class="settings-data-action"><span>Favorit Kesayangan</span> <button id="clear-favorites-btn" class="clear-button">Hapus</button></div>
                            <div class="settings-data-action"><span>Semua Koleksi</span> <button id="clear-collections-btn" class="clear-button">Hapus</button></div>
                            <div class="mt-4 pt-4 border-t border-[var(--glass-border)] flex justify-center">
                                <button id="clear-all-data-btn" class="bg-gradient-to-r from-red-600 to-pink-700 hover:from-red-700 hover:to-pink-800 text-white text-sm font-medium py-1.5 px-4 rounded-md transition-all duration-200 flex items-center gap-1.5 shadow-md hover:shadow-lg">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i> Hapus SEMUA Data!?
                                </button>
                            </div>
                            <p class="text-xs text-center text-gray-500 mt-3">(*Tindakan Hapus ini <strong class="text-red-400">permanen</strong> lho! Yakin nih?)</p>
                        </div>
                    </section>

                    <!-- Page: About -->
                    <section id="page-about" class="page hidden glassmorphism p-6 max-w-3xl mx-auto rounded-xl">
                        <h2 class="text-3xl font-bold mb-4 text-center uwu-text mt-0">Tentang NekoNime <span class="text-lg">(Ôæâ¬¥„ÉÆ¬¥)Ôæâ*:ÔΩ•Ôæü‚úß</span></h2>
                        <div class="flex justify-center mb-4">
                            <svg class="w-16 h-16" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" style="filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));">
                                <defs><linearGradient id="chibiHair2" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#fbcfe8"/><stop offset="100%" stop-color="#f9a8d4"/></linearGradient></defs>
                                <circle cx="50" cy="45" r="35" fill="url(#chibiHair2)" />
                                <circle cx="38" cy="40" r="6" fill="#271c2e"/>
                                <circle cx="62" cy="40" r="6" fill="#271c2e"/>
                                <path d="M 40 55 Q 50 65 60 55" stroke="#e11d48" fill="none" stroke-width="3" stroke-linecap="round"/>
                                <path d="M 20 25 Q 30 5 40 25 Z" fill="url(#chibiHair2)" stroke="#4a044e" stroke-width="1.5"/>
                                <path d="M 80 25 Q 70 5 60 25 Z" fill="url(#chibiHair2)" stroke="#4a044e" stroke-width="1.5"/>
                            </svg>
                        </div>
                         <p class="mb-4 text-lg leading-relaxed text-center">
                            Halooo Minna-san~ <span class="uwu-text">(‚âß‚àá‚â¶)/</span> Selamat datang di <strong class="font-semibold text-purple-300">NekoNime</strong>! Tempat paling <em class="uwu-text font-medium">uwu</em> dan <em class="uwu-text font-medium">kawaii</em> di jagat web buat kamu para pecinta anime sejati! <span class="uwu-text">‚ô°‡∂©‚åî‡∂©‚ô°</span>
                        </p>
                        <p class="mb-4 text-gray-300 leading-relaxed text-center">
                            Dibuat dengan penuh cinta <span class="uwu-text">(¬¥ÔΩ°‚Ä¢ ·µï ‚Ä¢ÔΩ°`) ‚ô°</span>, NekoNime hadir biar kamu bisa cuci mata liat ilustrasi anime <strong class="text-purple-300">keren, moe, waifu/husbando-able</strong> dari berbagai sumber API pilihan (sekarang kategorinya makin banyak lho~!). Tampilannya <em class="text-cyan-300">modern next-gen</em> pake <em class="text-blue-300">glassmorphism</em> di atas tema <strong class="text-gray-400">dark mode</strong> yang nyaman di mata, biar betah lama-lama di sini~
                        </p>
                        <p class="mb-4 text-gray-300 leading-relaxed text-center">
                            Fitur andalan kita yang <span class="uwu-text">bikin gemes</span>:
                            <ul class="list-none text-center mt-2 space-y-1 text-gray-400">
                                <li><i data-lucide="cloud" class="inline-block w-4 h-4 text-blue-300 mr-1"></i> <strong class="text-blue-300">Login & Cloud Save</strong> (<span class="uwu-text">Data aman di awan!</span>)</li>
                                <li><i data-lucide="layout-grid" class="inline-block w-4 h-4 text-purple-300 mr-1"></i> Galeri <strong class="text-purple-300">Super Lengkap</strong> (<span class="uwu-text">SFW/NSFW, pilih API & kategori bejibun!</span>)</li>
                                <li><i data-lucide="gift" class="inline-block w-4 h-4 text-pink-400 mr-1"></i> <strong class="text-pink-300">Gacha Universal</strong> (<span class="uwu-text">acak dari semua kategori API, tanpa cooldown!‚ö° Animasi baru!</span>)</li>
                                <li><i data-lucide="chevrons-down" class="inline-block w-4 h-4 text-yellow-400 mr-1"></i> Tombol Muat Lebih Banyak <strong class="text-yellow-300">Sepuasnya</strong>! (<span class="uwu-text">Anti-ngilang, klik terus!</span>)</li>
                                <li><i data-lucide="library" class="inline-block w-4 h-4 text-blue-400 mr-1"></i> Bikin Koleksi Pribadi (<span class="uwu-text">harta karunmu!</span>)</li>
                                <li><i data-lucide="heart" class="inline-block w-4 h-4 text-red-400 mr-1"></i> Simpan Favorit (<span class="uwu-text">buat yang spesial!</span>)</li>
                                <li><i data-lucide="history" class="inline-block w-4 h-4 text-indigo-400 mr-1"></i> Riwayat Jelajah & Gacha (<span class="uwu-text">kenangan manismu~</span>)</li>
                                <li><i data-lucide="maximize-2" class="inline-block w-4 h-4 text-green-400 mr-1"></i> Lightbox Detail Gambar (<span class="uwu-text">lebih dekat lebih mesra!</span>)</li>
                                <li><i data-lucide="server" class="inline-block w-4 h-4 text-teal-400 mr-1"></i> Pilihan Sumber API (<span class="uwu-text">atur seleramu!</span>)</li>
                                <li><i data-lucide="panel-top" class="inline-block w-4 h-4 text-cyan-400 mr-1"></i> Navbar <strong class="text-cyan-300">Tetap di Atas</strong> (<span class="uwu-text">selalu setia menemani!</span>)</li>
                                <li><i data-lucide="mouse-pointer-click" class="inline-block w-4 h-4 text-lime-400 mr-1"></i> Scroll <strong class="text-lime-300">Lancar Jaya</strong> (<span class="uwu-text">gak nyangkut lagi!</span>)</li>
                            </ul>
                        </p>
                        <p class="text-gray-300 leading-relaxed text-center">
                            Semua keajaiban ini berjalan mulus pakai <strong class="text-red-400">Firebase</strong>, <strong class="text-teal-300">Tailwind CSS</strong> & <strong class="text-yellow-300">JavaScript</strong> murni dalam <em class="text-green-300">Single Page Application (SPA)</em>. Cepat, ringan, dan <span class="uwu-text">uwu</span> pastinya! <span class="uwu-text">(„Å•Ôø£ ¬≥Ôø£)„Å•</span> Jangan lupa kasih feedback ya kalau ada ide!
                        </p>
                        <p class="mt-6 text-center text-sm text-gray-400">
                            Versi 9.5.1 | Dibuat dengan <i data-lucide="sparkles" class="inline-block w-4 h-4 text-yellow-400"></i> oleh <span class="font-semibold text-purple-300">Delta Astra</span>.
                            Makasih udah mampir~! <span class="uwu-text">(‚åí‚ñΩ‚åí)‚òÜ</span>
                        </p>
                    </section>

                    <!-- Page: Social (Placeholder) -->
                    <section id="page-social" class="page hidden">
                        <h2 class="text-3xl font-semibold mb-6 text-center uwu-text mt-0">Segera Hadir Lho~! <span class="text-lg">(oÀò‚ó°Àòo)</span></h2>
                        <div class="flex flex-col items-center justify-center text-center text-gray-500 glassmorphism p-8 rounded-xl max-w-lg mx-auto">
                            <i data-lucide="construction" class="w-16 h-16 mb-4 text-yellow-400 animate-bounce"></i>
                            <p class="font-semibold text-lg text-gray-300 mb-2">Fitur Sosial Sedang Dimasak!</p>
                            <p>Nantikan update selanjutnya yaa, biar bisa <span class="uwu-text">kumpul bareng</span> sesama NekoNime Enjoyer! <span class="uwu-text">‚òÜ*:.ÔΩ°.o(‚âß‚ñΩ‚â¶)o.ÔΩ°.:*‚òÜ</span> Sabar dikit yaa~</p>
                        </div>
                    </section>

                </main>
            </div> <!-- End #main-content-area -->
        </div> <!-- End #content-wrapper -->

        <!-- Mobile Navigation Overlay -->
        <div id="mobile-nav-overlay">
            <button id="close-mobile-nav-btn" class="absolute top-6 right-6 text-gray-300 hover:text-white z-50">
                <i data-lucide="x" class="w-8 h-8"></i>
            </button>
            <div id="mobile-nav-links" class="glassmorphism">
                <a href="#gallery" data-page="gallery" class="nav-link block w-full text-center py-3 px-5 font-medium">Galeri Moe~</a>
                <a href="#random-girl" data-page="random-girl" class="nav-link block w-full text-center py-3 px-5 font-medium">Gacha Hoki ‚ô°</a>
                <a href="#favorites" data-page="favorites" class="nav-link block w-full text-center py-3 px-5 font-medium">Favorit üíñ</a>
                <a href="#history" data-page="history" class="nav-link block w-full text-center py-3 px-5 font-medium">History üìú</a>
                <a href="#collections" data-page="collections" class="nav-link block w-full text-center py-3 px-5 font-medium">Koleksi üìö</a>
                <a href="#social" data-page="social" class="nav-link block w-full text-center py-3 px-5 font-medium disabled relative">Sosial (Soon!)</a>
                <a href="#about" data-page="about" class="nav-link block w-full text-center py-3 px-5 font-medium">Tentang ‚ú®</a>
                <a href="#settings" data-page="settings" class="nav-link block w-full text-center py-3 px-5 font-medium">Setelan ‚öôÔ∏è</a>
                
                <!-- Mobile Authentication Container -->
                <div id="auth-container-mobile" class="mobile-auth-container">
                    <!-- Content will be injected by JavaScript -->
                </div>

                <button id="feedback-button-mobile" class="mt-4 text-sm text-purple-300 hover:text-purple-100 transition-colors py-2 flex items-center gap-1 justify-center w-full">
                    <i data-lucide="message-circle-question" class="w-4 h-4"></i> Kirim Masukanmu~
                </button>
            </div>
        </div>

        <!-- Feedback Modal -->
        <div id="feedback-modal" class="custom-modal-overlay">
            <div class="custom-modal-content">
                <button id="close-feedback-modal" class="custom-modal-close-btn"> <i data-lucide="x"></i> </button>
                <h3 class="custom-modal-title uwu-text">Bisikin Sesuatu? <span class="text-base">(¬¥‚Ä¢ œâ ‚Ä¢`) ‚ô°</span></h3>
                <p class="custom-modal-body">Saran, kritik, atau nemu bug aneh? Kasih tau dong~ Masukanmu berharga banget lho!</p>
                <form id="feedback-form">
                    <textarea id="feedback-message" rows="4" class="w-full p-3 rounded-lg bg-black/30 border border-white/10 focus:outline-none focus:ring-2 focus:ring-[var(--accent-magenta)] text-gray-200 placeholder-gray-500 mb-4" placeholder="Tulis uneg-unegmu di sini..." required></textarea>
                    <button type="submit" class="modal-button modal-button-primary w-full"> Kirim Bisikan! </button>
                </form>
                <p id="feedback-status" class="text-center text-sm mt-3"></p>
            </div>
        </div>

        <!-- Lightbox Modal -->
        <div id="lightbox-modal" onclick="closeLightbox()">
            <div id="lightbox-content" onclick="event.stopPropagation()">
                <button id="close-lightbox-btn" onclick="closeLightbox()"> <i data-lucide="x" class="w-4 h-4"></i> </button>
                <img id="lightbox-image" src="" alt="Anime Illustration Detail Uwu~">
                <div id="lightbox-details">
                    Art oleh <span id="lightbox-artist" class="uwu-text"></span>
                    <a id="lightbox-source" href="#" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()" title="Kunjungi Sumber Asli!">
                        <i data-lucide="external-link" class="inline-block w-4 h-4"></i> Sumber
                    </a>
                </div>
                <div id="lightbox-actions">
                    <button id="lightbox-favorite-btn" class="flex items-center gap-1">
                        <i data-lucide="heart" class="w-4 h-4"></i> <span>Favorit</span>
                    </button>
                    <button id="lightbox-add-collection-btn" class="flex items-center gap-1">
                        <i data-lucide="plus-square" class="w-4 h-4"></i> <span>Tambah ke Koleksi</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Add to Collection Modal -->
        <div id="add-to-collection-modal" class="custom-modal-overlay">
            <div class="custom-modal-content">
                <button id="close-add-to-collection-modal" class="custom-modal-close-btn"> <i data-lucide="x"></i> </button>
                <h3 class="custom-modal-title uwu-text">Mau Simpan Kemana Nih? ‚ô°</h3>
                <p class="custom-modal-body !mb-3">Pilih koleksi yang udah ada atau buat baru yang <span class="uwu-text">lebih spesial~</span></p>
                <div id="add-to-collection-modal-list"></div>
                <p id="add-to-collection-empty" class="history-empty text-sm text-gray-500 my-4 hidden" data-empty-message="Yah.. belum ada koleksi („Å£ÀòÃ©‚ï≠‚ïÆÀòÃ©)„Å£ Bikin baru dulu yuk ‚Üì">Belum ada koleksi.</p>
                <form id="add-create-collection-form" class="flex flex-col sm:flex-row gap-2 mt-4">
                    <input type="text" id="add-new-collection-name" placeholder="Atau ketik nama koleksi baru di sini..." class="flex-grow p-2 rounded-lg bg-black/30 border border-white/10 focus:outline-none focus:ring-1 focus:ring-[var(--accent-magenta)] text-gray-200 placeholder-gray-500 text-sm w-full sm:w-auto">
                    <button type="submit" class="modal-button modal-button-primary !px-4 !py-2 text-sm flex items-center gap-1 justify-center w-full sm:w-auto flex-shrink-0">
                        <i data-lucide="plus" class="w-4 h-4"></i> Bikin & Tambah!
                    </button>
                </form>
            </div>
        </div>

        <!-- Alert Modal -->
        <div id="alert-modal" class="custom-modal-overlay">
            <div class="custom-modal-content">
                <button class="custom-modal-close-btn" onclick="closeAlertModal()"> <i data-lucide="x"></i> </button>
                <h3 id="alert-modal-title" class="custom-modal-title uwu-text">Info Penting! ‚ú®</h3>
                <p id="alert-modal-body" class="custom-modal-body">Msg.</p>
                <div class="custom-modal-actions">
                    <button id="alert-modal-ok" class="modal-button modal-button-primary">Oke Deh!</button>
                </div>
            </div>
        </div>

        <!-- Confirm Modal -->
        <div id="confirm-modal" class="custom-modal-overlay">
            <div class="custom-modal-content">
                <button class="custom-modal-close-btn" onclick="closeConfirmModal()"> <i data-lucide="x"></i> </button>
                <h3 id="confirm-modal-title" class="custom-modal-title uwu-text">Konfirmasi Dulu Dong~ ü§î</h3>
                <p id="confirm-modal-body" class="custom-modal-body">Yakin nih mau lanjut?</p>
                <div class="custom-modal-actions">
                    <button id="confirm-modal-cancel" class="modal-button modal-button-secondary">Eh, Nggak Jadi!</button>
                    <button id="confirm-modal-ok" class="modal-button modal-button-primary">Iya, Yakin!</button>
                </div>
            </div>
        </div>

        <!-- Toast Notification Container -->
        <div id="toast-container"></div>

    </div> <!-- End #app-container -->

    <!-- MERGED JAVASCRIPT: Firebase + App Logic -->
    <script type="module">
        // --- FIREBASE INITIALIZATION ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB1ckKXbGKjfMi2M_hT6ut3bbuXHotPFmE",
            authDomain: "nekonime-phi.firebaseapp.com",
            projectId: "nekonime-phi",
            storageBucket: "nekonime-phi.appspot.com",
            messagingSenderId: "32265704368",
            appId: "1:32265704368:web:1b7d19214fae873e3fbc75",
            measurementId: "G-RXC8MJR2B6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- APP LOGIC ---

        // --- Constants and Configuration ---
        const GALLERY_IMAGES_PER_LOAD = 24;
        const HISTORY_MAX_ITEMS = 50;
        const FEEDBACK_EMAIL = "deltaastra24@gmail.com";
        const FETCH_TIMEOUT = 20000;
        const GACHA_ANIMATION_BASE_DURATION = 1800;
        const GACHA_ANIMATION_STAGGER_DELAY = 150;

        // --- API Configuration ---
        const API_CONFIG = {
            nekos: { name: 'Nekos.best', baseUrl: 'https://nekos.best/api/v2/', categories: [ { name: "Waifu Tercinta ‚ô°", endpoint: "waifu" }, { name: "Neko Gemes üêæ", endpoint: "neko" }, { name: "Husbu Idaman ‚ú®", endpoint: "husbando" }, { name: "Kitsune Cerdik ü¶ä", endpoint: "kitsune" }, { name: "Senyum Manis üòä", endpoint: "smile" }, { name: "Peluk Hangat ü§ó", endpoint: "cuddle" }, { name: "Cium Mesra üòò", endpoint: "kiss" }, { name: "Tampar Manja üëã", endpoint: "slap" }, { name: "Elus Kepala üëã", endpoint: "pat" }, { name: "Gigit Gemes >.<", endpoint: "bite" }, { name: "Malu-maluüò≥", endpoint: "blush" }, { name: "Kedip Nakal üòâ", endpoint: "wink" }, { name: "Manyun Lucu üòó", endpoint: "pout" }, { name: "Tos Semangat üôå", endpoint: "highfive" }, { name: "Menari Ria üíÉ", endpoint: "dance" }, ], allEndpoints: [ "waifu", "neko", "husbando", "kitsune", "smile", "cuddle", "kiss", "lick", "pat", "smug", "bonk", "yeet", "blush", "smile", "wave", "highfive", "handhold", "nom", "bite", "glomp", "slap", "kill", "kick", "happy", "wink", "poke", "dance", "cringe", "baka", "bored", "cry", "feed", "hug", "laugh", "poke", "pout", "shrug", "sleep", "stare", "think", "thumbsup", "tickle", "tired", "wink" ], defaultGachaCategory: 'waifu', parser: (data) => { const item = data?.results?.[0] || data; if (item?.url) { const artistName = item.artist_name ? String(item.artist_name) : 'Artis Misterius (nekos.best)'; const sourceUrl = item.source_url ? String(item.source_url) : item.url; return { url: item.url, artist_name: artistName, source_url: sourceUrl, apiSource: 'nekos' }; } return null; } },
            waifupics: { name: 'waifu.pics', baseUrl: 'https://api.waifu.pics/', categories: [ { name: 'Waifu (SFW)', endpoint: 'sfw/waifu'}, { name: 'Neko (SFW)', endpoint: 'sfw/neko'}, { name: 'Shinobu', endpoint: 'sfw/shinobu'}, { name: 'Megumin', endpoint: 'sfw/megumin'}, { name: 'Peluk (SFW)', endpoint: 'sfw/hug'}, { name: 'Cium (SFW)', endpoint: 'sfw/kiss'}, { name: 'Elus (SFW)', endpoint: 'sfw/pat'}, { name: 'Senyum (SFW)', endpoint: 'sfw/smile'}, { name: 'Waifu (NSFW) üî•', endpoint: 'nsfw/waifu'}, { name: 'Neko (NSFW) üî•', endpoint: 'nsfw/neko'}, { name: 'Trap (NSFW) ü§´', endpoint: 'nsfw/trap'}, { name: 'Blowjob (NSFW) üîû', endpoint: 'nsfw/blowjob'} ], allEndpoints: [ 'sfw/waifu', 'sfw/neko', 'sfw/shinobu', 'sfw/megumin', 'sfw/bully', 'sfw/cuddle', 'sfw/cry', 'sfw/hug', 'sfw/awoo', 'sfw/kiss', 'sfw/lick', 'sfw/pat', 'sfw/smug', 'sfw/bonk', 'sfw/yeet', 'sfw/blush', 'sfw/smile', 'sfw/wave', 'sfw/highfive', 'sfw/handhold', 'sfw/nom', 'sfw/bite', 'sfw/glomp', 'sfw/slap', 'sfw/kill', 'sfw/kick', 'sfw/happy', 'sfw/wink', 'sfw/poke', 'sfw/dance', 'sfw/cringe', 'nsfw/waifu', 'nsfw/neko', 'nsfw/trap', 'nsfw/blowjob' ], defaultGachaCategory: 'sfw/waifu', parser: (data) => { if (data?.url) { return { url: data.url, artist_name: 'Artis Misterius (waifu.pics)', source_url: data.url, apiSource: 'waifupics' }; } return null; } }
        };

        // --- DOM Element References ---
        const initialLoader = document.getElementById('initial-loader');
        const appContainer = document.getElementById('app-container');
        const addCreateCollectionForm = document.getElementById('add-create-collection-form');
        const addNewCollectionNameInput = document.getElementById('add-new-collection-name');
        const addToCollectionEmpty = document.getElementById('add-to-collection-empty');
        const addToCollectionModal = document.getElementById('add-to-collection-modal');
        const addToCollectionModalList = document.getElementById('add-to-collection-modal-list');
        const alertModal = document.getElementById('alert-modal');
        const alertModalBody = document.getElementById('alert-modal-body');
        const alertModalOk = document.getElementById('alert-modal-ok');
        const alertModalTitle = document.getElementById('alert-modal-title');
        const apiSelector = document.getElementById('api-selector');
        const authContainerDesktop = document.getElementById('auth-container-desktop');
        const authContainerMobile = document.getElementById('auth-container-mobile');
        const backToCollectionsBtn = document.getElementById('back-to-collections-btn');
        const categorySelectorContainer = document.getElementById('category-selector-container');
        const clearAllDataBtn = document.getElementById('clear-all-data-btn');
        const clearCollectionsBtn = document.getElementById('clear-collections-btn');
        const clearFavoritesBtn = document.getElementById('clear-favorites-btn');
        const clearHistoryBrowseBtn = document.getElementById('clear-history-browse-btn');
        const clearHistoryGachaBtn = document.getElementById('clear-history-gacha-btn');
        const closeAddToCollectionModalBtn = document.getElementById('close-add-to-collection-modal');
        const closeFeedbackModalButton = document.getElementById('close-feedback-modal');
        const closeMobileNavBtn = document.getElementById('close-mobile-nav-btn');
        const collectionDetailTitle = document.getElementById('collection-detail-title');
        const collectionDetailView = document.getElementById('collection-detail-view');
        const collectionImageEmpty = document.getElementById('collection-image-empty');
        const collectionImageGrid = document.getElementById('collection-image-grid');
        const collectionImageLoader = document.getElementById('collection-image-loader');
        const collectionListContainer = document.getElementById('collection-list');
        const collectionListEmpty = document.getElementById('collection-list-empty');
        const collectionListLoader = document.getElementById('collection-list-loader');
        const collectionsMainView = document.getElementById('collections-main-view');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalBody = document.getElementById('confirm-modal-body');
        const confirmModalCancel = document.getElementById('confirm-modal-cancel');
        const confirmModalOk = document.getElementById('confirm-modal-ok');
        const confirmModalTitle = document.getElementById('confirm-modal-title');
        const createCollectionForm = document.getElementById('create-collection-form');
        const favoritesEmpty = document.getElementById('favorites-empty');
        const favoritesGrid = document.getElementById('favorites-grid');
        const favoritesLoader = document.getElementById('favorites-loader');
        const feedbackButtonMobile = document.getElementById('feedback-button-mobile');
        const feedbackForm = document.getElementById('feedback-form');
        const feedbackMessage = document.getElementById('feedback-message');
        const feedbackModal = document.getElementById('feedback-modal');
        const feedbackStatus = document.getElementById('feedback-status');
        const gachaActions = document.getElementById('gacha-actions');
        const gachaAnimationContainer = document.getElementById('gacha-animation-container');
        const gachaApiNameSpan = document.getElementById('gacha-api-name');
        const gachaButton = document.getElementById('gacha-button');
        const gachaErrorMsg = document.getElementById('gacha-error');
        const gachaImageWrapper = document.getElementById('gacha-image-wrapper');
        const gachaPlaceholder = document.getElementById('gacha-placeholder');
        const gachaResetButton = document.getElementById('gacha-reset-button');
        const gachaResultContainer = document.getElementById('gacha-result-container');
        const gachaResultImage = document.getElementById('gacha-result-image');
        const galleryError = document.getElementById('gallery-error');
        const galleryGrid = document.getElementById('gallery-grid');
        const galleryLoader = document.getElementById('gallery-loader');
        const headerTitle = document.getElementById('header-title');
        const historyBrowseContent = document.getElementById('history-browse-content');
        const historyBrowseEmpty = document.getElementById('history-browse-empty');
        const historyBrowseGrid = document.getElementById('history-browse-grid');
        const historyBrowseLoader = document.getElementById('history-browse-loader');
        const historyGachaContent = document.getElementById('history-gacha-content');
        const historyGachaEmpty = document.getElementById('history-gacha-empty');
        const historyGachaGrid = document.getElementById('history-gacha-grid');
        const historyGachaLoader = document.getElementById('history-gacha-loader');
        const historyTabBrowse = document.getElementById('history-tab-browse');
        const historyTabGacha = document.getElementById('history-tab-gacha');
        const lightboxAddCollectionBtn = document.getElementById('lightbox-add-collection-btn');
        const lightboxArtist = document.getElementById('lightbox-artist');
        const lightboxFavoriteBtn = document.getElementById('lightbox-favorite-btn');
        const lightboxImage = document.getElementById('lightbox-image');
        const lightboxModal = document.getElementById('lightbox-modal');
        const lightboxSource = document.getElementById('lightbox-source');
        const loadMoreBtn = document.getElementById('load-more-btn');
        const loadMoreBtnText = document.getElementById('load-more-btn-text');
        const loadMoreContainer = document.getElementById('load-more-container');
        const loadMoreSpinner = document.getElementById('load-more-spinner');
        const loadMoreSpinnerText = document.getElementById('load-more-spinner-text');
        const mainContent = document.getElementById('main-content');
        const mainContentArea = document.getElementById('main-content-area');
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        const mobileNavLinksContainer = document.getElementById('mobile-nav-links');
        const mobileNavOverlay = document.getElementById('mobile-nav-overlay');
        const newCollectionNameInput = document.getElementById('new-collection-name');
        const pages = document.querySelectorAll('.page');
        const toastContainer = document.getElementById('toast-container');

        // --- Application State ---
        let historyBrowse = [];
        let historyGacha = [];
        let currentFavorites = [];
        let currentCollections = {};
        let currentApiId = 'nekos';
        let currentApiConf = API_CONFIG[currentApiId];
        let currentGalleryCategory = currentApiConf?.categories[0]?.endpoint || '';
        let isLoadingMore = false;
        let currentLightboxImageData = null;
        let pendingLightboxData = null;
        let isGachaRunning = false;
        let currentGachaResultData = null;
        let currentUser = null;
        let isInitialAuthCheckComplete = false;

        // --- Utility Functions ---
        function saveToLocalStorage(key, data) { try { localStorage.setItem(key, JSON.stringify(data)); } catch (e) { console.error("LS Save Error:", e); showToast("Aww~ Gagal simpan data lokalmu. Memorinya penuh ya?", "error"); } }
        function loadFromLocalStorage(key, defaultValue) { try { const data = localStorage.getItem(key); return data ? JSON.parse(data) : defaultValue; } catch (e) { console.error("LS Load Error:", e); localStorage.removeItem(key); return defaultValue; } }
        
        function saveState(stateKey, data) {
            const localStorageKeyMap = {
                favorites: 'nekonime_favorites_v9',
                collections: 'nekonime_collections_v9',
                historyBrowse: 'nekonime_history_browse_v9',
                historyGacha: 'nekonime_history_gacha_v9',
            };
            const localStorageKey = localStorageKeyMap[stateKey];
            if (localStorageKey) {
                saveToLocalStorage(localStorageKey, data);
            }
            if (currentUser) {
                saveDataToFirestore({ [stateKey]: data });
            }
        }

        function showLoader(el) { el?.classList.remove('hidden'); }
        function hideLoader(el) { el?.classList.add('hidden'); }
        function renderInfo(el, msg, makeVisible = true) { if (el) { el.innerHTML = msg; el.classList.toggle('hidden', !makeVisible); el.classList.toggle('visible', makeVisible); } }
        function hideInfo(el) { if (el) { el.classList.add('hidden'); el.classList.remove('visible'); el.innerHTML = ''; } }
        function escapeHTML(str) { if (!str) return ''; return str.toString().replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;'); }
        function showToast(message, type = 'info', duration = 3500) { if (!toastContainer) return; const toastId = `toast-${Date.now()}`; const toast = document.createElement('div'); toast.id = toastId; toast.className = `toast-item ${type}`; let icon = 'info'; let uwuPrefix = ''; if (type === 'success') { icon = 'check-circle'; uwuPrefix = 'Yatta! üéâ '; } else if (type === 'error') { icon = 'alert-circle'; uwuPrefix = 'Aduuh! Œ£(¬∞„É≠¬∞) '; } else { uwuPrefix = 'Pssst! ü§´ '; } toast.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5"></i><span>${uwuPrefix}${message}</span>`; toastContainer.appendChild(toast); lucide.createIcons({ nodes: [toast.querySelector('i')] }); requestAnimationFrame(() => { toast.classList.add('show'); }); setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => { toast.remove(); }, { once: true }); }, duration); }
        function showAlert(message, title = "Info Penting! ‚ú®") { alertModalTitle.innerHTML = title; alertModalBody.textContent = message; alertModal.classList.add('visible'); return new Promise(resolve => { alertModalOk.addEventListener('click', () => { alertModal.classList.remove('visible'); resolve(); }, { once: true }); }); }
        function showConfirm(message, title = "Konfirmasi Dulu Dong~ ü§î") { confirmModalTitle.innerHTML = title; confirmModalBody.textContent = message; confirmModal.classList.add('visible'); return new Promise((resolve) => { const okHandler = () => { confirmModal.classList.remove('visible'); resolve(true); }; const cancelHandler = () => { confirmModal.classList.remove('visible'); resolve(false); }; confirmModalOk.addEventListener('click', okHandler, { once: true }); confirmModalCancel.addEventListener('click', cancelHandler, { once: true }); }); }

        // --- Navigation & Page Handling ---
        function updateHeaderTitle(pageId) {
            const pageTitles = { gallery: "Galeri Moe~", "random-girl": "Gacha Universal ‚ô°", favorites: "Favorit Kesayangan üíñ", history: "History Petualanganmu üìú", collections: "Koleksi Pribadimu üìö", about: "Tentang NekoNime Uwu~", settings: "Setelan Manja ‚ú®", social: "Temu Kangen (Soon!)" };
            const title = pageTitles[pageId] || "NekoNime";
            const baseTitle = "NekoNime";
            const version = "v9.5.1";
            if (headerTitle) { const isGallery = pageId === 'gallery'; headerTitle.innerHTML = isGallery ? `<a href="#gallery">${baseTitle} <span class='text-sm align-super uwu-text'> uwu~</span></a>` : escapeHTML(title); }
            document.title = `${baseTitle} ${version} - ${title}`;
        }
        function showPage(pageId) {
            console.log(`Pindah ke halaman: ${pageId} ‚ô°`);
            if (pageId === 'social') { showToast("Fitur Sosialnya lagi dimasak nih, sabar yaa~ (oÀò‚ó°Àòo)", "info"); const currentHash = window.location.hash.substring(1); if (!['gallery', 'random-girl', 'favorites', 'history', 'collections', 'about', 'settings', ''].includes(currentHash)) { window.location.hash = '#gallery'; } return; }

            pages.forEach(page => page.classList.add('hidden'));
            const activePage = document.getElementById(`page-${pageId}`);
            const isGalleryPage = pageId === 'gallery';

            loadMoreContainer?.classList.toggle('hidden', !isGalleryPage);

            if (activePage) {
                activePage.classList.remove('hidden');
                mainContentArea.scrollTop = 0;

                if (isGalleryPage) {
                    currentApiConf = API_CONFIG[currentApiId];
                    if (!currentApiConf?.categories?.some(c => c.endpoint === currentGalleryCategory)) {
                        currentGalleryCategory = currentApiConf?.categories?.[0]?.endpoint || '';
                    }
                    renderCategorySelectors();
                    const needsReload = !galleryGrid.dataset.loadedCategory || galleryGrid.dataset.loadedCategory !== currentGalleryCategory || galleryGrid.children.length === 0;
                    if (needsReload) {
                        loadGallery(currentGalleryCategory, true);
                    } else {
                        loadMoreBtn.disabled = isLoadingMore;
                        loadMoreBtnText.textContent = "Muat Lebih Banyak Manisnya~";
                        loadMoreBtn.classList.toggle('loading', isLoadingMore);
                    }
                    loadMoreContainer?.classList.remove('hidden');
                }
                else if (pageId === 'history') { loadHistoryPage(); }
                else if (pageId === 'favorites') { loadFavorites(); }
                else if (pageId === 'collections') { loadCollectionsPage(); }
                else if (pageId === 'random-girl') { currentApiConf = API_CONFIG[currentApiId]; gachaApiNameSpan.textContent = currentApiConf?.name || 'Tidak Diketahui'; }
                else if (pageId === 'settings') { populateApiSelector(); }
            } else {
                console.warn(`Halaman ${pageId} nggak ketemu! Balik ke galeri ya~`);
                pageId = 'gallery'; window.location.hash = '#gallery';
                const galleryPage = document.getElementById('page-gallery');
                if (galleryPage) {
                    galleryPage.classList.remove('hidden');
                    loadMoreContainer?.classList.remove('hidden');
                    currentApiConf = API_CONFIG[currentApiId]; currentGalleryCategory = currentApiConf?.categories?.[0]?.endpoint || '';
                    renderCategorySelectors(); loadGallery(currentGalleryCategory, true);
                }
            }

            document.querySelectorAll('.nav-link').forEach(link => { link.classList.toggle('active', link.dataset.page === pageId); });
            updateHeaderTitle(pageId);
            closeMobileNav();
        }

        function reloadCurrentPageView() {
            const pageId = window.location.hash.substring(1) || 'gallery';
            console.log(`Reloading view for page: ${pageId}`);
            switch (pageId) {
                case 'gallery':
                    if (galleryGrid.children.length > 0) {
                        loadGallery(currentGalleryCategory, true);
                    }
                    break;
                case 'history':
                    loadHistoryPage();
                    break;
                case 'favorites':
                    loadFavorites();
                    break;
                case 'collections':
                    loadCollectionsPage();
                    break;
            }
            updateAllCollectionButtonsState();
            updateFavoriteStatusUI(null, false);
        }

        function handleHashChange() { const hash = window.location.hash.substring(1); const pageId = hash || 'gallery'; showPage(pageId); }
        function openMobileNav() { mobileNavOverlay?.classList.add('visible'); }
        function closeMobileNav() { mobileNavOverlay?.classList.remove('visible'); }

        // --- API Fetching ---
        async function fetchApiData(endpoint, count = 1) {
             currentApiConf = API_CONFIG[currentApiId];
             if (!currentApiConf) { return { data: [], errorCount: count, error: "Konfigurasi API-nya ilang nih T_T." }; }
             const safeEndpoint = endpoint || currentApiConf.defaultGachaCategory || API_CONFIG.nekos.defaultGachaCategory;
             const promises = [];
             for (let i = 0; i < count; i++) {
                 const url = `${currentApiConf.baseUrl}${safeEndpoint}`; const controller = new AbortController();
                 const timeoutId = setTimeout(() => controller.abort(), FETCH_TIMEOUT);
                 promises.push( fetch(url, { signal: controller.signal, cache: 'no-cache' }).then(async response => { clearTimeout(timeoutId); if (!response.ok) { return null; } const contentType = response.headers.get("content-type"); if (!contentType || !contentType.includes("application/json")) { return null; } return currentApiConf.parser(await response.json()); }).catch(error => { clearTimeout(timeoutId); return null; }) );
             }
             try { const results = await Promise.all(promises); const validResults = results.filter(r => r?.url); const errorCount = results.length - validResults.length; const uniqueResults = Array.from(new Map(validResults.map(item => [item.url, item])).values()); return { data: uniqueResults, errorCount: errorCount }; }
             catch (e) { return { data: [], errorCount: count, error: "Aww, gagal proses hasil API-nya." }; }
        }

        // --- Gallery Functions ---
        function renderCategorySelectors() { if (!categorySelectorContainer) return; categorySelectorContainer.innerHTML = ''; currentApiConf = API_CONFIG[currentApiId]; const displayCategories = currentApiConf?.categories; if (!displayCategories || displayCategories.length === 0) { categorySelectorContainer.innerHTML = '<p class="text-sm text-gray-500 uwu-text">Yah, kategori buat API ini nggak ada T_T</p>'; if (galleryGrid.children.length === 0) { renderInfo(galleryError, "Gagal muat kategori untuk API ini."); } loadMoreContainer?.classList.remove('hidden'); if(loadMoreBtn) { loadMoreBtn.disabled = true; loadMoreBtnText.textContent = "Error Kategori!"; } return; } if (!currentGalleryCategory || !displayCategories.some(c => c.endpoint === currentGalleryCategory)) { currentGalleryCategory = displayCategories[0]?.endpoint || ''; } displayCategories.forEach(cat => { if (!cat || !cat.endpoint || !cat.name) return; const btn = document.createElement('button'); btn.className = 'category-btn'; btn.dataset.endpoint = cat.endpoint; btn.textContent = cat.name; btn.classList.toggle('active', cat.endpoint === currentGalleryCategory); btn.addEventListener('click', () => { if (!isLoadingMore && currentGalleryCategory !== cat.endpoint) { currentGalleryCategory = cat.endpoint; document.querySelectorAll('#category-selector-container .category-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); loadGallery(currentGalleryCategory, true); } else if (isLoadingMore) { showToast("Sabar dong~ Lagi ngambil gambar nih...", "info"); } }); categorySelectorContainer.appendChild(btn); }); }
        function createImageCard(imageData, sourceContext = 'gallery') { const imageUrl = imageData.url; const artistName = imageData.artist_name || 'Artisnya Misterius~ ü§´'; const sourceUrl = imageData.source_url || imageUrl; const imageId = imageUrl; const isFavorite = isFavoriteCheck(imageUrl); const isInCollection = isImageInAnyCollection(imageUrl); const apiSource = imageData.apiSource || 'unknown'; const safeImageUrl = escapeHTML(imageUrl); const safeArtistName = escapeHTML(artistName); const safeSourceUrl = escapeHTML(sourceUrl); const safeApiSource = escapeHTML(apiSource); const dataForJson = { url: imageUrl, artist_name: artistName, source_url: sourceUrl, apiSource: apiSource }; const imageDataStringEscaped = escapeHTML(JSON.stringify(dataForJson)); const showRemoveButton = ['history_browse', 'history_gacha', 'favorites'].includes(sourceContext) || sourceContext.startsWith('collection_'); let removeButtonTitle = 'Hapus?'; if (sourceContext.startsWith('collection_')) removeButtonTitle = 'Keluarkan dari Koleksi Ini'; else if (sourceContext === 'favorites') removeButtonTitle = 'Hapus dari Favorit Kesayangan'; else if (sourceContext.startsWith('history_')) removeButtonTitle = 'Hapus dari Jejak History'; return `<div class="image-card group" data-url="${safeImageUrl}" data-artist="${escapeHTML(encodeURIComponent(artistName))}" data-source-url="${safeSourceUrl}" data-id="${imageId}" data-source-api="${safeApiSource}" title="Art oleh ${safeArtistName}. Klik buat intip!"><img src="${safeImageUrl}" alt="Ilustrasi anime oleh ${safeArtistName}" class="w-full h-auto object-cover block bg-black/20" loading="lazy" decoding="async" onerror="this.closest('.image-card')?.remove();"><div class="card-overlay"><button class="add-to-collection-card-btn card-button ${isInCollection ? 'in-collection' : ''}" title="${isInCollection ? 'Udah ada di Koleksi Lho!' : 'Tambah ke Koleksi Yuk!'}" onclick="event.stopPropagation(); window.handleAddToCollectionClick(this.dataset.image);" data-image='${imageDataStringEscaped}'><i data-lucide="${isInCollection ? 'folder-check' : 'plus-square'}"></i></button><button class="favorite-btn card-button ${isFavorite ? 'active' : ''}" data-image='${imageDataStringEscaped}' title="${isFavorite ? 'Batalin Favorit? (‚ï•_‚ï•)' : 'Jadikan Favorit! ‚ô°'}" onclick="event.stopPropagation(); window.toggleFavorite(this);"><i data-lucide="heart" class="${isFavorite ? 'fill-current' : ''}"></i></button></div>${showRemoveButton ? `<button class="remove-item-btn" data-id="${imageId}" data-source="${sourceContext}" title="${removeButtonTitle}" onclick="event.stopPropagation(); window.handleRemoveItem(this, '${sourceContext}');"><i data-lucide="x"></i></button>` : ''}</div>`; }
        async function loadGallery(categoryEndpoint, replace = false) {
            currentApiConf = API_CONFIG[currentApiId]; const displayCategories = currentApiConf?.categories;
            if (!displayCategories?.some(c => c.endpoint === categoryEndpoint)) { renderInfo(galleryError, `Aww, kategori <span class="uwu-text">${escapeHTML(categoryEndpoint)}</span> nggak ketemu di API ini.`); loadMoreContainer?.classList.remove('hidden'); if(loadMoreBtn) { loadMoreBtn.disabled = true; loadMoreBtnText.textContent = "Error kategori!"; } return; }
            if (isLoadingMore && !replace) { showToast("Sabar yaa~ Lagi ambil gambar nih...", "info"); return; }

            isLoadingMore = true; showLoader(galleryLoader); hideInfo(galleryError);
            loadMoreBtn.disabled = true; loadMoreBtn.classList.add('loading');

            if (replace) { galleryGrid.innerHTML = ''; galleryGrid.dataset.loadedCategory = categoryEndpoint; mainContentArea.scrollTop = 0; }

            try {
                const { data: images, errorCount, error: fetchError } = await fetchApiData(categoryEndpoint, GALLERY_IMAGES_PER_LOAD);
                if (fetchError) { throw new Error(fetchError); }
                if (errorCount > 0) { showToast(`Gagal muat ${errorCount} gambar. Mungkin coba lagi nanti?`, "error"); }
                if (images?.length > 0) {
                    let htmlFragment = ''; images.forEach(img => { if (img?.url) { htmlFragment += createImageCard(img, 'gallery'); addToHistory(img, 'browse'); } });
                    galleryGrid.insertAdjacentHTML('beforeend', htmlFragment);
                    lucide.createIcons({ nodes: galleryGrid.querySelectorAll('[data-lucide]') });
                } else {
                    if (!replace && galleryGrid.children.length > 0) { showToast("Nggak nemu gambar baru lagi nih, tapi boleh coba terus kok üòâ", "info"); }
                    else if (galleryGrid.children.length === 0) { renderInfo(galleryError, "Yah, nggak nemu gambar buat kategori ini... (¬¥„ÄÇÔºø„ÄÇÔΩÄ)"); }
                }
            } catch (error) {
                renderInfo(galleryError, `Waduh, ada error pas muat galeri: ${error.message}. Coba refresh atau ganti API yuk?`);
            } finally {
                isLoadingMore = false; hideLoader(galleryLoader);
                loadMoreBtn.classList.remove('loading');
                loadMoreContainer?.classList.remove('hidden');
                loadMoreBtn.disabled = false;
                loadMoreBtnText.textContent = "Muat Lebih Banyak Manisnya~";
            }
        }

        // --- History Functions ---
        function addToHistory(imageData, type = 'browse') {
            if (!imageData?.url) return;
            const item = { url: imageData.url, artist_name: imageData.artist_name || 'Artisnya Misterius~ ü§´', source_url: imageData.source_url || imageData.url, timestamp: Date.now(), apiSource: imageData.apiSource || 'unknown' };
            let history;
            if (type === 'gacha') {
                history = historyGacha;
            } else {
                history = historyBrowse;
            }
            history = history.filter(i => i?.url !== item.url);
            history.unshift(item);
            if (history.length > HISTORY_MAX_ITEMS) {
                history = history.slice(0, HISTORY_MAX_ITEMS);
            }
            if (type === 'gacha') {
                historyGacha = history;
                saveState('historyGacha', historyGacha);
            } else {
                historyBrowse = history;
                saveState('historyBrowse', historyBrowse);
            }
        }
        function loadItems(grid, loader, emptyElement, data, context) { if (!grid || !loader || !emptyElement) return; showLoader(loader); grid.innerHTML = ''; hideInfo(emptyElement); if (!data || data.length === 0) { const emptyMessage = emptyElement.dataset.emptyMessage || "Di sini kosong..."; renderInfo(emptyElement, emptyMessage); } else { let htmlFragment = ''; data.forEach(d => { if (d?.url) { htmlFragment += createImageCard(d, context); } }); grid.insertAdjacentHTML('beforeend', htmlFragment); lucide.createIcons({ nodes: grid.querySelectorAll('[data-lucide]') }); } hideLoader(loader); }
        function loadBrowseHistory() { loadItems(historyBrowseGrid, historyBrowseLoader, historyBrowseEmpty, historyBrowse, 'history_browse'); }
        function loadGachaHistory() { loadItems(historyGachaGrid, historyGachaLoader, historyGachaEmpty, historyGacha, 'history_gacha'); }
        function loadHistoryPage() {
            switchHistoryTab('browse');
            loadBrowseHistory();
            loadGachaHistory();
        }
        function switchHistoryTab(tab) { document.querySelectorAll('.history-tab-btn').forEach(b => b.classList.remove('active')); document.querySelectorAll('.history-content').forEach(c => c.classList.add('hidden')); if (tab === 'browse') { historyTabBrowse?.classList.add('active'); historyBrowseContent?.classList.remove('hidden'); } else if (tab === 'gacha') { historyTabGacha?.classList.add('active'); historyGachaContent?.classList.remove('hidden'); } mainContentArea.scrollTop = 0; }

        // --- Favorites Functions ---
        function loadFavorites() { loadItems(favoritesGrid, favoritesLoader, favoritesEmpty, currentFavorites, 'favorites'); }
        function toggleFavorite(button) { try { const dataStr = button.dataset.image; if (!dataStr) throw new Error("Data gambarnya nggak ketemu nih."); let data; try { data = JSON.parse(dataStr); } catch (e) { throw new Error(`Format datanya aneh: ${e.message}`); } if (!data?.url) throw new Error("URL gambarnya mana? o(T„ÉòTo)"); const isFav = isFavoriteCheck(data.url); toggleFavoriteDirect(data, !isFav); showToast(isFav ? 'Dihapus dari favorit kesayanganmu... (‚ï•_‚ï•)' : 'Yeaay! Jadi favoritmu sekarang! ‚ô°', 'success'); } catch (err) { showToast(`Aduh, gagal ganti status favorit: ${err.message}`, "error"); } }
        function isFavoriteCheck(url) { return currentFavorites.some(f => f?.url === url); }
        function updateFavoriteStatusUI(url, isFav) { const cardSelector = url ? `.image-card[data-id="${escapeHTML(url)}"] .favorite-btn` : '.favorite-btn'; const cards = mainContent.querySelectorAll(cardSelector); cards.forEach(btn => { const cardId = btn.closest('.image-card')?.dataset?.id; const shouldBeActive = (url !== null) ? (cardId === url ? isFav : isFavoriteCheck(cardId)) : isFavoriteCheck(cardId); updateSingleFavButtonUI(btn, shouldBeActive); }); if (lightboxModal.classList.contains('visible') && currentLightboxImageData) { const lightboxRelevant = url === null || currentLightboxImageData.url === url; if (lightboxRelevant) { const shouldBeActive = (url !== null) ? isFav : isFavoriteCheck(currentLightboxImageData.url); updateSingleFavButtonUI(lightboxFavoriteBtn, shouldBeActive); } } }
        function updateSingleFavButtonUI(btn, isFav) { if (!btn) return; const icon = btn.querySelector('i[data-lucide="heart"]'); const span = btn.querySelector('span'); if (isFav) { btn.classList.add('active'); icon?.classList.add('fill-current'); btn.title = 'Batalin Favorit? (‚ï•_‚ï•)'; if (span) span.textContent = 'Favorited ‚ô°'; } else { btn.classList.remove('active'); icon?.classList.remove('fill-current'); btn.title = 'Jadikan Favorit! ‚ô°'; if (span) span.textContent = 'Favorit'; } if (icon) lucide.createIcons({ nodes: [icon] }); }
        function toggleFavoriteLightbox() { if (!currentLightboxImageData) { showToast("Waduh, data gambarnya ilang nih.", "error"); return; } const isFav = isFavoriteCheck(currentLightboxImageData.url); toggleFavoriteDirect(currentLightboxImageData, !isFav); showToast(isFav ? 'Dihapus dari favorit... (‚ï•_‚ï•)' : 'Yeaay! Jadi favoritmu! ‚ô°', 'success'); }
        function toggleFavoriteDirect(data, makeFav) { const url = data.url; if (!url) return; if (makeFav) { if (!isFavoriteCheck(url)) { const item = { url: url, artist_name: data.artist_name || 'Artisnya Misterius~ ü§´', source_url: data.source_url || url, apiSource: data.apiSource || 'unknown' }; currentFavorites.unshift(item); } } else { currentFavorites = currentFavorites.filter(i => i?.url !== url); } 
        saveState('favorites', currentFavorites);
        updateFavoriteStatusUI(url, makeFav); if (window.location.hash === '#favorites' && !makeFav) { loadFavorites(); } }

        // --- Collections Functions ---
        function loadCollectionsPage() {
            showCollectionView('main');
            loadCollectionsList();
        }
        function saveCollections() { 
            saveState('collections', currentCollections);
        }
        function loadCollectionsList() { showLoader(collectionListLoader); collectionListContainer.innerHTML = ''; hideInfo(collectionListEmpty); const names = Object.keys(currentCollections); if (names.length === 0) { renderInfo(collectionListEmpty, collectionListEmpty.dataset.emptyMessage || "Kamu belum punya koleksi..."); } else { names.sort((a, b) => a.localeCompare(b)).forEach(name => { const count = currentCollections[name]?.length || 0; const li = document.createElement('div'); li.className = 'collection-list-item group'; const escapedName = escapeHTML(name); li.innerHTML = `<div class="collection-name-wrapper" onclick="window.showCollectionDetail('${escapedName}')" title="Lihat isi koleksi '${escapedName}'"><span class="collection-name font-medium group-hover:text-purple-300 transition-colors">${escapedName}</span></div><span class="collection-count ml-2">${count} item${count !== 1 ? 's' : ''}</span><button class="collection-delete-btn" data-name="${escapedName}" title="Hapus Koleksi '${escapedName}'? (Hati-hati!)"><i data-lucide="trash-2"></i></button>`; li.querySelector('.collection-delete-btn').addEventListener('click', (e) => { e.stopPropagation(); deleteCollection(name); }); collectionListContainer.appendChild(li); }); lucide.createIcons({ nodes: collectionListContainer.querySelectorAll('[data-lucide]') }); } hideLoader(collectionListLoader); }
        async function createCollection(name, dataToAdd = null) { const trimmed = name.trim(); if (!trimmed) { await showToast("Nama koleksinya nggak boleh kosong dong~", "error"); return { success: false, name: null }; } if (currentCollections[trimmed]) { await showToast(`Koleksi "${escapeHTML(trimmed)}" udah ada, <span class="uwu-text">Sayang</span>. Pilih nama lain ya~`, "error"); return { success: false, name: trimmed }; } currentCollections[trimmed] = []; let msg = `Koleksi baru "${escapeHTML(trimmed)}" berhasil dibuat! Yeay! üéâ`; if (dataToAdd && dataToAdd.url) { if (!currentCollections[trimmed].some(i => i.url === dataToAdd.url)) { currentCollections[trimmed].unshift({ url: dataToAdd.url, artist_name: dataToAdd.artist_name || 'Artisnya Misterius~ ü§´', source_url: dataToAdd.source_url || dataToAdd.url, apiSource: dataToAdd.apiSource || 'unknown' }); msg = `Koleksi "${escapeHTML(trimmed)}" dibuat & gambar <span class="uwu-text">manis</span> ini ditambah! ‚ô°`; } } saveCollections(); await showToast(msg, "success"); return { success: true, name: trimmed }; }
        async function deleteCollection(name) { const confirm = await showConfirm(`Yakin mau hapus koleksi "${escapeHTML(name)}"? Ini akan dihapus dari lokal dan cloud (jika login).`, "Hapus Koleksi?"); if (confirm) { delete currentCollections[name]; saveCollections(); loadCollectionsList(); updateAllCollectionButtonsState(); await showToast(`Koleksi "${escapeHTML(name)}" sudah dihapus... Bye bye~ üëã`, "info"); } }
        function showCollectionView(view) { collectionsMainView?.classList.toggle('hidden', view === 'detail'); collectionDetailView?.classList.toggle('hidden', view !== 'detail'); mainContentArea.scrollTop = 0; }
        function showCollectionDetail(name) { if (!currentCollections[name]) { showToast("Aww, koleksi itu nggak ketemu.", "error"); showCollectionView('main'); return; } showCollectionView('detail'); collectionDetailTitle.textContent = `Isi Koleksi: ${name}`; loadCollectionImages(name); }
        function loadCollectionImages(name) { const images = currentCollections[name] || []; loadItems(collectionImageGrid, collectionImageLoader, collectionImageEmpty, images, `collection_${name}`); }
        function isImageInAnyCollection(url) { if (!url) return false; return Object.values(currentCollections).some(coll => coll?.some(img => img?.url === url)); }
        function updateCollectionButtonStatus(url, isInColl) { if (!url) return; const cardBtns = mainContent.querySelectorAll(`.image-card[data-id="${escapeHTML(url)}"] .add-to-collection-card-btn`); cardBtns.forEach(btn => updateSingleCollectionButtonUI(btn, isInColl)); if (lightboxModal.classList.contains('visible') && currentLightboxImageData?.url === url) { updateSingleCollectionButtonUI(lightboxAddCollectionBtn, isInColl); } }
        function updateSingleCollectionButtonUI(btn, inColl) { if (!btn) return; const icon = btn.querySelector('i'); const span = btn.querySelector('span'); if (inColl) { btn.classList.add('in-collection'); btn.title = 'Udah ada di Koleksi Lho!'; if (icon) icon.dataset.lucide = 'folder-check'; if (span) span.textContent = 'Di Koleksi ‚úî'; } else { btn.classList.remove('in-collection'); btn.title = 'Tambah ke Koleksi Yuk!'; if (icon) icon.dataset.lucide = 'plus-square'; if (span) span.textContent = 'Tambah ke Koleksi'; } if (icon) lucide.createIcons({ nodes: [icon] }); }
        function updateAllCollectionButtonsState() { const allCardBtns = mainContent.querySelectorAll('.add-to-collection-card-btn'); allCardBtns.forEach(btn => { const card = btn.closest('.image-card'); if (card && card.dataset.id) { updateSingleCollectionButtonUI(btn, isImageInAnyCollection(card.dataset.id)); } else { updateSingleCollectionButtonUI(btn, false); } }); if (lightboxModal.classList.contains('visible') && currentLightboxImageData?.url) { updateSingleCollectionButtonUI(lightboxAddCollectionBtn, isImageInAnyCollection(currentLightboxImageData.url)); } }
        function handleAddToCollectionClick(dataInput) { try { let data; if (typeof dataInput === 'string') { try { data = JSON.parse(dataInput); } catch(e){ throw new Error(`Format datanya aneh nih: ${e.message}`); } } else if (typeof dataInput === 'object' && dataInput !== null && dataInput.url) { data = dataInput; } else { throw new Error("Data gambarnya invalid."); } if (!data || !data.url) throw new Error("URL gambarnya mana? („Å£ÀòÃ©‚ï≠‚ïÆÀòÃ©)„Å£"); pendingLightboxData = { ...data }; if (lightboxModal.classList.contains('visible') && currentLightboxImageData?.url === data.url) { closeLightbox(); setTimeout(() => { if (!pendingLightboxData) return; openAddToCollectionModalInternal(); }, 50); } else { openAddToCollectionModalInternal(); } } catch (err) { showToast(`Gagal buka opsi koleksi: ${err.message}`, "error"); pendingLightboxData = null; } }
        function openAddToCollectionModalInternal() { if (!pendingLightboxData || !pendingLightboxData.url) { showToast("Aww, data gambarnya keburu ilang.", "error"); return; } addToCollectionModalList.innerHTML = ''; hideInfo(addToCollectionEmpty); const names = Object.keys(currentCollections); const url = pendingLightboxData.url; if (names.length === 0) { renderInfo(addToCollectionEmpty, addToCollectionEmpty.dataset.emptyMessage || "Belum ada koleksi."); } else { addToCollectionEmpty.classList.add('hidden'); names.sort((a,b) => a.localeCompare(b)).forEach(name => { const exists = currentCollections[name]?.some(img => img.url === url); const btn = document.createElement('button'); btn.className = `add-to-collection-item ${exists ? 'exists' : ''}`; const escapedName = escapeHTML(name); btn.innerHTML = `<span class="truncate mr-2">${escapedName}</span> ${exists ? '<i data-lucide="check-circle" class="check-icon w-4 h-4 ml-auto flex-shrink-0 text-green-400"></i>' : ''}`; btn.title = exists ? `Gambar ini udah ada di koleksi '${escapedName}'!` : `Tambah ke koleksi '${escapedName}'`; btn.onclick = () => { if (!exists) { addImageToCollection(name); } else { showToast(`Udah ada di "${escapedName}" kok~ üòâ`, "info"); } }; addToCollectionModalList.appendChild(btn); }); lucide.createIcons({ nodes: addToCollectionModalList.querySelectorAll('[data-lucide]') }); } addNewCollectionNameInput.value = ''; addToCollectionModal.classList.add('visible'); }
        function closeAddToCollectionModal(reopenLightboxIfNeeded = true) { addToCollectionModal.classList.remove('visible'); const dataToReopen = pendingLightboxData; pendingLightboxData = null; if (reopenLightboxIfNeeded && dataToReopen) { reopenLightboxWithData(dataToReopen); } }
        function reopenLightboxWithData(data) { if (!data || !data.url) return; openLightbox(data); }
        async function addImageToCollection(name) { const data = pendingLightboxData; if (!data || !data.url || !name || !currentCollections[name]) { await showAlert("Gagal nambahin ke koleksi nih, datanya aneh.", "Error"); closeAddToCollectionModal(true); return; } if (currentCollections[name].some(i => i.url === data.url)) { await showToast(`Eh, udah ada di "${escapeHTML(name)}" ternyata! üòâ`, "info"); closeAddToCollectionModal(true); return; } currentCollections[name].unshift({ url: data.url, artist_name: data.artist_name || 'Artisnya Misterius~ ü§´', source_url: data.source_url || data.url, apiSource: data.apiSource || 'unknown' }); saveCollections(); updateCollectionButtonStatus(data.url, true); closeAddToCollectionModal(true); await showToast(`Berhasil ditambah ke koleksi "${escapeHTML(name)}"! Mantap! üëç`, "success"); if (!collectionDetailView.classList.contains('hidden') && collectionDetailTitle.textContent === `Isi Koleksi: ${name}`) { loadCollectionImages(name); } if (!collectionsMainView.classList.contains('hidden')) { loadCollectionsList(); } }
        async function handleAddCreateCollectionSubmit(event) { event.preventDefault(); const name = addNewCollectionNameInput.value; const data = pendingLightboxData; if (!data || !data.url) { showToast("Data gambarnya ilang pas mau bikin koleksi baru.", "error"); return; } const { success: created, name: createdName } = await createCollection(name, data); if (created && createdName) { updateCollectionButtonStatus(data.url, true); closeAddToCollectionModal(true); if (!collectionsMainView.classList.contains('hidden')) { loadCollectionsList(); } } else if (!created && createdName) { addNewCollectionNameInput.focus(); addNewCollectionNameInput.select(); } else { addNewCollectionNameInput.focus(); } }

        // --- Gacha Functions ---
        function resetGachaDisplay() { gachaImageWrapper.classList.add('hidden', 'opacity-0'); gachaResultImage.src = ""; gachaResultImage.onload = null; gachaResultImage.onerror = null; hideInfo(gachaErrorMsg); gachaPlaceholder.classList.remove('hidden'); gachaAnimationContainer.classList.remove('visible'); gachaAnimationContainer.innerHTML = ''; gachaResetButton.classList.add('hidden'); currentGachaResultData = null; }
        function triggerGachaAnimation() { gachaAnimationContainer.innerHTML = ''; for (let i = 0; i < 3; i++) { const card = document.createElement('div'); card.className = 'gacha-spinner-card'; card.style.animationDelay = `${i * GACHA_ANIMATION_STAGGER_DELAY}ms`; gachaAnimationContainer.appendChild(card); } gachaAnimationContainer.classList.add('visible'); }
        async function performGacha() {
            if (isGachaRunning) { showToast("Sabar dulu yaa~ Gachanya lagi muter nih!", "info"); return; }
            isGachaRunning = true; gachaButton.disabled = true; resetGachaDisplay();
            gachaPlaceholder.classList.add('hidden'); triggerGachaAnimation();
            currentApiConf = API_CONFIG[currentApiId];
            const availableEndpoints = currentApiConf?.allEndpoints || currentApiConf?.categories?.map(c => c.endpoint);
            if (!availableEndpoints || availableEndpoints.length === 0) {
                 renderInfo(gachaErrorMsg, `Waduh, nggak ada kategori buat Gacha di API ${currentApiConf?.name || 'ini'} T_T`, true);
                 gachaAnimationContainer.classList.remove('visible'); gachaAnimationContainer.innerHTML = '';
                 gachaPlaceholder.classList.remove('hidden'); gachaButton.disabled = false; isGachaRunning = false; return;
            }
            const randomEndpoint = availableEndpoints[Math.floor(Math.random() * availableEndpoints.length)];
            try {
                const { data: images, errorCount, error: fetchError } = await fetchApiData(randomEndpoint, 1);
                if (fetchError) throw new Error(fetchError);
                if (errorCount > 0 || images.length === 0 || !images[0]?.url) { throw new Error(`Gagal dapet gambar dari kategori acak <span class='uwu-text'>(${escapeHTML(randomEndpoint)})</span>. Coba lagi yuk?`); }
                const gachaData = images[0]; addToHistory(gachaData, 'gacha');
                const imgPreload = new Image();
                imgPreload.onload = () => {
                    gachaResultImage.src = gachaData.url; currentGachaResultData = gachaData;
                    setTimeout(() => {
                        gachaAnimationContainer.classList.remove('visible'); gachaAnimationContainer.innerHTML = '';
                        gachaImageWrapper.classList.remove('hidden');
                        requestAnimationFrame(() => gachaImageWrapper.classList.remove('opacity-0'));
                        gachaResetButton.classList.remove('hidden'); hideInfo(gachaErrorMsg);
                        showToast("Dapet ini! Semoga suka yaa~ ‚ô° Klik gambarnya buat lihat detail!", "success", 4500);
                        gachaButton.disabled = false; isGachaRunning = false;
                    }, 100);
                };
                imgPreload.onerror = () => { throw new Error("Yah, gambarnya gagal dimuat... (ÔΩ°‚Ä¢ÃÅÔ∏ø‚Ä¢ÃÄÔΩ°) Coba Gacha lagi?"); };
                imgPreload.src = gachaData.url;
            } catch (error) {
                gachaAnimationContainer.classList.remove('visible'); gachaAnimationContainer.innerHTML = '';
                renderInfo(gachaErrorMsg, error.message || "Aduuh, Gachanya lagi ngambek nih...", true);
                gachaImageWrapper.classList.add('hidden', 'opacity-0'); gachaPlaceholder.classList.remove('hidden');
                gachaButton.disabled = false; isGachaRunning = false;
            }
        }

        // --- Settings & Data Management ---
        async function clearData(dataType, typeName) { const confirm = await showConfirm(`Yakin mau hapus semua data ${typeName}? Jejakmu bakal hilang lho... (Lokal & Cloud)`, `Hapus ${typeName}?`); if (confirm) { switch (dataType) { case 'historyBrowse': historyBrowse = []; saveState('historyBrowse', []); loadBrowseHistory(); break; case 'historyGacha': historyGacha = []; saveState('historyGacha', []); loadGachaHistory(); break; case 'favorites': currentFavorites = []; saveState('favorites', []); updateFavoriteStatusUI(null, false); loadFavorites(); break; case 'collections': currentCollections = {}; saveState('collections', {}); updateAllCollectionButtonsState(); loadCollectionsList(); showCollectionView('main'); break; } await showToast(`Data ${typeName} sudah dihapus! Bersih~ ‚ú®`, "info"); } else { await showToast("Fiuhh~ Nggak jadi dihapus deh.", "info"); } }
        async function clearAllLocalData() { const confirm = await showConfirm("Serius nih mau HAPUS SEMUA data (History, Favorit, Koleksi)? Ini nggak bisa dibalikin lho! (Lokal & Cloud)", "Hapus Semua Data? (Super Hati-hati!)"); if (confirm) {  historyBrowse = []; historyGacha = []; currentFavorites = []; currentCollections = {}; saveState('historyBrowse', []); saveState('historyGacha', []); saveState('favorites', []); saveState('collections', {}); const page = window.location.hash.substring(1) || 'gallery'; if (page === 'history') loadHistoryPage(); else if (page === 'favorites') loadFavorites(); else if (page === 'collections') loadCollectionsPage(); updateFavoriteStatusUI(null, false); updateAllCollectionButtonsState(); await showToast("Semua datamu sudah dihapus bersih! Mulai dari nol lagi ya~ ( ¬¥ ‚ñΩ ` )Ôæâ", "success"); } else { await showToast("Oke, nggak jadi hapus semua. Legaaa~ (‚åí‚Äø‚åí)", "info"); } }
        function handleRemoveItem(button, context) { const id = button.dataset.id; if (!id) return; let wasInColl = isImageInAnyCollection(id); const card = button.closest('.image-card'); let message = ''; let refreshFunc = null; if (context === 'history_browse') { historyBrowse = historyBrowse.filter(i => i?.url !== id); saveState('historyBrowse', historyBrowse); message = 'Dihapus dari History Jelajah.'; if (historyBrowseGrid.children.length === 1 && card) refreshFunc = loadBrowseHistory; } else if (context === 'history_gacha') { historyGacha = historyGacha.filter(i => i?.url !== id); saveState('historyGacha', historyGacha); message = 'Dihapus dari History Gacha.'; if (historyGachaGrid.children.length === 1 && card) refreshFunc = loadGachaHistory; } else if (context === 'favorites') { toggleFavoriteDirect({ url: id }, false); message = 'Dihapus dari Favorit.'; if (favoritesGrid.children.length === 1 && card) refreshFunc = loadFavorites; } else if (context.startsWith('collection_')) { const name = context.split('_')[1]; if (currentCollections[name]) { currentCollections[name] = currentCollections[name].filter(i => i?.url !== id); saveCollections(); message = `Dihapus dari koleksi "${escapeHTML(name)}".`; if (!collectionDetailView.classList.contains('hidden') && collectionDetailTitle.textContent === `Isi Koleksi: ${name}`) { if (collectionImageGrid.children.length === 1 && card) refreshFunc = () => loadCollectionImages(name); } if (!collectionsMainView.classList.contains('hidden')) loadCollectionsList(); let stillInColl = isImageInAnyCollection(id); if (wasInColl && !stillInColl) updateCollectionButtonStatus(id, false); } } if (card) { card.style.transition = 'opacity 0.3s ease, transform 0.3s ease'; card.style.opacity = '0'; card.style.transform = 'scale(0.9)'; card.addEventListener('transitionend', () => { card.remove(); if (refreshFunc) setTimeout(refreshFunc, 30); }, { once: true }); } if (message && context !== 'favorites') { showToast(message, 'info'); } }

        // --- Lightbox & Modal Functions ---
        function openLightbox(cardOrData) { let data; if (typeof cardOrData === 'object' && cardOrData !== null && cardOrData.nodeType) { const card = cardOrData; const url = card.dataset.url; if (!url) { return; } data = { url: url, artist_name: decodeURIComponent(card.dataset.artist || 'Artisnya Misterius~ ü§´'), source_url: card.dataset.sourceUrl || url, apiSource: card.dataset.sourceApi || 'unknown' }; } else if (typeof cardOrData === 'object' && cardOrData !== null && cardOrData.url) { data = cardOrData; data.artist_name = data.artist_name || 'Artisnya Misterius~ ü§´'; data.source_url = data.source_url || data.url; data.apiSource = data.apiSource || 'unknown'; } else { return; } currentLightboxImageData = { ...data }; lightboxImage.src = ''; lightboxImage.alt = `Ilustrasi anime oleh ${escapeHTML(currentLightboxImageData.artist_name)}`; lightboxImage.src = currentLightboxImageData.url; lightboxArtist.textContent = currentLightboxImageData.artist_name; if (currentLightboxImageData.source_url && currentLightboxImageData.source_url !== '#' && currentLightboxImageData.source_url !== currentLightboxImageData.url) { lightboxSource.href = currentLightboxImageData.source_url; lightboxSource.style.display = 'inline-block'; } else { lightboxSource.style.display = 'none'; } updateSingleFavButtonUI(lightboxFavoriteBtn, isFavoriteCheck(currentLightboxImageData.url)); updateSingleCollectionButtonUI(lightboxAddCollectionBtn, isImageInAnyCollection(currentLightboxImageData.url)); lightboxModal.classList.add('visible'); }
        function closeLightbox() { lightboxModal.classList.remove('visible'); currentLightboxImageData = null; }
        function closeAlertModal() { alertModal.classList.remove('visible'); }
        function closeConfirmModal() { confirmModal.classList.remove('visible'); }

        // --- Feedback Functions ---
        function openFeedbackModal() { feedbackModal.classList.add('visible'); feedbackMessage.value = ''; feedbackStatus.textContent = ''; feedbackStatus.className = 'text-center text-sm mt-3'; closeMobileNav(); }
        function closeFeedbackModal() { feedbackModal.classList.remove('visible'); }
        function handleFeedbackSubmit(event) { event.preventDefault(); const msg = feedbackMessage.value.trim(); if (!msg) { showToast('Pesanmu masih kosong nih (¬¨_¬¨")', "error"); feedbackMessage.focus(); return; } feedbackStatus.textContent = 'Siap-siap buka email... üíå'; feedbackStatus.className = 'text-center text-sm mt-3 text-yellow-400'; const subject = `Masukan buat NekoNime ${document.title.split(' - ')[0].split(' ').pop()} Uwu~`; const body = `Haloo Developer NekoNime yang Kece! ‚ú®\n\nAku mau kasih masukan nih:\n\n${msg}\n\n----\nInfo Tambahan:\nAPI Aktif: ${currentApiConf?.name || 'N/A'}\nBrowser Agent: ${navigator.userAgent}\nTimestamp: ${new Date().toISOString()}\n`; const mailtoLink = `mailto:${FEEDBACK_EMAIL}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`; try { const mailWindow = window.open(mailtoLink, '_blank'); if (!mailWindow) { window.location.href = mailtoLink; } setTimeout(() => { feedbackStatus.textContent = 'Makasih banyak masukannya! Kamu terbaik! ‚ô°'; feedbackStatus.className = 'text-center text-sm mt-3 text-green-400'; feedbackMessage.value = ''; setTimeout(closeFeedbackModal, 3000); }, 500); } catch (e) { showAlert(`Gagal buka aplikasi email otomatis nih T_T. Kamu bisa kirim manual ke ${FEEDBACK_EMAIL} yaa~`, "Gagal Buka Email"); feedbackStatus.textContent = 'Aduh, gagal buka email...'; feedbackStatus.className = 'text-center text-sm mt-3 text-red-400'; } }

        // --- API Selector ---
        function populateApiSelector() { if (!apiSelector) return; const savedValue = apiSelector.value; apiSelector.innerHTML = ''; Object.keys(API_CONFIG).forEach(key => { const opt = document.createElement('option'); opt.value = key; opt.textContent = API_CONFIG[key].name; if (key === savedValue || (!savedValue && key === currentApiId)) { opt.selected = true; } apiSelector.appendChild(opt); }); currentApiId = apiSelector.value; currentApiConf = API_CONFIG[currentApiId]; }
        function handleApiChange(event) { const newId = event.target.value; if (newId !== currentApiId && API_CONFIG[newId]) { currentApiId = newId; currentApiConf = API_CONFIG[newId]; currentGalleryCategory = currentApiConf?.categories?.[0]?.endpoint || ''; saveToLocalStorage('nekonime_api_v9', currentApiId); showToast(`Oke! Ganti API ke ${currentApiConf.name}. Muat ulang galeri yaa~ ‚ú®`, 'info'); if (window.location.hash !== '#gallery') { window.location.hash = '#gallery'; } else { showPage('gallery'); } if (gachaApiNameSpan) gachaApiNameSpan.textContent = currentApiConf?.name || 'Tidak Diketahui'; } }

        // --- Authentication and Cloud Sync Functions ---
        async function loginWithGoogle() { const provider = new GoogleAuthProvider(); try { await signInWithPopup(auth, provider); closeMobileNav(); } catch (error) { showToast(`Waduh, login gagal: ${error.code}`, 'error'); } }
        async function logout() { try { await signOut(auth); closeMobileNav(); } catch (error) { showToast(`Gagal logout: ${error.message}`, 'error'); } }

        function updateAuthUI(user) {
            const loggedOutHTML = `<button id="login-btn" class="nav-link login-btn"><i data-lucide="log-in"></i> Login</button>`;
            const loggedOutMobileHTML = `<button id="mobile-login-btn" class="nav-link login-btn"><i data-lucide="log-in"></i> Login dengan Google</button>`;
            if (user) {
                const loggedInHTML = `<div class="user-profile"><img src="${escapeHTML(user.photoURL || '')}" alt="${escapeHTML(user.displayName || 'User')}"><span class="text-white">${escapeHTML(user.displayName.split(' ')[0] || 'User')}</span></div><button id="logout-btn" class="nav-link" title="Logout"><i data-lucide="log-out"></i></button>`;
                const loggedInMobileHTML = `<div id="mobile-user-profile"><img src="${escapeHTML(user.photoURL || '')}" alt="${escapeHTML(user.displayName || 'User')}"><span>Halo, ${escapeHTML(user.displayName || 'User')}!</span></div><button id="mobile-logout-btn" class="nav-link mobile-logout-btn"><i data-lucide="log-out"></i> Logout</button>`;
                authContainerDesktop.innerHTML = loggedInHTML; authContainerMobile.innerHTML = loggedInMobileHTML;
                document.getElementById('logout-btn')?.addEventListener('click', logout);
                document.getElementById('mobile-logout-btn')?.addEventListener('click', logout);
            } else {
                authContainerDesktop.innerHTML = loggedOutHTML; authContainerMobile.innerHTML = loggedOutMobileHTML;
                document.getElementById('login-btn')?.addEventListener('click', loginWithGoogle);
                document.getElementById('mobile-login-btn')?.addEventListener('click', loginWithGoogle);
            }
            lucide.createIcons();
        }

        async function saveDataToFirestore(data) {
            if (!currentUser) return;
            try {
                const userDocRef = doc(db, 'users', currentUser.uid);
                await setDoc(userDocRef, data, { merge: true });
            } catch (error) {
                console.error("Firestore Save Error:", error);
                showToast('Gagal simpan data ke cloud. (ÔΩ°‚Ä¢ÃÅÔ∏ø‚Ä¢ÃÄÔΩ°)', 'error');
            }
        }
        async function loadDataFromFirestore(uid) {
            const userDocRef = doc(db, 'users', uid);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    const cloudData = docSnap.data();
                    currentFavorites = cloudData.favorites || [];
                    currentCollections = cloudData.collections || {};
                    historyBrowse = cloudData.historyBrowse || [];
                    historyGacha = cloudData.historyGacha || [];
                    showToast('Data dari cloud berhasil dimuat! ‚ú®', 'success');
                } else {
                    showToast('Selamat datang! Menyimpan data lokalmu ke cloud...', 'info');
                    await saveDataToFirestore({
                        favorites: currentFavorites, collections: currentCollections,
                        historyBrowse: historyBrowse, historyGacha: historyGacha,
                        createdAt: new Date().toISOString()
                    });
                }
            } catch (error) {
                console.error("Firestore Load Error:", error);
                showToast('Gagal ambil data dari cloud. ( T –¥ T )', 'error');
            }
        }
        
        function loadAllDataFromLocal() {
            historyBrowse = loadFromLocalStorage('nekonime_history_browse_v9', []);
            historyGacha = loadFromLocalStorage('nekonime_history_gacha_v9', []);
            currentFavorites = loadFromLocalStorage('nekonime_favorites_v9', []);
            currentCollections = loadFromLocalStorage('nekonime_collections_v9', {});
        }

        // --- Main App Initialization ---

        // FIX: Reworked initialization flow to prevent login/logout bug.
        // The app now waits for the first auth state check before rendering.
        onAuthStateChanged(auth, async (user) => {
            if (!isInitialAuthCheckComplete) {
                // This block runs only ONCE on initial page load.
                if (user) {
                    currentUser = user;
                    await loadDataFromFirestore(user.uid);
                } else {
                    currentUser = null;
                    loadAllDataFromLocal();
                }
                
                initializeAppUI(); // Initialize the rest of the app
                isInitialAuthCheckComplete = true;

            } else {
                // This block handles subsequent logins and logouts while the user is on the site.
                if (user) {
                    if (!currentUser || currentUser.uid !== user.uid) {
                        currentUser = user;
                        updateAuthUI(user);
                        showToast(`Halo lagi, ${user.displayName}! ‚ô° Sinkronisasi data...`, 'success');
                        await loadDataFromFirestore(user.uid);
                        reloadCurrentPageView();
                    }
                } else {
                    if (currentUser) {
                        showToast('Kamu sudah logout. Data sekarang disimpan lokal ya.', 'info');
                        currentUser = null;
                        updateAuthUI(null);
                        loadAllDataFromLocal();
                        reloadCurrentPageView();
                    }
                }
            }
        });
        
        function initializeAppUI() {
            console.log("NekoNime v9.5.1 Berangkat! Login & Cloud Save Fix! Nyaa~ („Å•ÔΩ°‚óï‚Äø‚Äø‚óïÔΩ°)„Å•");

            // Setup UI based on initial data (cloud or local)
            updateAuthUI(currentUser);
            currentApiId = loadFromLocalStorage('nekonime_api_v9', 'nekos');
            currentApiConf = API_CONFIG[currentApiId];
            currentGalleryCategory = currentApiConf?.categories[0]?.endpoint || '';
            populateApiSelector();

            // Setup all event listeners
            setupEventListeners();
            
            // Render the initial page based on hash
            handleHashChange();

            // Make the app visible
            initialLoader.classList.add('hidden');
            appContainer.style.visibility = 'visible';
        }

        function setupEventListeners() {
            window.addEventListener('hashchange', handleHashChange);
            mainContent.addEventListener('click', (e) => { const card = e.target.closest('.image-card'); const isButton = e.target.closest('button.card-button, button.remove-item-btn'); if (card && !isButton) { openLightbox(card); } });
            window.addEventListener('keydown', (e) => { if (e.key === 'Escape') { if (addToCollectionModal.classList.contains('visible')) closeAddToCollectionModal(true); else if (lightboxModal.classList.contains('visible')) closeLightbox(); else if (alertModal.classList.contains('visible')) closeAlertModal(); else if (confirmModal.classList.contains('visible')) closeConfirmModal(); else if (feedbackModal.classList.contains('visible')) closeFeedbackModal(); else if (mobileNavOverlay.classList.contains('visible')) closeMobileNav(); } });
            
            loadMoreBtn?.addEventListener('click', () => { if (!isLoadingMore) { loadGallery(currentGalleryCategory, false); } else { showToast("Sabar sebentar yaa, lagi proses nih~", "info"); } });
            gachaButton?.addEventListener('click', performGacha);
            gachaResetButton?.addEventListener('click', resetGachaDisplay);
            gachaImageWrapper?.addEventListener('click', () => { if (currentGachaResultData) { openLightbox(currentGachaResultData); } else { showToast("Hmm, data gambarnya nggak ketemu buat dibuka.", "info"); } });
            mobileMenuToggle?.addEventListener('click', openMobileNav);
            closeMobileNavBtn?.addEventListener('click', closeMobileNav);
            mobileNavLinksContainer?.addEventListener('click', (e) => { const link = e.target.closest('a.nav-link'); const fbBtn = e.target.closest('#feedback-button-mobile'); if (link && !link.classList.contains('disabled')) { closeMobileNav(); } else if (fbBtn) { openFeedbackModal(); } else if (link?.classList.contains('disabled')) { e.preventDefault(); showToast("Fitur ini belum siap nih, <span class='uwu-text'>sabar yaa~ (oÀò‚ó°Àòo)</span>", "info"); closeMobileNav(); } });
            closeFeedbackModalButton?.addEventListener('click', closeFeedbackModal);
            feedbackForm?.addEventListener('submit', handleFeedbackSubmit);
            historyTabBrowse?.addEventListener('click', () => switchHistoryTab('browse'));
            historyTabGacha?.addEventListener('click', () => switchHistoryTab('gacha'));
            createCollectionForm?.addEventListener('submit', (e) => { e.preventDefault(); const name = newCollectionNameInput.value; createCollection(name).then(({success}) => { if (success) { newCollectionNameInput.value = ''; loadCollectionsList(); } else { newCollectionNameInput.focus(); newCollectionNameInput.select(); } }); });
            backToCollectionsBtn?.addEventListener('click', () => showCollectionView('main'));
            closeAddToCollectionModalBtn?.addEventListener('click', () => closeAddToCollectionModal(true));
            addToCollectionModal?.addEventListener('click', (e) => { if (e.target === addToCollectionModal) { closeAddToCollectionModal(true); } });
            addCreateCollectionForm?.addEventListener('submit', handleAddCreateCollectionSubmit);
            apiSelector?.addEventListener('change', handleApiChange);
            clearHistoryBrowseBtn?.addEventListener('click', () => clearData('historyBrowse', 'History Jelajah'));
            clearHistoryGachaBtn?.addEventListener('click', () => clearData('historyGacha', 'History Gacha'));
            clearFavoritesBtn?.addEventListener('click', () => clearData('favorites', 'Favorit'));
            clearCollectionsBtn?.addEventListener('click', () => clearData('collections', 'Koleksi'));
            clearAllDataBtn?.addEventListener('click', clearAllLocalData);
            document.querySelectorAll('a.nav-link.disabled').forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); showToast("Fitur ini belum siap nih, <span class='uwu-text'>sabar yaa~ (oÀò‚ó°Àòo)</span>", "info"); }); });
            alertModalOk?.addEventListener('click', closeAlertModal);
            confirmModalCancel?.addEventListener('click', closeConfirmModal);
            lightboxFavoriteBtn?.addEventListener('click', toggleFavoriteLightbox);
            lightboxAddCollectionBtn?.addEventListener('click', () => { if(currentLightboxImageData) { handleAddToCollectionClick(currentLightboxImageData); } else { showToast("Waduh, data gambarnya ilang pas mau ditambah ke koleksi.", "error"); } });
        }
        
        // FIX: Expose necessary functions to the global window object
        // This allows them to be called from inline `onclick` attributes in the HTML.
        window.closeLightbox = closeLightbox;
        window.closeAlertModal = closeAlertModal;
        window.closeConfirmModal = closeConfirmModal;
        window.toggleFavorite = toggleFavorite;
        window.handleAddToCollectionClick = handleAddToCollectionClick;
        window.handleRemoveItem = handleRemoveItem;
        window.showCollectionDetail = showCollectionDetail;

    </script>

</body>
</html>
